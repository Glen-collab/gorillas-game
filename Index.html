<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RETRO ARCADE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a12;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'VT323',monospace;color:#aaa;overflow:hidden}
#gameContainer{position:relative;border:3px solid #222;box-shadow:0 0 60px rgba(0,0,0,0.8);border-radius:4px;background:#000}
canvas{display:block;image-rendering:pixelated;image-rendering:crisp-edges}
#scoreboard{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:5px 12px;font-size:10px;color:#fff;background:rgba(0,0,0,0.75);border-bottom:1px solid #333;pointer-events:none;z-index:2;letter-spacing:1px}
#scoreboard.gorillas-mode{font-family:'Press Start 2P',monospace;font-size:9px}
#scoreboard.gorillas-mode .score-p1{color:#ff6}
#scoreboard.gorillas-mode .score-p2{color:#f66}
#scoreboard.sw-mode{font-family:'Orbitron',sans-serif}
#scoreboard.sw-mode .score-p1{color:#8cf}
#scoreboard.sw-mode .score-p2{color:#f88}
#scoreboard.topgun-mode{font-family:'Press Start 2P',monospace;font-size:9px;background:rgba(100,120,60,0.92);border-bottom-color:#6b7f4a}
#scoreboard.topgun-mode .score-p1{color:#2a3518}
#scoreboard.topgun-mode .score-p2{color:#2a3518}
#scoreboard.topgun-mode .score-title{color:#2a3518}
#scoreboard.topgun-mode .sub-label{color:#4a5a30}
.score-title{font-weight:700;font-size:11px}
.sub-label{color:#888;font-size:9px}
#scoreboard.hidden{display:none}
#input-panel{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:10px;align-items:center;background:rgba(0,0,0,0.88);border:1px solid #555;border-radius:2px;padding:6px 14px;font-family:'VT323',monospace;font-size:18px;color:#fff;z-index:10}
#input-panel.hidden{display:none}
#input-panel label{color:#999;font-size:16px}
#input-panel input{width:55px;background:#111;border:1px solid #444;color:#fff;font-family:'VT323',monospace;font-size:18px;padding:2px 4px;text-align:center;border-radius:2px}
#input-panel input:focus{outline:1px solid #88f;border-color:#88f}
#input-panel button{background:#333;border:1px solid #88f;color:#aaf;font-family:'VT323',monospace;font-size:18px;padding:4px 14px;cursor:pointer;border-radius:2px}
#input-panel button:hover{background:#444}
.turn-indicator{font-size:14px;font-weight:700;animation:blink 1.2s step-end infinite}
@keyframes blink{50%{opacity:0.3}}
#message{position:absolute;top:2%;left:50%;transform:translateX(-50%);text-align:center;line-height:2.2;background:rgba(0,0,0,0.9);padding:28px 40px;border:1px solid #333;border-radius:4px;z-index:20;max-width:92%;max-height:96%;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;overscroll-behavior:contain}
#message.hidden{display:none}
#message button{display:inline-block;margin:6px 4px 0;background:#222;border:1px solid #555;color:#ddd;font-family:'Press Start 2P',monospace;font-size:9px;padding:10px 18px;cursor:pointer;border-radius:2px;transition:all 0.15s}
#message button:hover{background:#333;border-color:#aaa;color:#fff}
.arcade-title{font-family:'Press Start 2P',monospace;font-size:24px;color:#ff0;text-shadow:0 0 30px rgba(255,255,0,0.3),3px 3px 0 #880;letter-spacing:3px}
.arcade-sub{font-family:'VT323',monospace;font-size:18px;color:#888;letter-spacing:2px}
.game-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:380px;margin:8px auto}
.game-card{display:inline-block;padding:14px 16px;background:rgba(20,20,40,0.9);border:2px solid #444;border-radius:4px;cursor:pointer;transition:all 0.2s;text-align:center;min-width:140px;vertical-align:top}
.game-card:hover{border-color:#ff0;background:rgba(40,40,80,0.9);transform:scale(1.03);box-shadow:0 0 20px rgba(255,255,0,0.15)}
.game-card .card-icon{font-size:32px;display:block;margin-bottom:4px}
.game-card .card-title{font-family:'Press Start 2P',monospace;font-size:9px;color:#fff;display:block;margin-bottom:3px}
.game-card .card-desc{font-family:'VT323',monospace;font-size:14px;color:#888;display:block}
.game-card.coming-soon{opacity:0.4;cursor:default;border-style:dashed}
.game-card.coming-soon:hover{border-color:#444;background:rgba(20,20,40,0.9);transform:none;box-shadow:none}
#exitBtn{position:absolute;top:28px;right:8px;background:rgba(0,0,0,0.7);border:1px solid #555;color:#999;font-family:'VT323',monospace;font-size:14px;padding:3px 10px;cursor:pointer;border-radius:2px;z-index:15;transition:all 0.15s}
#exitBtn:hover{border-color:#f44;color:#f44;background:rgba(40,0,0,0.8)}
#exitBtn.hidden{display:none}
.sw-btn{font-family:'Orbitron',sans-serif!important;font-size:10px!important;color:#FFE81F!important;border-color:#FFE81F!important;font-weight:700;letter-spacing:1px}
.sw-btn:hover{color:#fff!important}
.planet-btn{min-width:100px}
.tg-btn{font-family:'Press Start 2P',monospace!important;font-size:8px!important;color:#8b9f5a!important;border-color:#8b9f5a!important}
.tg-btn:hover{color:#bbd07a!important}
#scoreboard.startrek-mode{font-family:'Orbitron',sans-serif;background:rgba(0,10,30,0.85);border-bottom-color:#4488cc}
#scoreboard.startrek-mode .score-p1{color:#8cf}
#scoreboard.startrek-mode .score-p2{color:#8cf}
#scoreboard.startrek-mode .score-title{color:#8cf}
#scoreboard.startrek-mode .sub-label{color:#6aa}
#scoreboard.trenchrun-mode{font-family:'Orbitron',sans-serif;background:rgba(10,10,0,0.85);border-bottom-color:#FFE81F}
#scoreboard.trenchrun-mode .score-p1{color:#FFE81F}
#scoreboard.trenchrun-mode .score-p2{color:#FFE81F}
#scoreboard.trenchrun-mode .score-title{color:#FFE81F}
#scoreboard.trenchrun-mode .sub-label{color:#8be}
.st-btn{font-family:'Orbitron',sans-serif!important;font-size:10px!important;color:#8cf!important;border-color:#8cf!important;font-weight:700;letter-spacing:1px}
.st-btn:hover{color:#fff!important}
.tr-btn{font-family:'Orbitron',sans-serif!important;font-size:10px!important;color:#FFE81F!important;border-color:#FFE81F!important;font-weight:700;letter-spacing:1px}
.tr-btn:hover{color:#fff!important}
#scoreboard.guerrilla-mode{font-family:'Press Start 2P',monospace;font-size:9px;background:rgba(20,15,5,0.90);border-bottom-color:#8a6a3a}
#scoreboard.guerrilla-mode .score-p1{color:#e8d8a0}
#scoreboard.guerrilla-mode .score-p2{color:#8a4}
#scoreboard.guerrilla-mode .score-title{color:#c84}
#scoreboard.guerrilla-mode .sub-label{color:#8a6a3a}
.gw-btn{font-family:'Press Start 2P',monospace!important;font-size:8px!important;color:#e8d8a0!important;border-color:#8a6a3a!important}
.gw-btn:hover{color:#ffa040!important}
.game-grid{grid-template-columns:1fr 1fr 1fr;max-width:540px}
@media(max-height:500px),(max-width:480px){#message{padding:14px 16px;line-height:1.8}.arcade-title{font-size:16px}.game-grid{grid-template-columns:1fr 1fr;max-width:320px;gap:6px}.game-card{padding:8px 10px;min-width:0}.game-card .card-icon{font-size:22px}.game-card .card-title{font-size:7px}.game-card .card-desc{font-size:12px}}
</style>
</head>
<body>
<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>
  <div id="scoreboard" class="hidden">
    <span class="score-p1"><span id="p1Label">P1</span>: <span id="score1">0</span></span>
    <span><span class="score-title" id="gameTitle">GORILLAS</span><br><span class="sub-label" id="subLabel"></span></span>
    <span class="score-p2"><span id="p2Label">P2</span>: <span id="score2">0</span></span>
  </div>
  <div id="input-panel" class="hidden">
    <span id="turnLabel" class="turn-indicator">P1</span>
    <label>Angle:</label><input type="number" id="angleInput" min="0" max="90" value="60">
    <label>Power:</label><input type="number" id="powerInput" min="1" max="200" value="70">
    <button id="fireBtn">THROW!</button>
  </div>
  <div id="message" class="hidden"></div>
  <button id="exitBtn" class="hidden" onclick="showArcadeMenu()">&#10005; EXIT</button>
</div>
<script>
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d'),W=800,H=500;
canvas.width=W;canvas.height=H;
function resizeCanvas(){const s=Math.min((window.innerWidth-10)/W,(window.innerHeight-10)/H,1.5);canvas.style.width=(W*s)+'px';canvas.style.height=(H*s)+'px';const gc=document.getElementById('gameContainer');gc.style.width=(W*s)+'px';gc.style.height=(H*s)+'px';}
resizeCanvas();window.addEventListener('resize',resizeCanvas);

let activeGame=null,buildings=[],scores=[0,0],currentPlayer=0,projectile=null;
let explosions=[],particles=[],envParticles=[],gamePhase='arcade',wind=0,terrainCanvas,terrainCtx;
const $=id=>document.getElementById(id);
function showEl(id){$(id).classList.remove('hidden')}
function hideEl(id){$(id).classList.add('hidden')}
function showMsg(h){$('message').innerHTML=h;showEl('message')}
function hideMsg(){hideEl('message')}

// ==================== GORILLAS ====================
const GorillasGame={
  g:[{x:0,y:0},{x:0,y:0}],sunSt:'normal',sunT:0,
  init(){activeGame='gorillas';hideMsg();showEl('exitBtn');canvas.style.cursor='default';
    $('scoreboard').className='gorillas-mode';
    $('p1Label').textContent='P1';$('p2Label').textContent='P2';
    $('gameTitle').textContent='G O R I L L A S';$('gameTitle').style.color='#ff0';
    $('subLabel').textContent='QBasic Classic';
    $('fireBtn').textContent='THROW!';$('fireBtn').className='';
    $('score1').textContent='0';$('score2').textContent='0';
    $('input-panel').style.borderColor='#44f';$('input-panel').style.background='rgba(0,0,80,0.85)';
    $('fireBtn').style.borderColor='#44f';$('fireBtn').style.color='#aaf';
    scores=[0,0];currentPlayer=0;this.newRound();},
  newRound(){this.genB();this.placeG();this.initT();wind=(Math.random()-0.5)*30;
    projectile=null;explosions=[];particles=[];envParticles=[];this.sunSt='normal';this.sunT=0;
    gamePhase='input';this.showIn();},
  genB(){buildings=[];let x=0;while(x<W+75){const bw=40+Math.random()*35,bh=80+Math.random()*220;
    buildings.push({x:Math.floor(x),w:Math.floor(bw),h:Math.floor(bh),color:['#aa0000','#00aa00','#0000aa','#aa5500','#555555','#00aaaa'][Math.floor(Math.random()*6)]});x+=bw;}},
  placeG(){const bi1=Math.floor(buildings.length*0.15)+Math.floor(Math.random()*2);
    const b1=buildings[Math.min(bi1,buildings.length-1)];this.g[0]={x:b1.x+b1.w/2,y:H-b1.h-30};
    const bi2=Math.floor(buildings.length*0.8)+Math.floor(Math.random()*2);
    const b2=buildings[Math.min(bi2,buildings.length-1)];this.g[1]={x:b2.x+b2.w/2,y:H-b2.h-30};},
  initT(){terrainCanvas=document.createElement('canvas');terrainCanvas.width=W;terrainCanvas.height=H;
    terrainCtx=terrainCanvas.getContext('2d');terrainCtx.clearRect(0,0,W,H);
    for(const b of buildings){terrainCtx.fillStyle=b.color;terrainCtx.fillRect(b.x,H-b.h,b.w,b.h);
      for(let wy=H-b.h+12;wy<H-10;wy+=13)for(let wx=b.x+6;wx<b.x+b.w-8;wx+=13){
        terrainCtx.fillStyle=Math.random()>0.35?'#ffff55':'#333333';terrainCtx.fillRect(wx,wy,5,5);}}},
  showIn(){showEl('input-panel');showEl('scoreboard');
    $('turnLabel').textContent='PLAYER '+(currentPlayer+1)+' \u25B8';
    $('turnLabel').style.color=currentPlayer===0?'#ff6':'#f66';
    $('angleInput').value='60';$('powerInput').value='70';$('angleInput').focus();},
  fire(angle,power){hideEl('input-panel');const g=this.g[currentPlayer],dir=currentPlayer===0?1:-1;
    const rad=(angle*Math.PI)/180,speed=power*0.6,sd=30;
    projectile={x:g.x+dir*sd,y:g.y-20,vx:Math.cos(rad)*speed*dir,vy:-Math.sin(rad)*speed,
      rot:0,alive:true,sx:g.x+dir*sd,sy:g.y-20};gamePhase='flight';},
  checkCol(x,y){if(x<-20||x>W+20||y>H)return'miss';if(y<0)return'none';
    for(let i=0;i<2;i++){const g=this.g[i];if(x>g.x-14&&x<g.x+14&&y>g.y-14&&y<g.y+24)return i===currentPlayer?'self':'hit';}
    const sdx=x-W/2,sdy=y-42;if(Math.sqrt(sdx*sdx+sdy*sdy)<22){this.sunSt='surprised';this.sunT=60;}
    if(y>=0&&y<H&&x>=0&&x<W&&terrainCtx.getImageData(Math.floor(x),Math.floor(y),1,1).data[3]>0)return'building';
    return'none';},
  updateP(dt){if(!projectile||!projectile.alive)return;
    projectile.vx+=wind*0.08*dt;projectile.vy+=14.7*dt;projectile.x+=projectile.vx*dt;projectile.y+=projectile.vy*dt;projectile.rot+=0.15;
    const dx=projectile.x-projectile.sx,dy=projectile.y-projectile.sy;if(Math.sqrt(dx*dx+dy*dy)<60)return;
    const c=this.checkCol(projectile.x,projectile.y);
    if(c==='hit'||c==='self')this.result(c);
    else if(c==='building'){createExplosion(projectile.x,projectile.y,22);destroyTerrain(projectile.x,projectile.y,22);
      this.sunSt='surprised';this.sunT=40;projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},800);}
    else if(c==='miss'){projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},400);}},
  result(type){if(type==='hit')scores[currentPlayer]++;else scores[1-currentPlayer]++;
    $('score1').textContent=scores[0];$('score2').textContent=scores[1];
    createExplosion(projectile.x,projectile.y,35);destroyTerrain(projectile.x,projectile.y,35);
    projectile.alive=false;gamePhase='hit';this.sunSt='surprised';
    setTimeout(()=>{const msg=type==='hit'
      ?'<span style="color:'+(currentPlayer===0?'#ff6':'#f66')+';font-family:Press Start 2P,monospace;font-size:14px">PLAYER '+(currentPlayer+1)+' WINS!</span>'
      :'<span style="color:#f00;font-family:Press Start 2P,monospace;font-size:12px">PLAYER '+(currentPlayer+1)+' HIT THEMSELVES!</span>';
      showMsg(msg+'<br><span style="font-family:VT323;font-size:20px;color:#aaa">Score: '+scores[0]+' - '+scores[1]+'</span><br>'+
        '<button onclick="GorillasGame.newRound()">NEXT ROUND</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');
      gamePhase='roundOver';},1000);},
  drawSky(){const gr=ctx.createLinearGradient(0,0,0,H);gr.addColorStop(0,'#000020');gr.addColorStop(0.5,'#000050');gr.addColorStop(1,'#000080');
    ctx.fillStyle=gr;ctx.fillRect(0,0,W,H);
    for(let i=0;i<60;i++){ctx.fillStyle='rgba(255,255,255,'+(0.3+(i*3571%70)/100)+')';ctx.fillRect((i*7919+42)%W,(i*6271+42)%(H*0.6),1+(i%2),1+(i%2));}},
  drawSun(){const sx=W/2,sy=42,sr=22;ctx.fillStyle='#ffff00';ctx.beginPath();ctx.arc(sx,sy,sr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#ffff00';ctx.lineWidth=2;
    for(let a=0;a<Math.PI*2;a+=Math.PI/6){ctx.beginPath();ctx.moveTo(sx+Math.cos(a)*(sr+3),sy+Math.sin(a)*(sr+3));ctx.lineTo(sx+Math.cos(a)*(sr+10),sy+Math.sin(a)*(sr+10));ctx.stroke();}
    ctx.fillStyle='#000';
    if(this.sunSt==='normal'){ctx.fillRect(sx-8,sy-5,4,4);ctx.fillRect(sx+4,sy-5,4,4);ctx.beginPath();ctx.arc(sx,sy+3,8,0.2,Math.PI-0.2);ctx.lineWidth=2;ctx.strokeStyle='#000';ctx.stroke();}
    else{ctx.fillRect(sx-8,sy-7,5,5);ctx.fillRect(sx+3,sy-7,5,5);ctx.beginPath();ctx.arc(sx,sy+5,5,0,Math.PI*2);ctx.fill();}
    if(this.sunT>0){this.sunT--;if(this.sunT<=0)this.sunSt='normal';}},
  drawG(g,idx){const cx=g.x,cy=g.y,s=2;ctx.fillStyle='#aa5500';
    ctx.fillRect(cx-6*s,cy-2*s,12*s,10*s);ctx.fillRect(cx-5*s,cy-7*s,10*s,6*s);
    ctx.fillRect(cx-5*s,cy+8*s,4*s,4*s);ctx.fillRect(cx+1*s,cy+8*s,4*s,4*s);
    const t=gamePhase==='flight'&&idx===currentPlayer;
    if(t){if(idx===0){ctx.fillRect(cx-8*s,cy-6*s,3*s,5*s);ctx.fillRect(cx+6*s,cy-10*s,3*s,5*s);}
    else{ctx.fillRect(cx-8*s,cy-10*s,3*s,5*s);ctx.fillRect(cx+6*s,cy-6*s,3*s,5*s);}}
    else{ctx.fillRect(cx-8*s,cy-2*s,3*s,8*s);ctx.fillRect(cx+6*s,cy-2*s,3*s,8*s);}
    ctx.fillStyle='#fff';ctx.fillRect(cx-3*s,cy-5*s,2*s,2*s);ctx.fillRect(cx+1*s,cy-5*s,2*s,2*s);
    ctx.fillStyle='#000';ctx.fillRect(cx-2*s,cy-5*s,1*s,1*s);ctx.fillRect(cx+2*s,cy-5*s,1*s,1*s);
    ctx.fillStyle='#cc8833';ctx.fillRect(cx-3*s,cy+1*s,6*s,4*s);},
  drawBan(b){ctx.save();ctx.translate(b.x,b.y);ctx.rotate(b.rot);ctx.fillStyle='#ffff00';
    ctx.beginPath();ctx.arc(0,0,5,0,Math.PI,false);ctx.lineTo(-5,0);ctx.lineTo(-3,-5);ctx.lineTo(3,-5);ctx.lineTo(5,0);ctx.fill();ctx.restore();},
  draw(){this.drawSky();this.drawSun();drawWind();ctx.drawImage(terrainCanvas,0,0);
    if(gamePhase==='hit'||gamePhase==='roundOver')this.drawG(this.g[currentPlayer],currentPlayer);
    else{this.drawG(this.g[0],0);this.drawG(this.g[1],1);}
    if(projectile&&projectile.alive)this.drawBan(projectile);drawExplosions();drawParticles();}
};

// ==================== STAR WARS ====================
const PLANETS={
  hoth:{n:'HOTH',sky:['#8899bb','#aabbdd','#ccddef'],bc:['#dde8f0','#c8d8e8','#b0c4d8','#99aabb'],wl:'#aaddff',wd:'#8899aa',st:false,su:false,mo:false,we:'snow',fo:'rgba(180,200,220,0.15)',bo:'#ff4444',bm:['#ff4444','#ff8800','#ffcc00','#ffffff']},
  tatooine:{n:'TATOOINE',sky:['#ff8833','#ffaa44','#ffcc66'],bc:['#cc9955','#bb8844','#ddaa66','#aa7733'],wl:'#ffdd88',wd:'#665533',st:false,su:true,mo:false,we:null,fo:'rgba(255,180,80,0.08)',bo:'#ff2200',bm:['#ff4400','#ff8800','#ffcc00','#ffee88']},
  andor:{n:'FERRIX',sky:['#222833','#2a3040','#384050'],bc:['#445566','#3a4a5a','#556677','#4a5a6a'],wl:'#ffaa44',wd:'#223344',st:true,su:false,mo:false,we:'rain',fo:'rgba(40,50,60,0.2)',bo:'#44ff44',bm:['#44ff44','#88ff44','#ffff44','#ffffff']},
  deathstar:{n:'DEATH STAR',sky:['#000000','#050510','#0a0a20'],bc:['#444450','#555560','#3a3a44','#4a4a55'],wl:'#44ff44',wd:'#222228',st:true,su:false,mo:false,sp:true,we:null,fo:null,bo:'#00ff00',bm:['#00ff44','#44ff88','#88ffaa','#ffffff']},
  endor:{n:'ENDOR',sky:['#112211','#1a331a','#224422'],bc:['#556633','#667744','#445522','#778855'],wl:'#ffcc33',wd:'#2a3320',st:false,su:false,mo:true,tr:true,we:'fireflies',fo:'rgba(20,40,10,0.15)',bo:'#ff4444',bm:['#ff4400','#ff8800','#ffcc00','#88ff44']}
};
const PK=Object.keys(PLANETS);

const SWGame={
  wk:[{x:0,y:0},{x:0,y:0}],t:PLANETS.hoth,trees:[],
  init(planet){activeGame='starwars';hideMsg();showEl('exitBtn');canvas.style.cursor='default';
    this.t=planet?PLANETS[planet]:PLANETS[PK[Math.floor(Math.random()*PK.length)]];
    $('scoreboard').className='sw-mode';
    $('p1Label').textContent='AT-AT';$('p2Label').textContent='AT-TE';
    $('gameTitle').textContent='IMPERIAL WALKERS';$('gameTitle').style.color='#FFE81F';
    $('subLabel').textContent=this.t.n;
    $('fireBtn').textContent='FIRE!';$('fireBtn').className='sw-btn';
    $('input-panel').style.borderColor='#555';$('input-panel').style.background='rgba(0,0,0,0.88)';
    $('fireBtn').style.borderColor='#FFE81F';$('fireBtn').style.color='#FFE81F';
    $('score1').textContent='0';$('score2').textContent='0';
    scores=[0,0];currentPlayer=0;this.setup();},
  newRound(){this.t=PLANETS[PK[Math.floor(Math.random()*PK.length)]];$('subLabel').textContent=this.t.n;this.setup();},
  sameRound(){this.setup();},
  setup(){this.genB();this.placeW();this.initT();this.genTr();
    wind=(Math.random()-0.5)*30;projectile=null;explosions=[];particles=[];envParticles=[];
    gamePhase='input';this.showIn();},
  genB(){buildings=[];let x=0;while(x<W+75){const bw=40+Math.random()*35,bh=80+Math.random()*220;
    buildings.push({x:Math.floor(x),w:Math.floor(bw),h:Math.floor(bh),color:this.t.bc[Math.floor(Math.random()*this.t.bc.length)]});x+=bw;}},
  placeW(){const bi1=Math.floor(buildings.length*0.12)+Math.floor(Math.random()*2);
    const b1=buildings[Math.min(bi1,buildings.length-1)];this.wk[0]={x:b1.x+b1.w/2,y:H-b1.h};
    const bi2=Math.floor(buildings.length*0.82)+Math.floor(Math.random()*2);
    const b2=buildings[Math.min(bi2,buildings.length-1)];this.wk[1]={x:b2.x+b2.w/2,y:H-b2.h};},
  initT(){terrainCanvas=document.createElement('canvas');terrainCanvas.width=W;terrainCanvas.height=H;
    terrainCtx=terrainCanvas.getContext('2d');terrainCtx.clearRect(0,0,W,H);
    for(const b of buildings){terrainCtx.fillStyle=b.color;terrainCtx.fillRect(b.x,H-b.h,b.w,b.h);
      for(let wy=H-b.h+12;wy<H-10;wy+=13)for(let wx=b.x+6;wx<b.x+b.w-8;wx+=13){
        terrainCtx.fillStyle=Math.random()>0.35?this.t.wl:this.t.wd;terrainCtx.fillRect(wx,wy,5,5);}}},
  genTr(){this.trees=[];if(!this.t.tr)return;for(let i=0;i<15;i++){const tx=Math.random()*W;let on=false;
    for(const b of buildings)if(tx>b.x&&tx<b.x+b.w){on=true;break;}
    if(!on)this.trees.push({x:tx,y:H,w:20+Math.random()*20,h:30+Math.random()*40});}},
  showIn(){showEl('input-panel');showEl('scoreboard');
    const lb=currentPlayer===0?'AT-AT':'AT-TE';
    $('turnLabel').textContent=lb+' \u25B8';$('turnLabel').style.color=currentPlayer===0?'#8cf':'#f88';
    $('angleInput').value='60';$('powerInput').value='70';$('angleInput').focus();},
  fire(angle,power){hideEl('input-panel');const w=this.wk[currentPlayer],dir=currentPlayer===0?1:-1;
    const rad=(angle*Math.PI)/180,speed=power*0.6,sd=currentPlayer===0?70:60;
    projectile={x:w.x+dir*sd,y:w.y-50,vx:Math.cos(rad)*speed*dir,vy:-Math.sin(rad)*speed,
      rot:0,alive:true,sx:w.x+dir*sd,sy:w.y-50};
    destroyTerrain(projectile.x,projectile.y,12);gamePhase='flight';},
  checkCol(x,y){if(x<-20||x>W+20||y>H)return'miss';if(y<0)return'none';
    for(let i=0;i<2;i++){const w=this.wk[i];let x1,x2,y1,y2;
      if(i===0){x1=w.x-22;x2=w.x+42;y1=w.y-35;y2=w.y+38;}
      else{x1=w.x-28;x2=w.x+35;y1=w.y-25;y2=w.y+28;}
      if(x>x1&&x<x2&&y>y1&&y<y2)return i===currentPlayer?'self':'hit';}
    if(y>=0&&y<H&&x>=0&&x<W&&terrainCtx.getImageData(Math.floor(x),Math.floor(y),1,1).data[3]>0)return'building';
    return'none';},
  updateP(dt){if(!projectile||!projectile.alive)return;
    projectile.vx+=wind*0.08*dt;projectile.vy+=14.7*dt;projectile.x+=projectile.vx*dt;projectile.y+=projectile.vy*dt;
    projectile.rot=Math.atan2(projectile.vy,projectile.vx);
    const dx=projectile.x-projectile.sx,dy=projectile.y-projectile.sy;if(Math.sqrt(dx*dx+dy*dy)<80)return;
    const c=this.checkCol(projectile.x,projectile.y);
    if(c==='hit'||c==='self')this.result(c);
    else if(c==='building'){createExplosion(projectile.x,projectile.y,24);destroyTerrain(projectile.x,projectile.y,24);
      projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},800);}
    else if(c==='miss'){projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},400);}},
  result(type){if(type==='hit')scores[currentPlayer]++;else scores[1-currentPlayer]++;
    $('score1').textContent=scores[0];$('score2').textContent=scores[1];
    createExplosion(projectile.x,projectile.y,40);destroyTerrain(projectile.x,projectile.y,40);
    projectile.alive=false;gamePhase='hit';
    setTimeout(()=>{const nm=currentPlayer===0?'AT-AT':'AT-TE';
      const msg=type==='hit'?'<span style="color:'+(currentPlayer===0?'#8cf':'#f88')+';font-family:Orbitron,sans-serif;font-size:14px;font-weight:700">'+nm+' WINS!</span>'
        :'<span style="color:#f44;font-family:Orbitron,sans-serif;font-size:12px;font-weight:700">'+nm+' HIT ITSELF!</span>';
      showMsg(msg+'<br><span style="font-family:VT323;font-size:20px;color:#aaa">Score: '+scores[0]+' - '+scores[1]+'</span><br>'+
        '<button class="sw-btn" onclick="SWGame.sameRound()">NEXT ROUND</button> <button class="sw-btn" onclick="SWGame.showPl()">CHANGE MAP</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');
      gamePhase='roundOver';},1000);},
  showPl(){hideMsg();hideEl('input-panel');showEl('exitBtn');scores=[0,0];currentPlayer=0;$('score1').textContent='0';$('score2').textContent='0';gamePhase='title';
    showMsg('<span style="font-family:Orbitron,sans-serif;font-size:18px;letter-spacing:3px;color:#FFE81F">CHOOSE PLANET</span><br>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'hoth\')">&#10052; HOTH</button>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'tatooine\')">&#9728; TATOOINE</button><br>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'andor\')">&#127783; FERRIX</button>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'deathstar\')">&#9673; DEATH STAR</button><br>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'endor\')">&#127794; ENDOR</button>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init()">&#9889; RANDOM</button><br>'+
      '<button onclick="showArcadeMenu()">&#8617; ARCADE MENU</button>');},
  // Drawing
  drawSky(){const t=this.t,gr=ctx.createLinearGradient(0,0,0,H);
    gr.addColorStop(0,t.sky[0]);gr.addColorStop(0.5,t.sky[1]);gr.addColorStop(1,t.sky[2]);
    ctx.fillStyle=gr;ctx.fillRect(0,0,W,H);
    if(t.st)for(let i=0;i<120;i++){ctx.fillStyle='rgba(255,255,255,'+(0.2+(i*3571%80)/100)+')';ctx.fillRect((i*7919+42)%W,(i*6271+42)%(H*0.65),1+(i%3===0?1:0),1+(i%3===0?1:0));}
    if(t.su){ctx.shadowColor='#ffaa00';ctx.shadowBlur=40;ctx.fillStyle='#fff8cc';ctx.beginPath();ctx.arc(180,60,25,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ffeeaa';ctx.beginPath();ctx.arc(260,85,18,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
    if(t.mo){ctx.shadowColor='#aabbcc';ctx.shadowBlur=30;ctx.fillStyle='#8899aa';ctx.beginPath();ctx.arc(620,70,40,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='#778899';ctx.beginPath();ctx.arc(610,60,8,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(635,80,5,0,Math.PI*2);ctx.fill();}
    if(t.sp){ctx.fillStyle='#113322';ctx.beginPath();ctx.arc(650,120,55,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#1a4433';ctx.beginPath();ctx.arc(650,120,55,0.3,2.8);ctx.fill();
      ctx.strokeStyle='rgba(100,255,100,0.04)';ctx.lineWidth=1;for(let gy=0;gy<H;gy+=40){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(W,gy);ctx.stroke();}}
    if(t.fo){ctx.fillStyle=t.fo;ctx.fillRect(0,0,W,H);}},
  drawTr(){if(!this.t.tr)return;for(const tr of this.trees){ctx.fillStyle='#443322';ctx.fillRect(tr.x-3,tr.y,6,tr.h);
    ['#2a5522','#336633','#2a6622'].forEach((c,i)=>{ctx.fillStyle=c;ctx.beginPath();
      ctx.moveTo(tr.x-tr.w/2+i*4,tr.y-i*10);ctx.lineTo(tr.x+tr.w/2-i*4,tr.y-i*10);ctx.lineTo(tr.x,tr.y-tr.h-i*8);ctx.fill();});}},
  spawnEnv(){const t=this.t;
    if(t.we==='snow'&&Math.random()<0.3)envParticles.push({x:Math.random()*W,y:-5,vx:(Math.random()-0.5)+wind*0.02,vy:0.5+Math.random()*1.5,size:1+Math.random()*2,color:'rgba(255,255,255,'+(0.3+Math.random()*0.5)+')',life:1});
    else if(t.we==='rain'&&Math.random()<0.4)envParticles.push({x:Math.random()*W,y:-5,vx:wind*0.05,vy:6+Math.random()*4,size:1,color:'rgba(150,170,200,'+(0.2+Math.random()*0.3)+')',life:1,isRain:true});
    else if(t.we==='fireflies'&&Math.random()<0.02)envParticles.push({x:Math.random()*W,y:H*0.4+Math.random()*H*0.5,vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,size:2,color:'#ffff44',life:1,decay:0.003,isFF:true,phase:Math.random()*Math.PI*2});},
  drawATAT(cx,cy,s,f){ctx.save();ctx.translate(cx,cy);if(f<0)ctx.scale(-1,1);
    ctx.fillStyle='#8899aa';ctx.fillRect(-12*s,-16*s,24*s,12*s);
    ctx.fillStyle='#778899';ctx.fillRect(-10*s,-15*s,8*s,4*s);ctx.fillRect(0,-15*s,8*s,4*s);
    ctx.fillStyle='#99aabb';ctx.fillRect(-10*s,-10*s,20*s,2*s);ctx.fillStyle='#667788';ctx.fillRect(-10*s,-4*s,20*s,3*s);
    ctx.fillStyle='#7788a0';ctx.beginPath();ctx.moveTo(12*s,-14*s);ctx.lineTo(18*s,-18*s);ctx.lineTo(20*s,-16*s);ctx.lineTo(14*s,-12*s);ctx.fill();
    ctx.fillStyle='#8899aa';ctx.fillRect(16*s,-22*s,12*s,8*s);ctx.fillStyle='#667788';ctx.fillRect(17*s,-21*s,4*s,3*s);
    ctx.fillStyle='#556677';ctx.fillRect(22*s,-14*s,6*s,2*s);ctx.fillRect(22*s,-16*s,2*s,4*s);
    ctx.fillStyle='#ff3333';ctx.fillRect(24*s,-21*s,3*s,2*s);ctx.fillStyle='#778899';ctx.fillRect(-14*s,-15*s,4*s,10*s);
    ctx.fillStyle='#7788a0';ctx.fillRect(6*s,-2*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(5*s,9*s,5*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(6*s,11*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(3*s,22*s,8*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(3*s,-2*s,2*s,25*s);ctx.fillRect(1*s,22*s,6*s,3*s);
    ctx.fillStyle='#7788a0';ctx.fillRect(-8*s,-2*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(-9*s,9*s,5*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(-8*s,11*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(-11*s,22*s,8*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(-5*s,-2*s,2*s,25*s);ctx.fillRect(-7*s,22*s,6*s,3*s);ctx.restore();},
  drawATTE(cx,cy,s,f){ctx.save();ctx.translate(cx,cy);if(f<0)ctx.scale(-1,1);
    ctx.fillStyle='#889977';ctx.fillRect(-16*s,-8*s,32*s,10*s);
    ctx.fillStyle='#778866';ctx.fillRect(-14*s,-7*s,10*s,4*s);ctx.fillRect(2*s,-7*s,10*s,4*s);
    ctx.fillStyle='#99aa88';ctx.fillRect(-14*s,-3*s,28*s,2*s);
    ctx.fillStyle='#7a8a69';ctx.fillRect(-18*s,-6*s,4*s,7*s);ctx.fillRect(14*s,-6*s,4*s,7*s);
    ctx.fillStyle='#8a9a79';ctx.fillRect(-6*s,-12*s,12*s,5*s);ctx.fillStyle='#667755';ctx.fillRect(-2*s,-15*s,4*s,4*s);
    ctx.fillStyle='#556644';ctx.fillRect(2*s,-14*s,12*s,2*s);
    ctx.fillStyle='#778866';ctx.fillRect(14*s,-5*s,8*s,2*s);ctx.fillRect(14*s,-1*s,8*s,2*s);
    ctx.fillStyle='#aaccff';ctx.fillRect(15*s,-5*s,2*s,2*s);ctx.fillStyle='#667755';ctx.fillRect(-14*s,2*s,28*s,3*s);
    ctx.fillStyle='#778866';ctx.fillRect(10*s,4*s,2*s,7*s);ctx.fillStyle='#667755';ctx.fillRect(9*s,10*s,2*s,7*s);
    ctx.fillStyle='#556644';ctx.fillRect(7*s,16*s,6*s,2*s);
    ctx.fillStyle='#778866';ctx.fillRect(0,4*s,2*s,8*s);ctx.fillStyle='#667755';ctx.fillRect(-1*s,11*s,2*s,6*s);
    ctx.fillStyle='#556644';ctx.fillRect(-3*s,16*s,6*s,2*s);
    ctx.fillStyle='#778866';ctx.fillRect(-10*s,4*s,2*s,7*s);ctx.fillStyle='#667755';ctx.fillRect(-11*s,10*s,2*s,7*s);
    ctx.fillStyle='#556644';ctx.fillRect(-13*s,16*s,6*s,2*s);
    ctx.fillStyle='#667755';ctx.fillRect(12*s,4*s,1.5*s,13*s);ctx.fillRect(2*s,4*s,1.5*s,13*s);ctx.fillRect(-8*s,4*s,1.5*s,13*s);ctx.restore();},
  drawBolt(p){ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot||0);
    ctx.shadowColor=this.t.bo;ctx.shadowBlur=12;ctx.fillStyle='#ffffff';ctx.fillRect(-6,-2,12,4);
    ctx.fillStyle=this.t.bo;ctx.fillRect(-8,-3,16,6);ctx.shadowBlur=0;ctx.restore();},
  draw(){this.drawSky();this.drawTr();drawWind();ctx.drawImage(terrainCanvas,0,0);
    if(gamePhase==='hit'||gamePhase==='roundOver'){if(currentPlayer===0)this.drawATAT(this.wk[0].x,this.wk[0].y,1.5,1);else this.drawATTE(this.wk[1].x,this.wk[1].y,1.5,-1);}
    else{this.drawATAT(this.wk[0].x,this.wk[0].y,1.5,1);this.drawATTE(this.wk[1].x,this.wk[1].y,1.5,-1);}
    if(projectile&&projectile.alive)this.drawBolt(projectile);
    drawExplosions();drawParticles();this.spawnEnv();updateEnv();drawEnv();}
};

// ==================== TOP GUN ====================
const TG='#2a3518',TG_G='rgba(42,53,24,0.07)',TG_M='rgba(42,53,24,0.4)',TG_L='rgba(42,53,24,0.2)',TG_BG='#8b9f5a';
const TG_SLOTS=[];
(function(){for(let r=0;r<5;r++){const y=0.14+r*0.11,cols=r%2===0?4:3;
  for(let c=0;c<cols;c++){const x=r%2===0?0.22+c*0.187:0.30+c*0.20;TG_SLOTS.push({x,y});}}})();

const TopGunSFX={ctx:null,
  init(){if(this.ctx)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}},
  play(type){if(!this.ctx)return;const t=this.ctx.currentTime,osc=()=>this.ctx.createOscillator(),gn=()=>this.ctx.createGain();
    if(type==='shoot'){const o=osc(),g=gn();o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(900,t);o.frequency.exponentialRampToValueAtTime(200,t+0.08);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.08);o.start(t);o.stop(t+0.08);}
    else if(type==='hit'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.25,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.25);src.start(t);}
    else if(type==='damage'){const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(60,t+0.35);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.35);o.start(t);o.stop(t+0.35);}
    else if(type==='gameover'){[220,190,160,120].forEach((f,i)=>{const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.2);g.gain.setValueAtTime(0.08,t+i*0.2);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.2+0.19);o.start(t+i*0.2);o.stop(t+i*0.2+0.2);});}
    else if(type==='countdown'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(440,t);g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);o.start(t);o.stop(t+0.12);}
    else if(type==='go'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(880,t);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);o.start(t);o.stop(t+0.2);}
    else if(type==='victory'){[523,659,784,1047,784,1047].forEach((f,i)=>{const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.15);g.gain.setValueAtTime(0.1,t+i*0.15);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.15+0.14);o.start(t+i*0.15);o.stop(t+i*0.15+0.15);});}}
};

const TopGunGame={
  en:[],ex:[],bul:[],par:[],crossX:0.5,crossY:0.4,
  sc:0,liv:3,wav:1,st:'idle',
  spT:0,killed:0,waveTarget:5,eSpd:0.3,spInt:2200,maxOn:4,
  pAngle:0,gScroll:0,cdPhase:0,cdTimer:0,vicTimer:0,tgKeys:{},hitFlash:0,
  MAX_W:9,CD_DUR:[1200,900,700,700,700,500],CD_TXT:['','READY','3','2','1','GO!'],

  init(){activeGame='topgun';hideMsg();showEl('exitBtn');hideEl('input-panel');
    canvas.style.cursor='crosshair';
    $('scoreboard').className='topgun-mode';showEl('scoreboard');
    $('p1Label').textContent='SCR';$('p2Label').textContent='LIVES';
    $('gameTitle').textContent='T O P  G U N';$('gameTitle').style.color=TG;
    $('subLabel').textContent='Naval Fighter Combat';
    this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.bul=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.gScroll=0;this.hitFlash=0;
    TopGunSFX.init();this.updHUD();this.startCD();gamePhase='topgun';},

  updHUD(){$('score1').textContent=String(this.sc).padStart(5,'0');
    $('subLabel').textContent='WAVE '+this.wav+'/'+this.MAX_W;
    let lv='';for(let i=0;i<this.liv;i++)lv+='\u2708';$('score2').textContent=lv;},

  getWC(w){return{target:5+w*2,speed:0.3+w*0.06,spInt:Math.max(1200-w*100,350),maxOn:Math.min(3+w,12)};},

  startCD(){this.st='countdown';this.cdPhase=0;this.cdTimer=0;
    this.en=[];this.ex=[];this.bul=[];this.par=[];
    const c=this.getWC(this.wav);this.waveTarget=c.target;this.eSpd=c.speed;this.spInt=c.spInt;this.maxOn=c.maxOn;
    this.killed=0;this.spT=0;},

  spawnE(){const free=TG_SLOTS.filter(s=>!this.en.some(e=>e.alive&&Math.abs(e.x-s.x)<0.08&&Math.abs(e.y-s.y)<0.08));
    if(!free.length)return;const s=free[Math.floor(Math.random()*free.length)];
    this.en.push({x:s.x,y:s.y,bx:s.x,by:s.y,dir:Math.random()>0.5?1:-1,
      range:0.02+Math.random()*0.02,spd:this.eSpd*(0.7+Math.random()*0.6),
      alive:true,t:0,life:8000+Math.random()*5000+this.wav*1000,
      shootCD:Math.max(400,1200-this.wav*80)+Math.random()*1000,flash:0});},

  shoot(){if(this.st!=='playing')return;TopGunSFX.play('shoot');
    let hit=false,closest=null,closestD=Infinity;
    for(const e of this.en){if(!e.alive)continue;
      const dx=this.crossX-e.x,dy=this.crossY-e.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<0.12&&d<closestD){closest=e;closestD=d;}}
    if(closest){closest.alive=false;hit=true;this.sc+=100*this.wav;this.killed++;TopGunSFX.play('hit');
      this.ex.push({x:closest.x,y:closest.y,progress:0});
      for(let i=0;i<6;i++)this.par.push({x:closest.x,y:closest.y,
        vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,
        r:0.002+Math.random()*0.003,alpha:0.8,life:0.5+Math.random()*0.3});
      this.hitFlash=6;}
    if(!hit)this.bul.push({x:this.crossX,y:0.82,enemy:false});
    this.updHUD();},

  takeDmg(){this.liv--;TopGunSFX.play('damage');this.hitFlash=12;this.updHUD();
    if(this.liv<=0){this.st='gameover';TopGunSFX.play('gameover');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#ff4444">GAME OVER</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:20px;color:#aaa">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="tg-btn" onclick="TopGunGame.restart()">PLAY AGAIN</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');}},

  restart(){hideMsg();this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.bul=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.hitFlash=0;
    TopGunSFX.init();this.updHUD();this.startCD();},

  nextWave(){if(this.wav>=this.MAX_W){this.st='victory';this.vicTimer=0;TopGunSFX.play('victory');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#ff0">WINNER!</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:16px;color:#aaa">TOP GUN ACE PILOT</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:20px;color:#fff">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="tg-btn" onclick="TopGunGame.restart()">PLAY AGAIN</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');return;}
    this.wav++;this.updHUD();this.startCD();},

  updateCD(dt){this.cdTimer+=dt*1000;
    if(this.cdTimer>=this.CD_DUR[this.cdPhase]){this.cdTimer=0;this.cdPhase++;
      if(this.cdPhase>=2&&this.cdPhase<=4)TopGunSFX.play('countdown');
      if(this.cdPhase===5)TopGunSFX.play('go');
      if(this.cdPhase>=this.CD_DUR.length){this.st='playing';}}},

  update(dt){
    if(this.hitFlash>0)this.hitFlash--;
    if(this.st==='countdown'){this.updateCD(dt);return;}
    if(this.st!=='playing')return;
    const cs=0.5;
    if(this.tgKeys['ArrowLeft']||this.tgKeys['a'])this.crossX-=cs*dt;
    if(this.tgKeys['ArrowRight']||this.tgKeys['d'])this.crossX+=cs*dt;
    if(this.tgKeys['ArrowUp']||this.tgKeys['w'])this.crossY-=cs*dt;
    if(this.tgKeys['ArrowDown']||this.tgKeys['s'])this.crossY+=cs*dt;
    this.crossX=Math.max(0,Math.min(1,this.crossX));
    this.crossY=Math.max(0,Math.min(0.8,this.crossY));
    // Spawn
    this.spT+=dt*1000;
    if(this.spT>=this.spInt&&this.en.filter(e=>e.alive).length<this.maxOn){this.spawnE();this.spT=0;}
    // Enemies
    this.en.forEach(e=>{if(!e.alive)return;e.t+=dt*1000;
      e.x=e.bx+Math.sin(e.t*0.0015*e.spd)*e.range*e.dir;
      e.y=e.by+Math.sin(e.t*0.001*e.spd)*0.015;
      e.x=Math.max(0.05,Math.min(0.95,e.x));e.y=Math.max(0.05,Math.min(0.7,e.y));
      e.shootCD-=dt*1000;
      if(e.shootCD<=0){e.flash=150;
        e.shootCD=Math.max(800,1800-this.wav*120)+Math.random()*1200;
        const dx=0.5-e.x+(Math.random()-0.5)*0.15,dy=0.85-e.y;
        const dist=Math.sqrt(dx*dx+dy*dy),bs=0.45+this.wav*0.03;
        this.bul.push({x:e.x,y:e.y+0.03,vx:(dx/dist)*bs,vy:(dy/dist)*bs,enemy:true});}
      if(e.flash>0)e.flash-=dt*1000;
      if(e.t>e.life)e.alive=false;});
    this.en=this.en.filter(e=>e.alive);
    // Bullets
    this.bul=this.bul.filter(b=>{
      if(b.enemy){b.x+=(b.vx||0)*dt;b.y+=(b.vy||0)*dt;
        if(Math.abs(b.x-0.5)<0.04&&Math.abs(b.y-0.85)<0.035){this.takeDmg();return false;}
        return b.y<1.05&&b.y>-0.05&&b.x>-0.05&&b.x<1.05;}
      else{b.y-=1.8*dt;return b.y>-0.05;}});
    // Effects
    this.ex.forEach(e=>e.progress+=dt*2.5);this.ex=this.ex.filter(e=>e.progress<1);
    this.par.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.alpha-=dt*2;p.life-=dt;});
    this.par=this.par.filter(p=>p.life>0&&p.alpha>0);
    // Wave check
    if(this.killed>=this.waveTarget)this.nextWave();
    // Player angle
    const dx=this.crossX-0.5,dy=this.crossY-0.85;
    const ta=Math.max(-0.7,Math.min(0.7,Math.atan2(dx,-dy)*0.5));
    this.pAngle+=(ta-this.pAngle)*Math.min(1,dt*8);},

  // ---- Drawing ----
  drawJet(cx,cy,size,color,flipped,angle){
    const x=cx*W,y=cy*H,s=size*Math.min(W,H);
    ctx.fillStyle=color;ctx.save();ctx.translate(x,y);if(angle)ctx.rotate(angle);
    ctx.beginPath();ctx.moveTo(0,-s*0.5);ctx.lineTo(s*0.08,s*0.3);ctx.lineTo(-s*0.08,s*0.3);ctx.closePath();ctx.fill();
    ctx.beginPath();
    if(flipped){ctx.moveTo(-s*0.45,s*0.05);ctx.lineTo(0,-s*0.15);ctx.lineTo(s*0.45,s*0.05);ctx.lineTo(s*0.35,s*0.15);ctx.lineTo(-s*0.35,s*0.15);}
    else{ctx.moveTo(-s*0.45,s*0.1);ctx.lineTo(0,-s*0.1);ctx.lineTo(s*0.45,s*0.1);ctx.lineTo(s*0.35,s*0.2);ctx.lineTo(-s*0.35,s*0.2);}
    ctx.closePath();ctx.fill();
    ctx.beginPath();
    if(flipped){ctx.moveTo(-s*0.2,-s*0.45);ctx.lineTo(0,-s*0.25);ctx.lineTo(s*0.2,-s*0.45);}
    else{ctx.moveTo(-s*0.18,s*0.4);ctx.lineTo(0,s*0.2);ctx.lineTo(s*0.18,s*0.4);}
    ctx.closePath();ctx.fill();ctx.restore();},

  drawGhosts(){TG_SLOTS.forEach(s=>this.drawJet(s.x,s.y,0.045,TG_G,true));},

  drawGround(dt){this.gScroll+=dt*0.5;const gy=H*0.88;
    ctx.strokeStyle=TG_M;ctx.lineWidth=1;
    for(let i=0;i<4;i++){const y=gy+i*(H*0.025);ctx.beginPath();
      for(let x=-20;x<W+20;x+=4){const w=Math.sin((x+this.gScroll*80+i*40)*0.025)*3;
        if(x===-20)ctx.moveTo(x,y+w);else ctx.lineTo(x,y+w);}ctx.stroke();}
    ctx.fillStyle=TG_G;const cx2=W*0.5,cy2=gy+H*0.06;
    ctx.fillRect(cx2-W*0.08,cy2,W*0.16,H*0.01);
    ctx.fillRect(cx2-W*0.05,cy2-H*0.008,W*0.008,H*0.008);
    ctx.fillRect(cx2+W*0.02,cy2-H*0.014,W*0.005,H*0.014);},

  drawCross(){const x=this.crossX*W,y=this.crossY*H,r=18*(Math.min(W,H)/600),ext=8*(Math.min(W,H)/600);
    ctx.strokeStyle=TG;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x-r-ext,y);ctx.lineTo(x-r+4,y);ctx.moveTo(x+r-4,y);ctx.lineTo(x+r+ext,y);
    ctx.moveTo(x,y-r-ext);ctx.lineTo(x,y-r+4);ctx.moveTo(x,y+r-4);ctx.lineTo(x,y+r+ext);ctx.stroke();
    ctx.fillStyle=TG;ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fill();},

  drawExpl(ex){const x=ex.x*W,y=ex.y*H,p=ex.progress,r=(15+p*40)*(Math.min(W,H)/600);
    ctx.strokeStyle=p<0.6?TG:TG_M;ctx.lineWidth=2;
    for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+p*3;ctx.beginPath();
      ctx.moveTo(x+Math.cos(a)*r*0.2,y+Math.sin(a)*r*0.2);
      ctx.lineTo(x+Math.cos(a)*r*(0.5+p*0.5),y+Math.sin(a)*r*(0.5+p*0.5));ctx.stroke();}
    if(p<0.4){ctx.fillStyle=TG;ctx.beginPath();ctx.arc(x,y,r*0.25*(1-p*2),0,Math.PI*2);ctx.fill();}
    ctx.strokeStyle=TG_M;ctx.lineWidth=1;ctx.beginPath();ctx.arc(x,y,r*p,0,Math.PI*2);ctx.stroke();},

  drawCD(){const cx=W/2,cy=H/2;ctx.fillStyle=TG;
    ctx.font=Math.min(W,H)*0.04+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('WAVE '+this.wav+' OF '+this.MAX_W,cx,cy-Math.min(W,H)*0.08);
    const txt=this.CD_TXT[this.cdPhase];
    if(txt){const isNum=['3','2','1'].includes(txt),isGo=txt==='GO!';
      const fs=isNum?0.12:(isGo?0.08:0.04);
      const phase=this.cdTimer/this.CD_DUR[this.cdPhase];
      const sc=isNum?1+Math.sin(phase*Math.PI)*0.15:1;
      const al=isGo?Math.max(0,1-phase*2):1;
      ctx.save();ctx.translate(cx,cy+Math.min(W,H)*0.02);ctx.scale(sc,sc);ctx.globalAlpha=al;
      ctx.fillStyle=TG;ctx.font=Math.min(W,H)*fs+'px "Press Start 2P"';ctx.fillText(txt,0,0);
      ctx.restore();ctx.globalAlpha=1;}},

  draw(dt){
    // LCD green background
    ctx.fillStyle=TG_BG;ctx.fillRect(0,0,W,H);
    // Scanlines
    ctx.fillStyle='rgba(0,0,0,0.02)';for(let y=0;y<H;y+=3)ctx.fillRect(0,y,W,1);
    // Hit flash overlay
    if(this.hitFlash>0){ctx.fillStyle='rgba(42,53,24,0.15)';ctx.fillRect(0,0,W,H);}

    this.drawGhosts();this.drawGround(dt);

    if(this.st==='countdown'){this.drawJet(0.5,0.85,0.055,TG,false,0);this.drawCD();return;}
    if(this.st==='gameover'||this.st==='victory'){this.drawJet(0.5,0.85,0.055,TG,false,0);return;}

    // Enemy bullets
    this.bul.filter(b=>b.enemy).forEach(b=>{ctx.fillStyle=TG;ctx.fillRect(b.x*W-1.5,b.y*H-4,3,8);});
    // Player bullets
    this.bul.filter(b=>!b.enemy).forEach(b=>{ctx.fillStyle=TG;ctx.fillRect(b.x*W-1.5,b.y*H-5,3,10);
      ctx.fillStyle=TG_M;ctx.fillRect(b.x*W-1,b.y*H+5,2,6);});
    // Enemies
    this.en.forEach(e=>{if(!e.alive)return;
      this.drawJet(e.x,e.y,0.045,e.flash>80?TG_M:TG,true);
      if(e.flash>80){ctx.fillStyle=TG;ctx.beginPath();ctx.arc(e.x*W,(e.y+0.035)*H,4,0,Math.PI*2);ctx.fill();}});
    // Explosions & particles
    this.ex.forEach(e=>this.drawExpl(e));
    this.par.forEach(p=>{ctx.fillStyle='rgba(42,53,24,'+p.alpha+')';
      ctx.beginPath();ctx.arc(p.x*W,p.y*H,p.r*Math.min(W,H),0,Math.PI*2);ctx.fill();});
    // Player jet
    this.drawJet(0.5,0.85,0.055,TG,false,this.pAngle);
    if(this.st==='playing')this.drawCross();}
};

// ==================== STAR TREK ====================
const ST_SLOTS=[];
(function(){for(let r=0;r<5;r++){const y=0.14+r*0.11,cols=r%2===0?4:3;
  for(let c=0;c<cols;c++){const x=r%2===0?0.22+c*0.187:0.30+c*0.20;ST_SLOTS.push({x,y});}}})();

const StarTrekSFX={ctx:null,
  init(){if(this.ctx)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}},
  play(type){if(!this.ctx)return;const t=this.ctx.currentTime,osc=()=>this.ctx.createOscillator(),gn=()=>this.ctx.createGain();
    if(type==='shoot'){[0,0.05].forEach(d=>{const o=osc(),g=gn();o.connect(g);g.connect(this.ctx.destination);o.type='sine';o.frequency.setValueAtTime(800,t+d);o.frequency.exponentialRampToValueAtTime(1400,t+d+0.04);o.frequency.exponentialRampToValueAtTime(600,t+d+0.1);g.gain.setValueAtTime(0.07,t+d);g.gain.exponentialRampToValueAtTime(0.001,t+d+0.1);o.start(t+d);o.stop(t+d+0.1);});}
    else if(type==='hit'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.45,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.1);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.18,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.45);src.start(t);const o=osc(),g2=gn();o.type='sine';o.connect(g2);g2.connect(this.ctx.destination);o.frequency.setValueAtTime(90,t);o.frequency.exponentialRampToValueAtTime(25,t+0.35);g2.gain.setValueAtTime(0.12,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.35);o.start(t);o.stop(t+0.35);}
    else if(type==='damage'){const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+0.4);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);}
    else if(type==='gameover'){[200,170,140,100,70].forEach((f,i)=>{const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.25);g.gain.setValueAtTime(0.08,t+i*0.25);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.25+0.24);o.start(t+i*0.25);o.stop(t+i*0.25+0.25);});}
    else if(type==='countdown'){const o=osc(),g=gn();o.type='sine';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(600,t);g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);}
    else if(type==='go'){const o=osc(),g=gn();o.type='sine';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(1000,t);g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);o.start(t);o.stop(t+0.15);}
    else if(type==='victory'){[392,494,587,784,587,784,988].forEach((f,i)=>{const o=osc(),g=gn();o.type='sine';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.2);g.gain.setValueAtTime(0.08,t+i*0.2);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.2+0.19);o.start(t+i*0.2);o.stop(t+i*0.2+0.2);});}
    else if(type==='decloak'){const o=osc(),g=gn();o.type='triangle';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(600,t+0.2);g.gain.setValueAtTime(0.04,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);o.start(t);o.stop(t+0.2);}}
};

const StarTrekGame={
  en:[],ex:[],pBolts:[],eBolts:[],par:[],crossX:0.5,crossY:0.4,
  sc:0,liv:3,wav:1,st:'idle',
  spT:0,killed:0,waveTarget:7,eSpd:0.3,spInt:1200,maxOn:4,
  pAngle:0,cdPhase:0,cdTimer:0,vicTimer:0,stKeys:{},hitFlash:0,
  earthSize:0,starSpeed:0.5,stars:[],
  MAX_W:9,CD_DUR:[1200,900,700,700,700,500],CD_TXT:['','RED ALERT','3','2','1','ENGAGE!'],

  init(){activeGame='startrek';hideMsg();showEl('exitBtn');hideEl('input-panel');
    canvas.style.cursor='crosshair';
    $('scoreboard').className='startrek-mode';showEl('scoreboard');
    $('p1Label').textContent='SCR';$('p2Label').textContent='SHIPS';
    $('gameTitle').textContent='DEFEND EARTH';$('gameTitle').style.color='#8cf';
    $('subLabel').textContent='Enterprise vs Klingons';
    this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.pBolts=[];this.eBolts=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.hitFlash=0;
    this.earthSize=0;this.starSpeed=0.5;this.vicTimer=0;
    this.stars=[];for(let i=0;i<200;i++)this.stars.push({x:Math.random(),y:Math.random(),z:Math.random(),size:0.5+Math.random()*2});
    StarTrekSFX.init();this.updHUD();this.startCD();gamePhase='startrek';},

  updHUD(){$('score1').textContent=String(this.sc).padStart(5,'0');
    $('subLabel').textContent='WAVE '+this.wav+'/'+this.MAX_W;
    let lv='';for(let i=0;i<this.liv;i++)lv+='\u229B';$('score2').textContent=lv;},

  getWC(w){return{target:5+w*2,speed:0.3+w*0.06,spInt:Math.max(1200-w*100,350),maxOn:Math.min(3+w,12)};},

  startCD(){this.st='countdown';this.cdPhase=0;this.cdTimer=0;
    this.en=[];this.ex=[];this.pBolts=[];this.eBolts=[];this.par=[];
    const c=this.getWC(this.wav);this.waveTarget=c.target;this.eSpd=c.speed;this.spInt=c.spInt;this.maxOn=c.maxOn;
    this.killed=0;this.spT=0;
    this.earthSize=Math.min(W,H)*(0.1+this.wav*0.06);
    this.starSpeed=0.2+this.wav*0.04;},

  spawnE(){const free=ST_SLOTS.filter(s=>!this.en.some(e=>e.alive&&Math.abs(e.x-s.x)<0.08&&Math.abs(e.y-s.y)<0.08));
    if(!free.length)return;const s=free[Math.floor(Math.random()*free.length)];
    this.en.push({x:s.x,y:s.y,bx:s.x,by:s.y,dir:Math.random()>0.5?1:-1,
      range:0.02+Math.random()*0.02,spd:this.eSpd*(0.7+Math.random()*0.6),
      alive:true,t:0,life:8000+Math.random()*5000+this.wav*1000,
      shootCD:Math.max(400,1200-this.wav*80)+Math.random()*1000,flash:0});
    if(Math.random()<0.3)StarTrekSFX.play('decloak');},

  shoot(){if(this.st!=='playing')return;StarTrekSFX.play('shoot');
    let closest=null,closestD=Infinity;
    for(const e of this.en){if(!e.alive)continue;
      const dx=this.crossX-e.x,dy=this.crossY-e.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<0.12&&d<closestD){closest=e;closestD=d;}}
    const aimX=closest?closest.x:this.crossX,aimY=closest?closest.y:this.crossY;
    [[-0.015,-0.02],[0.015,-0.02]].forEach(([ox,oy],i)=>{
      const sx=0.5+ox,sy=0.82+oy,dx=aimX-sx,dy=aimY-sy;
      const dist=Math.sqrt(dx*dx+dy*dy)||0.001,spd=2.2;
      setTimeout(()=>{this.pBolts.push({x:sx,y:sy,vx:(dx/dist)*spd,vy:(dy/dist)*spd});},i*40);});
    if(closest){closest.alive=false;this.sc+=100*this.wav;this.killed++;StarTrekSFX.play('hit');
      this.ex.push({x:closest.x,y:closest.y,progress:0});
      for(let i=0;i<18;i++){const isF=Math.random()>0.3,isS=Math.random()>0.7;
        this.par.push({x:closest.x,y:closest.y,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,
          rad:isS?0.001+Math.random()*0.002:0.003+Math.random()*0.005,alpha:1,life:0.5+Math.random()*0.6,
          r2:isF?100:(isS?255:200),g2:isF?255:(isS?255:200),b2:isF?100:(isS?150:200)});}
      this.hitFlash=6;}
    this.updHUD();},

  takeDmg(){this.liv--;StarTrekSFX.play('damage');this.hitFlash=12;this.updHUD();
    if(this.liv<=0){this.st='gameover';StarTrekSFX.play('gameover');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#f44">EARTH HAS FALLEN</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:20px;color:#8cf">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="st-btn" onclick="StarTrekGame.restart()">PLAY AGAIN</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');}},

  restart(){hideMsg();this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.pBolts=[];this.eBolts=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.hitFlash=0;
    this.earthSize=0;this.starSpeed=0.5;this.vicTimer=0;
    this.stars=[];for(let i=0;i<200;i++)this.stars.push({x:Math.random(),y:Math.random(),z:Math.random(),size:0.5+Math.random()*2});
    StarTrekSFX.init();this.updHUD();this.startCD();},

  nextWave(){if(this.wav>=this.MAX_W){this.st='victory';this.vicTimer=0;StarTrekSFX.play('victory');return;}
    this.wav++;this.updHUD();this.startCD();},

  updateCD(dt){this.cdTimer+=dt*1000;
    if(this.cdTimer>=this.CD_DUR[this.cdPhase]){this.cdTimer=0;this.cdPhase++;
      if(this.cdPhase>=2&&this.cdPhase<=4)StarTrekSFX.play('countdown');
      if(this.cdPhase===5)StarTrekSFX.play('go');
      if(this.cdPhase>=this.CD_DUR.length){this.st='playing';}}},

  update(dt){
    if(this.hitFlash>0)this.hitFlash--;
    if(this.st==='countdown'){this.updateCD(dt);return;}
    if(this.st!=='playing')return;
    const cs=0.5;
    if(this.stKeys['ArrowLeft']||this.stKeys['a'])this.crossX-=cs*dt;
    if(this.stKeys['ArrowRight']||this.stKeys['d'])this.crossX+=cs*dt;
    if(this.stKeys['ArrowUp']||this.stKeys['w'])this.crossY-=cs*dt;
    if(this.stKeys['ArrowDown']||this.stKeys['s'])this.crossY+=cs*dt;
    this.crossX=Math.max(0,Math.min(1,this.crossX));
    this.crossY=Math.max(0,Math.min(0.8,this.crossY));
    this.spT+=dt*1000;
    if(this.spT>=this.spInt&&this.en.filter(e=>e.alive).length<this.maxOn){this.spawnE();this.spT=0;}
    this.en.forEach(e=>{if(!e.alive)return;e.t+=dt*1000;
      e.x=e.bx+Math.sin(e.t*0.0015*e.spd)*e.range*e.dir;
      e.y=e.by+Math.sin(e.t*0.001*e.spd)*0.015;
      e.x=Math.max(0.05,Math.min(0.95,e.x));e.y=Math.max(0.05,Math.min(0.7,e.y));
      e.shootCD-=dt*1000;
      if(e.shootCD<=0){e.flash=150;
        e.shootCD=Math.max(800,1800-this.wav*120)+Math.random()*1200;
        const dx=0.5-e.x+(Math.random()-0.5)*0.15,dy=0.85-e.y;
        const dist=Math.sqrt(dx*dx+dy*dy),bs=0.45+this.wav*0.03;
        this.eBolts.push({x:e.x,y:e.y+0.03,vx:(dx/dist)*bs,vy:(dy/dist)*bs});}
      if(e.flash>0)e.flash-=dt*1000;
      if(e.t>e.life)e.alive=false;});
    this.en=this.en.filter(e=>e.alive);
    this.pBolts=this.pBolts.filter(b=>{b.x+=b.vx*dt;b.y+=b.vy*dt;
      return b.y>-0.05&&b.y<1.05&&b.x>-0.05&&b.x<1.05;});
    this.eBolts=this.eBolts.filter(b=>{b.x+=(b.vx||0)*dt;b.y+=(b.vy||0)*dt;
      if(Math.abs(b.x-0.5)<0.04&&Math.abs(b.y-0.85)<0.035){this.takeDmg();return false;}
      return b.y<1.05&&b.y>-0.05&&b.x>-0.05&&b.x<1.05;});
    this.ex.forEach(e=>e.progress+=dt*1.5);this.ex=this.ex.filter(e=>e.progress<1);
    this.par.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.alpha-=dt*1.8;p.life-=dt;});
    this.par=this.par.filter(p=>p.life>0&&p.alpha>0);
    if(this.killed>=this.waveTarget)this.nextWave();
    const dx=this.crossX-0.5,dy=this.crossY-0.85;
    const ta=Math.max(-0.7,Math.min(0.7,Math.atan2(dx,-dy)*0.5));
    this.pAngle+=(ta-this.pAngle)*Math.min(1,dt*8);},

  drawStars(dt){const speed=(this.st==='playing'?this.starSpeed:0.15);
    this.stars.forEach(s=>{s.y+=speed*s.z*dt;
      if(s.y>1.05){s.y=-0.02;s.x=Math.random();s.z=Math.random();}
      const br=0.3+s.z*0.7,fl=0.8+Math.sin(Date.now()*0.01*s.z+s.x*100)*0.2;
      const sz=s.size*(0.5+s.z*0.5);
      ctx.fillStyle='rgba(200,220,255,'+(br*fl)+')';
      ctx.beginPath();ctx.arc(s.x*W,s.y*H,sz,0,Math.PI*2);ctx.fill();});},

  drawEarth(){if(this.earthSize<=0)return;
    const cx=W*0.5,cy=H+this.earthSize*0.15,r=this.earthSize;
    const og=ctx.createRadialGradient(cx-r*0.2,cy-r*0.3,r*0.1,cx,cy,r);
    og.addColorStop(0,'#2855a8');og.addColorStop(0.5,'#1a3d7a');og.addColorStop(1,'#0a1a3a');
    ctx.fillStyle=og;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(40,120,50,0.5)';
    [{x:-0.15,y:-0.25,rx:0.2,ry:0.15},{x:0.1,y:-0.1,rx:0.12,ry:0.18},{x:-0.25,y:0.05,rx:0.1,ry:0.08},
     {x:0.2,y:-0.35,rx:0.08,ry:0.12},{x:-0.05,y:-0.4,rx:0.15,ry:0.06},{x:0.25,y:0.1,rx:0.06,ry:0.1}].forEach(c=>{
      ctx.beginPath();ctx.ellipse(cx+c.x*r,cy+c.y*r,c.rx*r,c.ry*r,0.3,0,Math.PI*2);ctx.fill();});
    ctx.fillStyle='rgba(200,220,255,0.12)';
    for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+Date.now()*0.00003,cr=r*(0.3+(i%3)*0.15);
      ctx.beginPath();ctx.ellipse(cx+Math.cos(a)*cr,cy+Math.sin(a)*cr*0.5,r*0.12,r*0.03,a,0,Math.PI*2);ctx.fill();}
    ctx.strokeStyle='rgba(100,180,255,0.25)';ctx.lineWidth=r*0.04;
    ctx.beginPath();ctx.arc(cx,cy,r+r*0.02,0,Math.PI*2);ctx.stroke();
    const sg=ctx.createRadialGradient(cx-r*0.3,cy-r*0.4,0,cx-r*0.3,cy-r*0.4,r*0.6);
    sg.addColorStop(0,'rgba(200,230,255,0.15)');sg.addColorStop(1,'transparent');
    ctx.fillStyle=sg;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
    if(this.wav>=7){const pa=(0.1+Math.sin(Date.now()*0.005)*0.05)*(this.wav-6);
      ctx.strokeStyle='rgba(255,80,80,'+Math.min(pa,0.3)+')';ctx.lineWidth=3;
      ctx.beginPath();ctx.arc(cx,cy,r+r*0.06,0,Math.PI*2);ctx.stroke();}},

  drawEnterprise(cx,cy,size,angle){
    const x=cx*W,y=cy*H,s=size*Math.min(W,H);
    ctx.save();ctx.translate(x,y);if(angle)ctx.rotate(angle);
    ctx.strokeStyle='#889';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(-s*0.06,s*0.12);ctx.lineTo(-s*0.28,s*0.22);ctx.stroke();
    ctx.beginPath();ctx.moveTo(s*0.06,s*0.12);ctx.lineTo(s*0.28,s*0.22);ctx.stroke();
    ctx.fillStyle='#667';ctx.beginPath();
    ctx.moveTo(-s*0.25,s*0.1);ctx.lineTo(-s*0.23,s*0.08);ctx.lineTo(-s*0.23,s*0.32);ctx.lineTo(-s*0.25,s*0.34);
    ctx.lineTo(-s*0.32,s*0.34);ctx.lineTo(-s*0.34,s*0.32);ctx.lineTo(-s*0.34,s*0.08);ctx.lineTo(-s*0.32,s*0.06);
    ctx.closePath();ctx.fill();ctx.strokeStyle='#99a';ctx.lineWidth=1;ctx.stroke();
    ctx.fillStyle='#667';ctx.beginPath();
    ctx.moveTo(s*0.25,s*0.1);ctx.lineTo(s*0.23,s*0.08);ctx.lineTo(s*0.23,s*0.32);ctx.lineTo(s*0.25,s*0.34);
    ctx.lineTo(s*0.32,s*0.34);ctx.lineTo(s*0.34,s*0.32);ctx.lineTo(s*0.34,s*0.08);ctx.lineTo(s*0.32,s*0.06);
    ctx.closePath();ctx.fill();ctx.strokeStyle='#99a';ctx.stroke();
    ctx.fillStyle='#c44';ctx.beginPath();ctx.arc(-s*0.285,s*0.08,s*0.05,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f66';ctx.beginPath();ctx.arc(-s*0.285,s*0.075,s*0.025,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#c44';ctx.beginPath();ctx.arc(s*0.285,s*0.08,s*0.05,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f66';ctx.beginPath();ctx.arc(s*0.285,s*0.075,s*0.025,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(100,180,255,0.8)';ctx.shadowColor='#4af';ctx.shadowBlur=6;ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(-s*0.285,s*0.12);ctx.lineTo(-s*0.285,s*0.30);ctx.stroke();
    ctx.beginPath();ctx.moveTo(s*0.285,s*0.12);ctx.lineTo(s*0.285,s*0.30);ctx.stroke();ctx.shadowBlur=0;
    ctx.fillStyle='#889';ctx.beginPath();
    ctx.moveTo(-s*0.045,-s*0.05);ctx.lineTo(s*0.045,-s*0.05);ctx.lineTo(s*0.05,s*0.28);
    ctx.lineTo(s*0.035,s*0.34);ctx.lineTo(-s*0.035,s*0.34);ctx.lineTo(-s*0.05,s*0.28);
    ctx.closePath();ctx.fill();ctx.strokeStyle='#aab';ctx.lineWidth=1;ctx.stroke();
    ctx.fillStyle='#48c';ctx.beginPath();ctx.arc(0,s*0.33,s*0.025,0,Math.PI*2);ctx.fill();
    ctx.shadowColor='#4af';ctx.shadowBlur=6;ctx.fillStyle='rgba(80,160,255,0.6)';
    ctx.beginPath();ctx.arc(0,s*0.33,s*0.04,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle='#99a';ctx.fillRect(-s*0.025,-s*0.22,s*0.05,s*0.2);
    ctx.fillStyle='#556';ctx.beginPath();ctx.ellipse(s*0.01,-s*0.30+s*0.015,s*0.2,s*0.07,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#99a';ctx.beginPath();ctx.ellipse(0,-s*0.30,s*0.2,s*0.07,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#bbc';ctx.lineWidth=1;ctx.stroke();
    ctx.strokeStyle='rgba(180,190,200,0.4)';ctx.lineWidth=0.5;
    ctx.beginPath();ctx.ellipse(0,-s*0.30,s*0.14,s*0.05,0,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.ellipse(0,-s*0.30,s*0.08,s*0.03,0,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='#aab';ctx.beginPath();ctx.ellipse(0,-s*0.31,s*0.04,s*0.015,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ccd';ctx.beginPath();ctx.ellipse(0,-s*0.315,s*0.02,s*0.008,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,200,100,0.5)';ctx.lineWidth=1;
    ctx.beginPath();ctx.ellipse(0,-s*0.30,s*0.19,s*0.065,0,-0.3,0.3);ctx.stroke();
    ctx.beginPath();ctx.ellipse(0,-s*0.30,s*0.19,s*0.065,0,Math.PI-0.3,Math.PI+0.3);ctx.stroke();
    [-s*0.285,s*0.285].forEach(ex=>{
      ctx.fillStyle='rgba(100,180,255,0.8)';ctx.beginPath();ctx.ellipse(ex,s*0.35,s*0.02,s*0.03,0,0,Math.PI*2);ctx.fill();
      const eg=ctx.createRadialGradient(ex,s*0.36,0,ex,s*0.36,s*0.08);
      eg.addColorStop(0,'rgba(100,180,255,0.4)');eg.addColorStop(1,'transparent');
      ctx.fillStyle=eg;ctx.beginPath();ctx.arc(ex,s*0.36,s*0.08,0,Math.PI*2);ctx.fill();});
    ctx.restore();},

  drawBirdOfPrey(cx,cy,size,flash){
    const x=cx*W,y=cy*H,s=size*Math.min(W,H);
    ctx.fillStyle=flash?'rgba(100,255,100,0.2)':'#3a4a3a';ctx.strokeStyle=flash?'#8f8':'#5a6a5a';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(x-s*0.08,y-s*0.02);ctx.lineTo(x-s*0.4,y-s*0.3);ctx.lineTo(x-s*0.42,y-s*0.25);
    ctx.lineTo(x-s*0.38,y-s*0.2);ctx.lineTo(x-s*0.1,y+s*0.05);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.beginPath();ctx.moveTo(x+s*0.08,y-s*0.02);ctx.lineTo(x+s*0.4,y-s*0.3);ctx.lineTo(x+s*0.42,y-s*0.25);
    ctx.lineTo(x+s*0.38,y-s*0.2);ctx.lineTo(x+s*0.1,y+s*0.05);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.fillStyle=flash?'#ff8':'#4a4';ctx.shadowColor='#0f0';ctx.shadowBlur=flash?8:3;
    ctx.beginPath();ctx.arc(x-s*0.41,y-s*0.27,s*0.025,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(x+s*0.41,y-s*0.27,s*0.025,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle=flash?'#6a7a6a':'#4a5a4a';ctx.beginPath();
    ctx.moveTo(x,y-s*0.15);ctx.lineTo(x+s*0.06,y);ctx.lineTo(x+s*0.05,y+s*0.2);
    ctx.lineTo(x-s*0.05,y+s*0.2);ctx.lineTo(x-s*0.06,y);ctx.closePath();ctx.fill();
    ctx.strokeStyle=flash?'#8f8':'#6a7a6a';ctx.stroke();
    ctx.fillStyle=flash?'#7a8a7a':'#5a6a5a';ctx.beginPath();
    ctx.moveTo(x,y-s*0.35);ctx.lineTo(x+s*0.06,y-s*0.15);ctx.lineTo(x+s*0.04,y-s*0.08);
    ctx.lineTo(x-s*0.04,y-s*0.08);ctx.lineTo(x-s*0.06,y-s*0.15);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.fillStyle=flash?'#bfb':'#2a3a2a';ctx.beginPath();ctx.ellipse(x,y-s*0.2,s*0.025,s*0.04,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(80,200,80,0.7)';ctx.beginPath();ctx.ellipse(x,y+s*0.22,s*0.025,s*0.03,0,0,Math.PI*2);ctx.fill();
    const eg=ctx.createRadialGradient(x,y+s*0.22,0,x,y+s*0.22,s*0.06);
    eg.addColorStop(0,'rgba(80,200,80,0.3)');eg.addColorStop(1,'transparent');
    ctx.fillStyle=eg;ctx.beginPath();ctx.arc(x,y+s*0.22,s*0.06,0,Math.PI*2);ctx.fill();},

  drawPhaserBolt(b){const x=b.x*W,y=b.y*H,angle=Math.atan2(b.vy,b.vx);
    const grad=ctx.createRadialGradient(x,y,0,x,y,10);
    grad.addColorStop(0,'rgba(255,180,50,0.7)');grad.addColorStop(1,'transparent');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(x,y,10,0,Math.PI*2);ctx.fill();
    ctx.save();ctx.translate(x,y);ctx.rotate(angle-Math.PI/2);
    ctx.fillStyle='#fc8';ctx.shadowColor='#fa0';ctx.shadowBlur=8;ctx.fillRect(-2,-10,4,20);
    ctx.shadowBlur=0;ctx.restore();},

  drawDisruptorBolt(b){const x=b.x*W,y=b.y*H,angle=Math.atan2(b.vy,b.vx);
    const grad=ctx.createRadialGradient(x,y,0,x,y,8);
    grad.addColorStop(0,'rgba(80,255,80,0.6)');grad.addColorStop(1,'transparent');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(x,y,8,0,Math.PI*2);ctx.fill();
    ctx.save();ctx.translate(x,y);ctx.rotate(angle-Math.PI/2);
    ctx.fillStyle='#4f4';ctx.shadowColor='#0f0';ctx.shadowBlur=6;ctx.fillRect(-1.5,-8,3,16);
    ctx.shadowBlur=0;ctx.restore();},

  drawExplosion(ex){const x=ex.x*W,y=ex.y*H,p=ex.progress,r=(30+p*80)*(Math.min(W,H)/600);
    for(let ring=0;ring<3;ring++){const rp=Math.min(1,p+ring*0.08),ringR=r*(0.6+ring*0.3)*rp;
      const alpha=Math.max(0,(1-rp*1.3)*0.7);
      const colors=['rgba(100,255,100,','rgba(255,220,80,','rgba(255,130,30,'];
      ctx.strokeStyle=colors[ring]+alpha+')';ctx.lineWidth=3-ring;
      ctx.beginPath();ctx.arc(x,y,ringR,0,Math.PI*2);ctx.stroke();}
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2+p*5,ri=r*0.05,ro=r*(0.3+p*0.7);
      const alpha=Math.max(0,1-p*1.5);
      ctx.strokeStyle=i%3===0?'rgba(150,255,150,'+alpha+')':i%3===1?'rgba(255,220,80,'+alpha+')':'rgba(255,150,50,'+alpha+')';
      ctx.lineWidth=2.5-p*1.5;ctx.beginPath();
      ctx.moveTo(x+Math.cos(a)*ri,y+Math.sin(a)*ri);ctx.lineTo(x+Math.cos(a)*ro,y+Math.sin(a)*ro);ctx.stroke();}
    if(p<0.35){const fa=1-p/0.35;
      const glow=ctx.createRadialGradient(x,y,0,x,y,r*0.4*(1-p));
      glow.addColorStop(0,'rgba(200,255,200,'+fa+')');glow.addColorStop(0.3,'rgba(100,255,100,'+(fa*0.8)+')');
      glow.addColorStop(0.7,'rgba(255,200,50,'+(fa*0.4)+')');glow.addColorStop(1,'transparent');
      ctx.fillStyle=glow;ctx.beginPath();ctx.arc(x,y,r*0.4*(1-p),0,Math.PI*2);ctx.fill();}
    if(p<0.6){const ga=(0.6-p)*0.4;
      const ag=ctx.createRadialGradient(x,y,0,x,y,r*1.2);
      ag.addColorStop(0,'rgba(100,255,100,'+ga+')');ag.addColorStop(1,'transparent');
      ctx.fillStyle=ag;ctx.beginPath();ctx.arc(x,y,r*1.2,0,Math.PI*2);ctx.fill();}},

  drawCross(){const x=this.crossX*W,y=this.crossY*H,r=18*(Math.min(W,H)/600),ext=8*(Math.min(W,H)/600);
    ctx.strokeStyle='rgba(255,180,80,0.6)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x-r-ext,y);ctx.lineTo(x-r+4,y);ctx.moveTo(x+r-4,y);ctx.lineTo(x+r+ext,y);
    ctx.moveTo(x,y-r-ext);ctx.lineTo(x,y-r+4);ctx.moveTo(x,y+r-4);ctx.lineTo(x,y+r+ext);ctx.stroke();
    ctx.fillStyle='rgba(255,180,80,0.8)';ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fill();},

  drawCD(){const cx=W/2,cy=H/2;
    ctx.fillStyle='#8cf';ctx.font=Math.min(W,H)*0.025+'px "Press Start 2P"';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='rgba(100,180,255,0.4)';ctx.shadowBlur=10;
    ctx.fillText('WAVE '+this.wav+' OF '+this.MAX_W,cx,cy-Math.min(W,H)*0.08);
    const txt=this.CD_TXT[this.cdPhase];
    if(txt){const isNum=['3','2','1'].includes(txt),isGo=txt==='ENGAGE!';
      const fs=isNum?0.1:(isGo?0.05:0.025);
      const phase=this.cdTimer/this.CD_DUR[this.cdPhase];
      const sc=isNum?1+Math.sin(phase*Math.PI)*0.15:1;
      const al=isGo?Math.max(0,1-phase*2):1;
      ctx.save();ctx.translate(cx,cy+Math.min(W,H)*0.02);ctx.scale(sc,sc);ctx.globalAlpha=al;
      ctx.fillStyle=isGo?'#fc6':(txt==='RED ALERT'?'#f44':'#fc6');
      ctx.font=Math.min(W,H)*fs+'px "Press Start 2P"';ctx.fillText(txt,0,0);
      ctx.restore();ctx.globalAlpha=1;}
    ctx.shadowBlur=0;},

  drawVictory(dt){this.vicTimer+=dt;
    const cx=W/2,cy=H*0.4,t=this.vicTimer,baseR=Math.min(W,H)*0.18,er=baseR*Math.min(1,t*0.5);
    const og=ctx.createRadialGradient(cx-er*0.2,cy-er*0.3,er*0.1,cx,cy,er);
    og.addColorStop(0,'#3870c8');og.addColorStop(0.5,'#2050a0');og.addColorStop(1,'#102050');
    ctx.fillStyle=og;ctx.beginPath();ctx.arc(cx,cy,er,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(50,150,60,0.5)';
    [[-0.15,-0.25,0.2,0.15],[0.1,-0.1,0.12,0.18],[-0.25,0.05,0.1,0.08],[0.2,-0.35,0.08,0.12]].forEach(([ox,oy,rx,ry])=>{
      ctx.beginPath();ctx.ellipse(cx+ox*er,cy+oy*er,rx*er,ry*er,0.3,0,Math.PI*2);ctx.fill();});
    if(t>1){const aA=Math.min(0.3,(t-1)*0.1);
      const ag=ctx.createRadialGradient(cx,cy,er,cx,cy,er*1.4);
      ag.addColorStop(0,'rgba(100,180,255,'+aA+')');ag.addColorStop(1,'transparent');
      ctx.fillStyle=ag;ctx.beginPath();ctx.arc(cx,cy,er*1.4,0,Math.PI*2);ctx.fill();}
    if(t>2){const ta2=Math.min(1,(t-2)/1);ctx.globalAlpha=ta2;
      const pulse=1+Math.sin(t*4)*0.04;
      ctx.save();ctx.translate(cx,cy+baseR*1.4);ctx.scale(pulse,pulse);
      ctx.fillStyle='#8cf';ctx.shadowColor='rgba(100,180,255,0.6)';ctx.shadowBlur=15;
      ctx.font=Math.min(W,H)*0.04+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('EARTH IS SAVED',0,0);ctx.restore();
      ctx.fillStyle='#fc6';ctx.shadowBlur=0;ctx.font=Math.min(W,H)*0.02+'px "Press Start 2P"';ctx.textAlign='center';
      ctx.fillText('THE KLINGON FLEET IS DESTROYED',cx,cy+baseR*1.8);
      ctx.fillStyle='#8cf';ctx.font=Math.min(W,H)*0.018+'px "Press Start 2P"';
      ctx.fillText('FINAL SCORE: '+String(this.sc).padStart(5,'0'),cx,cy+baseR*2.2);
      ctx.fillStyle='#adf';ctx.font=Math.min(W,H)*0.012+'px "Press Start 2P"';
      ctx.fillText('LIVE LONG AND PROSPER',cx,cy+baseR*2.6);
      if(t>3.5&&Math.floor(t*2)%2===0){ctx.fillStyle='#fc6';ctx.font=Math.min(W,H)*0.011+'px "Press Start 2P"';
        ctx.fillText('PRESS ENTER OR CLICK TO PLAY AGAIN',cx,cy+baseR*3.1);}
      ctx.globalAlpha=1;}},

  draw(dt){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);this.drawStars(dt);
    if(this.hitFlash>0){ctx.fillStyle='rgba(0,255,80,0.12)';ctx.fillRect(0,0,W,H);}
    if(this.st==='victory'){this.drawVictory(dt);return;}
    this.drawEarth();
    if(this.st==='countdown'){this.drawEnterprise(0.5,0.85,0.065,0);this.drawCD();return;}
    if(this.st==='gameover'){this.drawEnterprise(0.5,0.85,0.065,0);return;}
    this.eBolts.forEach(b=>this.drawDisruptorBolt(b));
    this.pBolts.forEach(b=>this.drawPhaserBolt(b));
    this.en.forEach(e=>{if(!e.alive)return;this.drawBirdOfPrey(e.x,e.y,0.05,e.flash>80);});
    this.ex.forEach(e=>this.drawExplosion(e));
    this.par.forEach(p=>{ctx.fillStyle='rgba('+p.r2+','+p.g2+','+p.b2+','+p.alpha+')';
      ctx.beginPath();ctx.arc(p.x*W,p.y*H,p.rad*Math.min(W,H),0,Math.PI*2);ctx.fill();});
    this.drawEnterprise(0.5,0.85,0.065,this.pAngle);
    if(this.st==='playing')this.drawCross();}
};

// ==================== TRENCH RUN ====================
const TR_SLOTS=[];
(function(){for(let r=0;r<5;r++){const y=0.14+r*0.11,cols=r%2===0?4:3;
  for(let c=0;c<cols;c++){const x=r%2===0?0.22+c*0.187:0.30+c*0.20;TR_SLOTS.push({x,y});}}})();

const TrenchRunSFX={ctx:null,
  init(){if(this.ctx)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}},
  play(type){if(!this.ctx)return;const t=this.ctx.currentTime,osc=()=>this.ctx.createOscillator(),gn=()=>this.ctx.createGain();
    if(type==='shoot'){[0,0.03,0.06,0.09].forEach(d=>{const o=osc(),g=gn();o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(1200,t+d);o.frequency.exponentialRampToValueAtTime(400,t+d+0.06);g.gain.setValueAtTime(0.06,t+d);g.gain.exponentialRampToValueAtTime(0.001,t+d+0.06);o.start(t+d);o.stop(t+d+0.06);});}
    else if(type==='hit'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.4,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.2);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.18,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);src.start(t);const o=osc(),g2=gn();o.type='sine';o.connect(g2);g2.connect(this.ctx.destination);o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(30,t+0.3);g2.gain.setValueAtTime(0.12,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.3);o.start(t);o.stop(t+0.3);}
    else if(type==='damage'){const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+0.4);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);}
    else if(type==='gameover'){[200,170,140,100,70].forEach((f,i)=>{const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.25);g.gain.setValueAtTime(0.08,t+i*0.25);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.25+0.24);o.start(t+i*0.25);o.stop(t+i*0.25+0.25);});}
    else if(type==='countdown'){const o=osc(),g=gn();o.type='sine';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(600,t);g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);}
    else if(type==='go'){const o=osc(),g=gn();o.type='sine';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(1000,t);g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);o.start(t);o.stop(t+0.15);}
    else if(type==='victory'){[523,659,784,1047,784,1047,1319].forEach((f,i)=>{const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.18);g.gain.setValueAtTime(0.08,t+i*0.18);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.18+0.17);o.start(t+i*0.18);o.stop(t+i*0.18+0.18);});}
    else if(type==='tiefly'){const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(800+Math.random()*400,t);o.frequency.exponentialRampToValueAtTime(200,t+0.15);g.gain.setValueAtTime(0.03,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);o.start(t);o.stop(t+0.15);}}
};

const TrenchRunGame={
  en:[],ex:[],pBolts:[],eBolts:[],par:[],crossX:0.5,crossY:0.4,
  sc:0,liv:3,wav:1,st:'idle',
  spT:0,killed:0,waveTarget:5,eSpd:0.3,spInt:2200,maxOn:4,
  pAngle:0,cdPhase:0,cdTimer:0,vicTimer:0,trKeys:{},hitFlash:0,
  deathStarSize:0,starSpeed:0.5,stars:[],
  MAX_W:9,CD_DUR:[1200,900,700,700,700,500],CD_TXT:['','READY','3','2','1','GO!'],

  init(){activeGame='trenchrun';hideMsg();showEl('exitBtn');hideEl('input-panel');
    canvas.style.cursor='crosshair';
    $('scoreboard').className='trenchrun-mode';showEl('scoreboard');
    $('p1Label').textContent='SCR';$('p2Label').textContent='LIVES';
    $('gameTitle').textContent='TRENCH RUN';$('gameTitle').style.color='#FFE81F';
    $('subLabel').textContent='Destroy the Death Star';
    this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.pBolts=[];this.eBolts=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.hitFlash=0;
    this.deathStarSize=0;this.starSpeed=0.5;
    this.stars=[];for(let i=0;i<200;i++)this.stars.push({x:Math.random(),y:Math.random(),z:Math.random(),sz:0.5+Math.random()*2});
    TrenchRunSFX.init();this.updHUD();this.startCD();gamePhase='trenchrun';},

  updHUD(){$('score1').textContent=String(this.sc).padStart(5,'0');
    $('subLabel').textContent='WAVE '+this.wav+'/'+this.MAX_W;
    let lv='';for(let i=0;i<this.liv;i++)lv+='\u2708';$('score2').textContent=lv;},

  getWC(w){return{target:5+w*2,speed:0.3+w*0.06,spInt:Math.max(1200-w*100,350),maxOn:Math.min(3+w,12)};},

  startCD(){this.st='countdown';this.cdPhase=0;this.cdTimer=0;
    this.en=[];this.ex=[];this.pBolts=[];this.eBolts=[];this.par=[];
    const c=this.getWC(this.wav);this.waveTarget=c.target;this.eSpd=c.speed;this.spInt=c.spInt;this.maxOn=c.maxOn;
    this.killed=0;this.spT=0;
    this.deathStarSize=Math.min(W,H)*(0.05+this.wav*0.04);
    this.starSpeed=0.3+this.wav*0.08;},

  spawnE(){const free=TR_SLOTS.filter(s=>!this.en.some(e=>e.alive&&Math.abs(e.x-s.x)<0.08&&Math.abs(e.y-s.y)<0.08));
    if(!free.length)return;const s=free[Math.floor(Math.random()*free.length)];
    this.en.push({x:s.x,y:s.y,bx:s.x,by:s.y,dir:Math.random()>0.5?1:-1,
      range:0.02+Math.random()*0.02,spd:this.eSpd*(0.7+Math.random()*0.6),
      alive:true,t:0,life:8000+Math.random()*5000+this.wav*1000,
      shootCD:Math.max(400,1200-this.wav*80)+Math.random()*1000,flash:0});
    if(Math.random()<0.3)TrenchRunSFX.play('tiefly');},

  shoot(){if(this.st!=='playing')return;TrenchRunSFX.play('shoot');
    let closest=null,closestD=Infinity;
    for(const e of this.en){if(!e.alive)continue;
      const dx=this.crossX-e.x,dy=this.crossY-e.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<0.12&&d<closestD){closest=e;closestD=d;}}
    const aimX=closest?closest.x:this.crossX,aimY=closest?closest.y:this.crossY;
    const wOff=[[-0.025,0],[0.025,0],[-0.018,0.01],[0.018,0.01]];
    wOff.forEach(([ox,oy],i)=>{const sx=0.5+ox,sy=0.82+oy,dx=aimX-sx,dy=aimY-sy,dist=Math.sqrt(dx*dx+dy*dy)||0.001,spd=2.2;
      setTimeout(()=>{this.pBolts.push({x:sx,y:sy,vx:(dx/dist)*spd,vy:(dy/dist)*spd});},i*30);});
    if(closest){closest.alive=false;this.sc+=100*this.wav;this.killed++;TrenchRunSFX.play('hit');
      this.ex.push({x:closest.x,y:closest.y,progress:0});
      for(let i=0;i<18;i++){const isF=Math.random()>0.3,isS=Math.random()>0.7;
        this.par.push({x:closest.x,y:closest.y,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,
          rad:isS?0.001+Math.random()*0.002:0.003+Math.random()*0.005,alpha:1,life:0.5+Math.random()*0.6,
          r2:isF?255:(isS?255:200),g2:isF?Math.floor(80+Math.random()*120):(isS?255:200),b2:isF?20:(isS?150:200)});}
      this.hitFlash=6;}
    this.updHUD();},

  takeDmg(){this.liv--;TrenchRunSFX.play('damage');this.hitFlash=12;this.updHUD();
    if(this.liv<=0){this.st='gameover';TrenchRunSFX.play('gameover');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#f44">MISSION FAILED</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:20px;color:#FFE81F">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="tr-btn" onclick="TrenchRunGame.restart()">PLAY AGAIN</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');}},

  restart(){hideMsg();this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.pBolts=[];this.eBolts=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.hitFlash=0;
    this.deathStarSize=0;this.starSpeed=0.5;
    this.stars=[];for(let i=0;i<200;i++)this.stars.push({x:Math.random(),y:Math.random(),z:Math.random(),sz:0.5+Math.random()*2});
    TrenchRunSFX.init();this.updHUD();this.startCD();},

  nextWave(){if(this.wav>=this.MAX_W){this.st='victory';this.vicTimer=0;TrenchRunSFX.play('victory');return;}
    this.wav++;this.updHUD();this.startCD();},

  updateCD(dt){this.cdTimer+=dt*1000;
    if(this.cdTimer>=this.CD_DUR[this.cdPhase]){this.cdTimer=0;this.cdPhase++;
      if(this.cdPhase>=2&&this.cdPhase<=4)TrenchRunSFX.play('countdown');
      if(this.cdPhase===5)TrenchRunSFX.play('go');
      if(this.cdPhase>=this.CD_DUR.length){this.st='playing';}}},

  update(dt){
    if(this.hitFlash>0)this.hitFlash--;
    if(this.st==='countdown'){this.updateCD(dt);return;}
    if(this.st!=='playing')return;
    const cs=0.5;
    if(this.trKeys['ArrowLeft']||this.trKeys['a'])this.crossX-=cs*dt;
    if(this.trKeys['ArrowRight']||this.trKeys['d'])this.crossX+=cs*dt;
    if(this.trKeys['ArrowUp']||this.trKeys['w'])this.crossY-=cs*dt;
    if(this.trKeys['ArrowDown']||this.trKeys['s'])this.crossY+=cs*dt;
    this.crossX=Math.max(0,Math.min(1,this.crossX));
    this.crossY=Math.max(0,Math.min(0.8,this.crossY));
    this.spT+=dt*1000;
    if(this.spT>=this.spInt&&this.en.filter(e=>e.alive).length<this.maxOn){this.spawnE();this.spT=0;}
    this.en.forEach(e=>{if(!e.alive)return;e.t+=dt*1000;
      e.x=e.bx+Math.sin(e.t*0.0015*e.spd)*e.range*e.dir;
      e.y=e.by+Math.sin(e.t*0.001*e.spd)*0.015;
      e.x=Math.max(0.05,Math.min(0.95,e.x));e.y=Math.max(0.05,Math.min(0.7,e.y));
      e.shootCD-=dt*1000;
      if(e.shootCD<=0){e.flash=150;
        e.shootCD=Math.max(800,1800-this.wav*120)+Math.random()*1200;
        const dx=0.5-e.x+(Math.random()-0.5)*0.15,dy=0.85-e.y;
        const dist=Math.sqrt(dx*dx+dy*dy),bs=0.45+this.wav*0.03;
        this.eBolts.push({x:e.x,y:e.y+0.03,vx:(dx/dist)*bs,vy:(dy/dist)*bs});}
      if(e.flash>0)e.flash-=dt*1000;
      if(e.t>e.life)e.alive=false;});
    this.en=this.en.filter(e=>e.alive);
    this.pBolts=this.pBolts.filter(b=>{b.x+=b.vx*dt;b.y+=b.vy*dt;
      return b.y>-0.05&&b.y<1.05&&b.x>-0.05&&b.x<1.05;});
    this.eBolts=this.eBolts.filter(b=>{b.x+=b.vx*dt;b.y+=b.vy*dt;
      if(Math.abs(b.x-0.5)<0.04&&Math.abs(b.y-0.85)<0.035){this.takeDmg();return false;}
      return b.y<1.05&&b.y>-0.05&&b.x>-0.05&&b.x<1.05;});
    this.ex.forEach(e=>e.progress+=dt*1.5);this.ex=this.ex.filter(e=>e.progress<1);
    this.par.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.alpha-=dt*1.8;p.life-=dt;});
    this.par=this.par.filter(p=>p.life>0&&p.alpha>0);
    if(this.killed>=this.waveTarget)this.nextWave();
    const dx=this.crossX-0.5,dy=this.crossY-0.85;
    const ta=Math.max(-0.7,Math.min(0.7,Math.atan2(dx,-dy)*0.5));
    this.pAngle+=(ta-this.pAngle)*Math.min(1,dt*8);},

  drawStars(dt){const spd=this.st==='playing'?this.starSpeed:0.2;
    this.stars.forEach(s=>{s.y+=spd*s.z*dt;
      if(s.y>1.05){s.y=-0.02;s.x=Math.random();s.z=Math.random();}
      const br=0.3+s.z*0.7,fl=0.8+Math.sin(Date.now()*0.01*s.z+s.x*100)*0.2,al=br*fl,sz=s.sz*(0.5+s.z*0.5);
      ctx.fillStyle='rgba(200,220,255,'+al+')';ctx.beginPath();ctx.arc(s.x*W,s.y*H,sz,0,Math.PI*2);ctx.fill();});},

  drawDeathStar(){if(this.deathStarSize<=0)return;
    const cx=W*0.5,cy=-this.deathStarSize*0.3,r=this.deathStarSize;
    ctx.strokeStyle='rgba(100,100,110,0.4)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='rgba(40,40,50,0.5)';ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();
    const dishY=cy+r*0.3;ctx.strokeStyle='rgba(100,100,110,0.5)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(cx-r*0.15,dishY,r*0.25,0,Math.PI*2);ctx.stroke();
    ctx.strokeStyle='rgba(80,80,90,0.4)';ctx.lineWidth=2;ctx.beginPath();ctx.ellipse(cx,cy,r,r*0.08,0,0,Math.PI*2);ctx.stroke();
    ctx.strokeStyle='rgba(70,70,80,0.3)';ctx.lineWidth=0.5;
    for(let i=1;i<6;i++){const ly=cy-r+(i*r*2/6),hw=Math.sqrt(Math.max(0,r*r-(ly-cy)*(ly-cy)));
      ctx.beginPath();ctx.moveTo(cx-hw,ly);ctx.lineTo(cx+hw,ly);ctx.stroke();}
    if(this.wav>=7){const ga=(this.wav-6)*0.04;
      const gr=ctx.createRadialGradient(cx-r*0.15,dishY,0,cx-r*0.15,dishY,r*0.4);
      gr.addColorStop(0,'rgba(100,255,100,'+ga+')');gr.addColorStop(1,'transparent');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(cx-r*0.15,dishY,r*0.4,0,Math.PI*2);ctx.fill();}},

  drawXWing(cx,cy,size,angle){const x=cx*W,y=cy*H,s=size*Math.min(W,H);
    ctx.save();ctx.translate(x,y);if(angle)ctx.rotate(angle);
    const shX=s*0.015,shY=s*0.06;
    ctx.fillStyle='#555';ctx.strokeStyle='#777';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(-s*0.35+shX,s*0.08+shY);ctx.lineTo(-s*0.35+shX,s*0.16+shY);
    ctx.lineTo(-s*0.10+shX,s*0.22+shY);ctx.lineTo(s*0.10+shX,s*0.22+shY);
    ctx.lineTo(s*0.35+shX,s*0.16+shY);ctx.lineTo(s*0.35+shX,s*0.08+shY);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.fillStyle='#999';ctx.strokeStyle='#bbb';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(-s*0.45,s*0.03);ctx.lineTo(-s*0.45,s*0.13);
    ctx.lineTo(-s*0.12,s*0.20);ctx.lineTo(s*0.12,s*0.20);
    ctx.lineTo(s*0.45,s*0.13);ctx.lineTo(s*0.45,s*0.03);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.strokeStyle='#cc2222';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,s*0.04);ctx.lineTo(0,s*0.19);ctx.stroke();
    ctx.fillStyle='#aaa';ctx.beginPath();ctx.moveTo(0,-s*0.5);ctx.lineTo(s*0.06,-s*0.08);
    ctx.lineTo(s*0.055,s*0.22);ctx.lineTo(s*0.03,s*0.28);ctx.lineTo(-s*0.03,s*0.28);
    ctx.lineTo(-s*0.055,s*0.22);ctx.lineTo(-s*0.06,-s*0.08);ctx.closePath();ctx.fill();
    ctx.strokeStyle='#ccc';ctx.stroke();
    ctx.fillStyle='#446';ctx.beginPath();ctx.ellipse(0,-s*0.14,s*0.03,s*0.07,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#4488dd';ctx.shadowColor='#4488ff';ctx.shadowBlur=3;
    ctx.beginPath();ctx.arc(0,-s*0.02,s*0.028,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#bbccdd';ctx.shadowBlur=0;ctx.beginPath();ctx.arc(0,-s*0.03,s*0.012,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#5f5';ctx.shadowColor='#0f0';ctx.shadowBlur=4;
    [[-0.45,0.03],[0.45,0.03],[-0.45,0.13],[0.45,0.13]].forEach(([px,py])=>{
      ctx.beginPath();ctx.arc(px*s,py*s,2.5,0,Math.PI*2);ctx.fill();});
    [[-0.35,0.14],[0.35,0.14],[-0.35,0.22],[0.35,0.22]].forEach(([px,py])=>{
      ctx.beginPath();ctx.arc(px*s+s*0.015,py*s+s*0.06,2.5,0,Math.PI*2);ctx.fill();});
    ctx.shadowBlur=0;
    const es=s*0.03;
    [-es,es].forEach(ex=>{ctx.fillStyle='#777';ctx.beginPath();ctx.ellipse(ex,s*0.28,s*0.02,s*0.025,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#999';ctx.lineWidth=1;ctx.stroke();
      ctx.fillStyle='rgba(255,80,30,0.95)';ctx.beginPath();ctx.ellipse(ex,s*0.31,s*0.015,s*0.035,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,200,100,0.9)';ctx.beginPath();ctx.ellipse(ex,s*0.30,s*0.008,s*0.02,0,0,Math.PI*2);ctx.fill();
      const eg=ctx.createRadialGradient(ex,s*0.32,0,ex,s*0.32,s*0.09);
      eg.addColorStop(0,'rgba(255,120,40,0.45)');eg.addColorStop(1,'transparent');
      ctx.fillStyle=eg;ctx.beginPath();ctx.arc(ex,s*0.32,s*0.09,0,Math.PI*2);ctx.fill();});
    ctx.restore();},

  drawTIE(cx,cy,size,flash){const x=cx*W,y=cy*H,s=size*Math.min(W,H);
    ctx.strokeStyle=flash?'#f88':'#667';ctx.fillStyle=flash?'rgba(255,100,100,0.15)':'rgba(50,50,60,0.6)';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(x-s*0.15,y-s*0.45);ctx.lineTo(x-s*0.35,y-s*0.35);
    ctx.lineTo(x-s*0.35,y+s*0.35);ctx.lineTo(x-s*0.15,y+s*0.45);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.beginPath();ctx.moveTo(x+s*0.15,y-s*0.45);ctx.lineTo(x+s*0.35,y-s*0.35);
    ctx.lineTo(x+s*0.35,y+s*0.35);ctx.lineTo(x+s*0.15,y+s*0.45);ctx.closePath();ctx.fill();ctx.stroke();
    ctx.strokeStyle=flash?'#faa':'#889';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(x-s*0.25,y-s*0.4);ctx.lineTo(x-s*0.25,y+s*0.4);ctx.stroke();
    ctx.beginPath();ctx.moveTo(x+s*0.25,y-s*0.4);ctx.lineTo(x+s*0.25,y+s*0.4);ctx.stroke();
    ctx.strokeStyle=flash?'#f88':'#778';ctx.lineWidth=2.5;
    ctx.beginPath();ctx.moveTo(x-s*0.12,y);ctx.lineTo(x-s*0.15,y);ctx.stroke();
    ctx.beginPath();ctx.moveTo(x+s*0.12,y);ctx.lineTo(x+s*0.15,y);ctx.stroke();
    ctx.fillStyle=flash?'#f66':'#556';ctx.beginPath();ctx.arc(x,y,s*0.12,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=flash?'#faa':'#889';ctx.lineWidth=1.5;ctx.stroke();
    ctx.fillStyle=flash?'#fcc':'#334';ctx.beginPath();ctx.arc(x,y,s*0.06,0,Math.PI*2);ctx.fill();},

  drawGreenBolt(b){const x=b.x*W,y=b.y*H,angle=Math.atan2(b.vy,b.vx);
    const gr=ctx.createRadialGradient(x,y,0,x,y,10);gr.addColorStop(0,'rgba(100,255,100,0.6)');gr.addColorStop(1,'transparent');
    ctx.fillStyle=gr;ctx.beginPath();ctx.arc(x,y,10,0,Math.PI*2);ctx.fill();
    ctx.save();ctx.translate(x,y);ctx.rotate(angle-Math.PI/2);
    ctx.fillStyle='#5f5';ctx.shadowColor='#0f0';ctx.shadowBlur=8;ctx.fillRect(-1.5,-10,3,20);ctx.shadowBlur=0;ctx.restore();},

  drawRedBolt(b){const x=b.x*W,y=b.y*H,angle=Math.atan2(b.vy,b.vx);
    const gr=ctx.createRadialGradient(x,y,0,x,y,8);gr.addColorStop(0,'rgba(255,80,80,0.6)');gr.addColorStop(1,'transparent');
    ctx.fillStyle=gr;ctx.beginPath();ctx.arc(x,y,8,0,Math.PI*2);ctx.fill();
    ctx.save();ctx.translate(x,y);ctx.rotate(angle-Math.PI/2);
    ctx.fillStyle='#f44';ctx.shadowColor='#f00';ctx.shadowBlur=6;ctx.fillRect(-1.5,-8,3,16);ctx.shadowBlur=0;ctx.restore();},

  drawExplosion(ex){const x=ex.x*W,y=ex.y*H,p=ex.progress,r=(30+p*80)*(Math.min(W,H)/600);
    for(let ring=0;ring<3;ring++){const rp=Math.min(1,p+ring*0.08),ringR=r*(0.6+ring*0.3)*rp,alpha=Math.max(0,(1-rp*1.3)*0.7);
      const cols=['rgba(255,220,80,','rgba(255,130,30,','rgba(255,60,20,'];
      ctx.strokeStyle=cols[ring]+alpha+')';ctx.lineWidth=3-ring;ctx.beginPath();ctx.arc(x,y,ringR,0,Math.PI*2);ctx.stroke();}
    for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2+p*5,ri=r*0.05,ro=r*(0.3+p*0.7),al=Math.max(0,1-p*1.5);
      ctx.strokeStyle=i%3===0?'rgba(255,255,150,'+al+')':i%3===1?'rgba(255,180,50,'+al+')':'rgba(255,80,20,'+al+')';
      ctx.lineWidth=2.5-p*1.5;ctx.beginPath();ctx.moveTo(x+Math.cos(a)*ri,y+Math.sin(a)*ri);
      ctx.lineTo(x+Math.cos(a)*ro,y+Math.sin(a)*ro);ctx.stroke();}
    if(p<0.35){const fa=1-p/0.35;
      const glow=ctx.createRadialGradient(x,y,0,x,y,r*0.4*(1-p));
      glow.addColorStop(0,'rgba(255,255,255,'+fa+')');glow.addColorStop(0.3,'rgba(255,220,100,'+fa*0.8+')');
      glow.addColorStop(0.7,'rgba(255,100,30,'+fa*0.4+')');glow.addColorStop(1,'transparent');
      ctx.fillStyle=glow;ctx.beginPath();ctx.arc(x,y,r*0.4*(1-p),0,Math.PI*2);ctx.fill();}
    if(p<0.6){const ga=(0.6-p)*0.4;
      const ag=ctx.createRadialGradient(x,y,0,x,y,r*1.2);ag.addColorStop(0,'rgba(255,150,30,'+ga+')');ag.addColorStop(1,'transparent');
      ctx.fillStyle=ag;ctx.beginPath();ctx.arc(x,y,r*1.2,0,Math.PI*2);ctx.fill();}},

  drawCross(){const x=this.crossX*W,y=this.crossY*H,r=18*(Math.min(W,H)/600),ext=8*(Math.min(W,H)/600);
    ctx.strokeStyle='rgba(100,255,100,0.6)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(x-r-ext,y);ctx.lineTo(x-r+4,y);ctx.moveTo(x+r-4,y);ctx.lineTo(x+r+ext,y);
    ctx.moveTo(x,y-r-ext);ctx.lineTo(x,y-r+4);ctx.moveTo(x,y+r-4);ctx.lineTo(x,y+r+ext);ctx.stroke();
    ctx.fillStyle='rgba(100,255,100,0.8)';ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fill();},

  drawCD(){const cx=W/2,cy=H/2;
    ctx.fillStyle='#FFE81F';ctx.font=Math.min(W,H)*0.04+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='rgba(255,232,31,0.4)';ctx.shadowBlur=10;
    ctx.fillText('WAVE '+this.wav+' OF '+this.MAX_W,cx,cy-Math.min(W,H)*0.08);
    const txt=this.CD_TXT[this.cdPhase];
    if(txt){const isNum=['3','2','1'].includes(txt),isGo=txt==='GO!';
      const fs=isNum?0.12:(isGo?0.08:0.04);
      const phase=this.cdTimer/this.CD_DUR[this.cdPhase];
      const sc=isNum?1+Math.sin(phase*Math.PI)*0.15:1;
      const al=isGo?Math.max(0,1-phase*2):1;
      ctx.save();ctx.translate(cx,cy+Math.min(W,H)*0.02);ctx.scale(sc,sc);ctx.globalAlpha=al;
      ctx.fillStyle=isGo?'#5f5':'#8be';ctx.font=Math.min(W,H)*fs+'px "Press Start 2P"';ctx.fillText(txt,0,0);
      ctx.restore();ctx.globalAlpha=1;}
    ctx.shadowBlur=0;},

  drawVictory(dt){this.vicTimer+=dt;const cx=W/2,cy=H*0.35,t=this.vicTimer,baseR=Math.min(W,H)*0.15;
    if(t<2){const crack=t/2;ctx.strokeStyle='rgba(255,255,200,'+(1-crack*0.5)+')';ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(cx,cy,baseR*(1-crack*0.1),0,Math.PI*2);ctx.stroke();
      for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;ctx.strokeStyle='rgba(255,200,50,'+crack+')';ctx.lineWidth=2+crack*3;
        ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(a)*baseR*crack,cy+Math.sin(a)*baseR*crack);ctx.stroke();}
      const glow=ctx.createRadialGradient(cx,cy,0,cx,cy,baseR*crack);
      glow.addColorStop(0,'rgba(255,255,200,'+crack*0.8+')');glow.addColorStop(0.5,'rgba(255,150,50,'+crack*0.4+')');glow.addColorStop(1,'transparent');
      ctx.fillStyle=glow;ctx.beginPath();ctx.arc(cx,cy,baseR*crack,0,Math.PI*2);ctx.fill();
    }else{const ep=Math.min(1,(t-2)/2);
      for(let i=0;i<3;i++){const rp=Math.min(1,ep+i*0.1),ringR=baseR*(1+rp*3),alpha=Math.max(0,0.6-rp*0.8);
        ctx.strokeStyle=i%2===0?'rgba(255,200,50,'+alpha+')':'rgba(255,100,30,'+alpha+')';
        ctx.lineWidth=3-i;ctx.beginPath();ctx.arc(cx,cy,ringR,0,Math.PI*2);ctx.stroke();}
      const fa=Math.max(0,1-ep*2);
      if(fa>0){const glow=ctx.createRadialGradient(cx,cy,0,cx,cy,baseR);
        glow.addColorStop(0,'rgba(255,255,255,'+fa+')');glow.addColorStop(0.3,'rgba(255,200,50,'+fa*0.5+')');glow.addColorStop(1,'transparent');
        ctx.fillStyle=glow;ctx.beginPath();ctx.arc(cx,cy,baseR,0,Math.PI*2);ctx.fill();}}
    if(t>3){const ta=Math.min(1,(t-3)/1);ctx.globalAlpha=ta;
      const pulse=1+Math.sin(t*4)*0.05;ctx.save();ctx.translate(cx,cy+baseR*1.5);ctx.scale(pulse,pulse);
      ctx.fillStyle='#FFE81F';ctx.shadowColor='rgba(255,232,31,0.6)';ctx.shadowBlur=15;
      ctx.font=Math.min(W,H)*0.045+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('MISSION COMPLETE',0,0);ctx.restore();
      ctx.fillStyle='#8be';ctx.shadowBlur=0;ctx.font=Math.min(W,H)*0.02+'px "Press Start 2P"';ctx.textAlign='center';
      ctx.fillText('THE DEATH STAR IS DESTROYED',cx,cy+baseR*1.9);
      ctx.fillStyle='#FFE81F';ctx.font=Math.min(W,H)*0.018+'px "Press Start 2P"';
      ctx.fillText('FINAL SCORE: '+String(this.sc).padStart(5,'0'),cx,cy+baseR*2.3);
      ctx.fillStyle='#5f5';ctx.font=Math.min(W,H)*0.013+'px "Press Start 2P"';
      ctx.fillText('THE FORCE IS STRONG WITH YOU',cx,cy+baseR*2.7);
      if(t>4.5&&Math.floor(t*2)%2===0){ctx.fillStyle='#8be';ctx.font=Math.min(W,H)*0.011+'px "Press Start 2P"';
        ctx.fillText('CLICK OR PRESS ENTER TO PLAY AGAIN',cx,cy+baseR*3.2);}
      ctx.globalAlpha=1;}},

  draw(dt){ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);this.drawStars(dt);
    if(this.hitFlash>0){ctx.fillStyle='rgba(255,50,50,0.12)';ctx.fillRect(0,0,W,H);}
    if(this.st==='victory'){this.drawVictory(dt);return;}
    this.drawDeathStar();
    if(this.st==='countdown'){this.drawXWing(0.5,0.85,0.06,0);this.drawCD();return;}
    if(this.st==='gameover'){this.drawXWing(0.5,0.85,0.06,0);return;}
    this.eBolts.forEach(b=>this.drawRedBolt(b));
    this.pBolts.forEach(b=>this.drawGreenBolt(b));
    this.en.forEach(e=>{if(!e.alive)return;this.drawTIE(e.x,e.y,0.045,e.flash>80);});
    this.ex.forEach(e=>this.drawExplosion(e));
    this.par.forEach(p=>{ctx.fillStyle='rgba('+p.r2+','+p.g2+','+p.b2+','+p.alpha+')';
      ctx.beginPath();ctx.arc(p.x*W,p.y*H,p.rad*Math.min(W,H),0,Math.PI*2);ctx.fill();});
    this.drawXWing(0.5,0.85,0.06,this.pAngle);
    if(this.st==='playing')this.drawCross();}
};

// ==================== GUERRILLA WARFARE ====================
const GW_SNIPER_SLOTS=(function(){const s=[];for(let i=0;i<6;i++){const y=0.12+i*0.09;s.push({x:0.12,y,type:'sniper',side:'left'});s.push({x:0.88,y,type:'sniper',side:'right'});}return s;})();
const GW_TANK_SLOTS=(function(){const s=[];for(let r=0;r<3;r++){const y=0.10+r*0.12;for(let c=0;c<3;c++){const x=0.30+c*0.20;s.push({x,y,type:'tank'});}}return s;})();

const GuerrillaWarfareSFX={ctx:null,
  init(){if(this.ctx)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}},
  play(type){if(!this.ctx)return;const t=this.ctx.currentTime,osc=()=>this.ctx.createOscillator(),gn=()=>this.ctx.createGain();
    if(type==='cannon'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.3,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,0.6);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);src.start(t);const o=osc(),g2=gn();o.type='sine';o.connect(g2);g2.connect(this.ctx.destination);o.frequency.setValueAtTime(120,t);o.frequency.exponentialRampToValueAtTime(30,t+0.25);g2.gain.setValueAtTime(0.15,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.25);o.start(t);o.stop(t+0.25);}
    else if(type==='sniper_shot'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(1800,t);o.frequency.exponentialRampToValueAtTime(300,t+0.05);g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.05);o.start(t);o.stop(t+0.06);}
    else if(type==='enemy_cannon'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.2,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,0.8);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);src.start(t);}
    else if(type==='hit'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.5,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,0.9);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.22,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.5);src.start(t);const o=osc(),g2=gn();o.type='sine';o.connect(g2);g2.connect(this.ctx.destination);o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(20,t+0.4);g2.gain.setValueAtTime(0.15,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);}
    else if(type==='sniper_kill'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(150,t+0.15);g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);o.start(t);o.stop(t+0.15);}
    else if(type==='damage'){const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(40,t+0.4);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);}
    else if(type==='gameover'){[180,150,120,90,60].forEach((f,i)=>{const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.3);g.gain.setValueAtTime(0.08,t+i*0.3);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.3+0.29);o.start(t+i*0.3);o.stop(t+i*0.3+0.3);});}
    else if(type==='countdown'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(500,t);g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.08);o.start(t);o.stop(t+0.08);}
    else if(type==='go'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(900,t);g.gain.setValueAtTime(0.07,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);o.start(t);o.stop(t+0.12);}
    else if(type==='victory'){[262,330,392,523,392,523,659].forEach((f,i)=>{const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.18);g.gain.setValueAtTime(0.07,t+i*0.18);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.18+0.17);o.start(t+i*0.18);o.stop(t+i*0.18+0.18);});}}
};

const GuerrillaWarfareGame={
  COL:{dkGreen:'#1a4a0a',mdGreen:'#2d6b12',ltGreen:'#4a8c2a',grass:'#3a7a1a',dirt:'#8a6a3a',dkDirt:'#5a4020',ltDirt:'#b89060',trunk:'#5a3a1a',bark:'#3a2810',leaf:'#2a6a10',dkLeaf:'#1a4a08',ltLeaf:'#5a9a30',tank:'#5a6a4a',dkTank:'#3a4a2a',ltTank:'#7a8a6a',tread:'#2a2a1a',eTank:'#6a5a3a',eDkTank:'#4a3a1a',eLtTank:'#8a7a5a',muzzle:'#ffa030',flash:'#ffe880',bullet:'#ffd040',sniper:'#5a4030',sniperGun:'#2a2a2a',sky:'#1a1a2a',hud:'#e8d8a0',blood:'#a02020'},
  PX:2,MAX_W:9,
  CD_DUR:[1200,900,700,700,700,500],CD_TXT:['','INCOMING','3','2','1','FIRE!'],
  en:[],ex:[],pShells:[],eShells:[],par:[],trees:[],
  crossX:0.5,crossY:0.4,sc:0,liv:3,wav:1,st:'idle',
  spT:0,killed:0,waveTarget:7,maxOn:4,spInt:1200,
  turretAngle:0,groundScroll:0,cdPhase:0,cdTimer:0,vicTimer:0,
  gwKeys:{},hitFlash:0,sniperHits:0,

  init(){activeGame='guerrilla';hideMsg();showEl('exitBtn');hideEl('input-panel');
    canvas.style.cursor='crosshair';
    $('scoreboard').className='guerrilla-mode';showEl('scoreboard');
    $('p1Label').textContent='SCR';$('p2Label').textContent='LIVES';
    $('gameTitle').textContent='GUERRILLA WARFARE';$('gameTitle').style.color='#e8d8a0';
    $('subLabel').textContent='Advance Through Hostile Territory';
    this.PX=Math.max(2,Math.floor(Math.min(W,H)/200));
    this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.pShells=[];this.eShells=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.turretAngle=0;this.hitFlash=0;
    this.groundScroll=0;this.sniperHits=0;this.vicTimer=0;this._vicMsgShown=false;
    this.initTrees();
    GuerrillaWarfareSFX.init();this.updHUD();this.startCD();gamePhase='guerrilla';},

  initTrees(){this.trees=[];
    for(let i=0;i<18;i++){const y=0.05+(i/18)*0.75;
      this.trees.push({x:0.02+Math.random()*0.06,y:y+Math.random()*0.03,size:0.6+Math.random()*0.5,z:0});
      this.trees.push({x:0.08+Math.random()*0.08,y:y+Math.random()*0.03,size:0.7+Math.random()*0.4,z:1});
      this.trees.push({x:0.15+Math.random()*0.05,y:y+Math.random()*0.03,size:0.5+Math.random()*0.3,z:2});
      this.trees.push({x:0.92+Math.random()*0.06,y:y+Math.random()*0.03,size:0.6+Math.random()*0.5,z:0});
      this.trees.push({x:0.84+Math.random()*0.08,y:y+Math.random()*0.03,size:0.7+Math.random()*0.4,z:1});
      this.trees.push({x:0.80+Math.random()*0.05,y:y+Math.random()*0.03,size:0.5+Math.random()*0.3,z:2});}
    this.trees.sort((a,b)=>a.y-b.y);},

  updHUD(){$('score1').textContent=String(this.sc).padStart(5,'0');
    $('subLabel').textContent='Zone '+this.wav+'/'+this.MAX_W;
    let lv='';for(let i=0;i<this.liv;i++){if(i===this.liv-1&&this.sniperHits>0)lv+='\u25A3';else lv+='\u25A3';}
    $('score2').textContent=lv;},

  getWC(w){return{target:5+w*2,spawnInt:Math.max(1200-w*100,400),maxOn:Math.min(3+w,10),sniperChance:Math.min(0.3+w*0.05,0.7)};},

  startCD(){this.st='countdown';this.cdPhase=0;this.cdTimer=0;
    this.en=[];this.ex=[];this.pShells=[];this.eShells=[];this.par=[];
    const c=this.getWC(this.wav);this.waveTarget=c.target;this.spInt=c.spawnInt;this.maxOn=c.maxOn;
    this.killed=0;this.spT=0;},

  spawnE(){const cfg=this.getWC(this.wav),isSniper=Math.random()<cfg.sniperChance;
    if(isSniper){const slots=GW_SNIPER_SLOTS.filter(s=>!this.en.some(e=>e.alive&&Math.abs(e.x-s.x)<0.05&&Math.abs(e.y-s.y)<0.06));
      if(!slots.length)return;const slot=slots[Math.floor(Math.random()*slots.length)];
      this.en.push({x:slot.x,y:slot.y,bx:slot.x,by:slot.y,type:'sniper',side:slot.side,alive:true,t:0,life:6000+Math.random()*4000+this.wav*800,shootCD:800+Math.random()*1500,flash:0,dir:1,range:0.01,spd:0.3});}
    else{const slots=GW_TANK_SLOTS.filter(s=>!this.en.some(e=>e.alive&&Math.abs(e.x-s.x)<0.1&&Math.abs(e.y-s.y)<0.08));
      if(!slots.length)return;const slot=slots[Math.floor(Math.random()*slots.length)];
      this.en.push({x:slot.x,y:slot.y,bx:slot.x,by:slot.y,type:'tank',alive:true,t:0,life:10000+Math.random()*5000+this.wav*1000,shootCD:1200+Math.random()*1500,flash:0,dir:Math.random()>0.5?1:-1,range:0.02+Math.random()*0.02,spd:0.2+Math.random()*0.3,hp:this.wav>=5?2:1});}},

  shoot(){if(this.st!=='playing')return;GuerrillaWarfareSFX.play('cannon');
    let closest=null,closestD=Infinity;
    for(const e of this.en){if(!e.alive)continue;const dx=this.crossX-e.x,dy=this.crossY-e.y,d=Math.sqrt(dx*dx+dy*dy);
      const range=e.type==='tank'?0.12:0.10;if(d<range&&d<closestD){closest=e;closestD=d;}}
    const aimX=closest?closest.x:this.crossX,aimY=closest?closest.y:this.crossY;
    const startX=0.5,startY=0.82,dx=aimX-startX,dy=aimY-startY,dist=Math.sqrt(dx*dx+dy*dy)||0.001,speed=2.5;
    this.pShells.push({x:startX,y:startY,vx:(dx/dist)*speed,vy:(dy/dist)*speed});
    if(closest){if(closest.type==='tank'&&closest.hp>1){closest.hp--;closest.flash=200;GuerrillaWarfareSFX.play('hit');
        for(let i=0;i<6;i++)this.par.push({x:closest.x,y:closest.y,vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,rad:0.002+Math.random()*0.003,alpha:1,life:0.3+Math.random()*0.2,r2:255,g2:200,b2:50});}
      else{closest.alive=false;this.sc+=closest.type==='tank'?200*this.wav:100*this.wav;this.killed++;
        GuerrillaWarfareSFX.play(closest.type==='tank'?'hit':'sniper_kill');
        this.ex.push({x:closest.x,y:closest.y,progress:0,big:closest.type==='tank'});
        const numP=closest.type==='tank'?20:10;
        for(let i=0;i<numP;i++){const isF=Math.random()>0.3,isM=closest.type==='tank'&&Math.random()>0.6;
          this.par.push({x:closest.x,y:closest.y,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,rad:0.002+Math.random()*0.005,alpha:1,life:0.4+Math.random()*0.5,r2:isM?150:(isF?255:200),g2:isM?150:(isF?Math.floor(80+Math.random()*120):200),b2:isM?150:(isF?20:200)});}
        this.hitFlash=6;}}
    this.updHUD();},

  takeDmg(sourceType){if(sourceType==='sniper'){this.sniperHits++;
      if(this.sniperHits<2){GuerrillaWarfareSFX.play('sniper_shot');this.hitFlash=8;this.updHUD();return;}
      this.sniperHits=0;}
    this.liv--;GuerrillaWarfareSFX.play('damage');this.hitFlash=12;this.updHUD();
    if(this.liv<=0){this.st='gameover';GuerrillaWarfareSFX.play('gameover');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#c84">DESTROYED</span><br>'+
        '<span style="font-family:Press Start 2P,monospace;font-size:14px;color:#e8d8a0">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="gw-btn" onclick="GuerrillaWarfareGame.restart()">PLAY AGAIN</button> <button class="gw-btn" onclick="showArcadeMenu()">ARCADE MENU</button>');}},

  restart(){hideMsg();this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.pShells=[];this.eShells=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.turretAngle=0;this.hitFlash=0;
    this.groundScroll=0;this.sniperHits=0;this.vicTimer=0;this._vicMsgShown=false;
    this.initTrees();GuerrillaWarfareSFX.init();this.updHUD();this.startCD();},

  nextWave(){if(this.wav>=this.MAX_W){this.st='victory';this.vicTimer=0;GuerrillaWarfareSFX.play('victory');return;}
    this.wav++;this.updHUD();this.startCD();},

  updateCD(dt){this.cdTimer+=dt*1000;
    if(this.cdTimer>=this.CD_DUR[this.cdPhase]){this.cdTimer=0;this.cdPhase++;
      if(this.cdPhase>=2&&this.cdPhase<=4)GuerrillaWarfareSFX.play('countdown');
      if(this.cdPhase===5)GuerrillaWarfareSFX.play('go');
      if(this.cdPhase>=this.CD_DUR.length){this.st='playing';}}},

  update(dt){
    if(this.hitFlash>0)this.hitFlash--;
    if(this.st==='countdown'){this.updateCD(dt);return;}
    if(this.st!=='playing'&&this.st!=='victory')return;
    if(this.st==='victory')return;
    const cs=0.5;
    if(this.gwKeys['ArrowLeft']||this.gwKeys['a'])this.crossX-=cs*dt;
    if(this.gwKeys['ArrowRight']||this.gwKeys['d'])this.crossX+=cs*dt;
    if(this.gwKeys['ArrowUp']||this.gwKeys['w'])this.crossY-=cs*dt;
    if(this.gwKeys['ArrowDown']||this.gwKeys['s'])this.crossY+=cs*dt;
    this.crossX=Math.max(0.0,Math.min(1.0,this.crossX));
    this.crossY=Math.max(0.0,Math.min(0.8,this.crossY));
    this.spT+=dt*1000;
    if(this.spT>=this.spInt&&this.en.filter(e=>e.alive).length<this.maxOn){this.spawnE();this.spT=0;}
    this.en.forEach(e=>{if(!e.alive)return;e.t+=dt*1000;
      if(e.type==='tank'){e.x=e.bx+Math.sin(e.t*0.001*e.spd)*e.range*e.dir;e.y=e.by+Math.sin(e.t*0.0008*e.spd)*0.01;e.x=Math.max(0.25,Math.min(0.75,e.x));}
      else{e.y=e.by+Math.sin(e.t*0.001)*0.008;}
      e.shootCD-=dt*1000;
      if(e.shootCD<=0){e.flash=150;
        if(e.type==='sniper'){e.shootCD=Math.max(600,1500-this.wav*80)+Math.random()*1000;GuerrillaWarfareSFX.play('sniper_shot');}
        else{e.shootCD=Math.max(900,2000-this.wav*120)+Math.random()*1200;GuerrillaWarfareSFX.play('enemy_cannon');}
        const dx=0.5-e.x+(Math.random()-0.5)*0.12,dy=0.85-e.y,d=Math.sqrt(dx*dx+dy*dy),bspd=e.type==='tank'?0.5+this.wav*0.03:0.6+this.wav*0.04;
        this.eShells.push({x:e.x,y:e.y+0.02,vx:(dx/d)*bspd,vy:(dy/d)*bspd,type:e.type});}
      if(e.flash>0)e.flash-=dt*1000;
      if(e.t>e.life)e.alive=false;});
    this.en=this.en.filter(e=>e.alive);
    this.pShells=this.pShells.filter(b=>{b.x+=b.vx*dt;b.y+=b.vy*dt;return b.y>-0.05&&b.y<1.05&&b.x>-0.05&&b.x<1.05;});
    this.eShells=this.eShells.filter(b=>{b.x+=b.vx*dt;b.y+=b.vy*dt;
      if(Math.abs(b.x-0.5)<0.04&&Math.abs(b.y-0.85)<0.04){this.takeDmg(b.type);return false;}
      return b.y<1.05&&b.y>-0.05&&b.x>-0.05&&b.x<1.05;});
    this.ex.forEach(e=>e.progress+=dt*(e.big?1.2:1.8));this.ex=this.ex.filter(e=>e.progress<1);
    this.par.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.alpha-=dt*1.8;p.life-=dt;});
    this.par=this.par.filter(p=>p.life>0&&p.alpha>0);
    if(this.killed>=this.waveTarget)this.nextWave();
    const tdx=this.crossX-0.5,tdy=this.crossY-0.85;
    const targetAngle=Math.atan2(tdx,-tdy);
    const clampedTarget=Math.max(-1.0,Math.min(1.0,targetAngle));
    this.turretAngle+=(clampedTarget-this.turretAngle)*Math.min(1,dt*10);},

  fillPR(x,y,w,h,color){ctx.fillStyle=color;const px=this.PX,sx=Math.round(x/px)*px,sy=Math.round(y/px)*px,sw=Math.round(w/px)*px,sh=Math.round(h/px)*px;ctx.fillRect(sx,sy,Math.max(sw,px),Math.max(sh,px));},

  drawGround(dt){this.groundScroll+=dt*40*(this.st==='playing'?1:0.3);
    const C=this.COL;
    const skyGrad=ctx.createLinearGradient(0,0,0,H*0.15);skyGrad.addColorStop(0,'#0a0a1a');skyGrad.addColorStop(1,C.dkGreen);
    ctx.fillStyle=skyGrad;ctx.fillRect(0,0,W,H*0.15);
    ctx.fillStyle=C.grass;ctx.fillRect(0,H*0.1,W,H*0.9);
    const roadL=W*0.22,roadR=W*0.78,roadW=roadR-roadL;
    ctx.fillStyle=C.dirt;ctx.fillRect(roadL,0,roadW,H);
    ctx.fillStyle=C.dkDirt;
    for(let i=-2;i<30;i++){const ly=((i*H/12)+this.groundScroll*2)%(H*1.2)-H*0.1;ctx.fillRect(roadL+roadW*0.1,ly,roadW*0.03,this.PX*3);ctx.fillRect(roadL+roadW*0.87,ly,roadW*0.03,this.PX*3);}
    ctx.fillStyle=C.ltDirt;
    for(let i=-2;i<20;i++){const ly=((i*H/8)+this.groundScroll*2)%(H*1.2)-H*0.1;ctx.fillRect(roadL+roadW*0.48,ly,roadW*0.04,this.PX*5);}
    ctx.fillStyle=C.dkDirt;ctx.fillRect(roadL-this.PX*2,0,this.PX*2,H);ctx.fillRect(roadR,0,this.PX*2,H);
    ctx.fillStyle=C.mdGreen;
    for(let i=0;i<40;i++){const gx=(Math.sin(i*73.7)*0.5+0.5),gy=((Math.cos(i*31.3)*0.5+0.5)*1.2+this.groundScroll*0.002)%1.0;if(gx<0.22||gx>0.78)ctx.fillRect(gx*W,gy*H,this.PX*3,this.PX*2);}
    ctx.fillStyle=C.ltGreen;
    for(let i=0;i<25;i++){const gx=(Math.sin(i*47.1)*0.5+0.5),gy=((Math.cos(i*89.3)*0.5+0.5)*1.2+this.groundScroll*0.003)%1.0;if(gx<0.20||gx>0.80)ctx.fillRect(gx*W,gy*H,this.PX*2,this.PX*1);}},

  drawTree(tx,ty,size){const C=this.COL,x=tx*W,y=ty*H,s=size*this.PX*8;
    this.fillPR(x-s*0.08,y-s*0.1,s*0.16,s*0.7,C.trunk);
    this.fillPR(x-s*0.06,y+s*0.1,s*0.12,s*0.5,C.bark);
    ctx.fillStyle=C.dkLeaf;ctx.beginPath();ctx.moveTo(x-s*0.5,y);ctx.lineTo(x,y-s*0.55);ctx.lineTo(x+s*0.5,y);ctx.closePath();ctx.fill();
    ctx.fillStyle=C.leaf;ctx.beginPath();ctx.moveTo(x-s*0.4,y-s*0.2);ctx.lineTo(x,y-s*0.7);ctx.lineTo(x+s*0.4,y-s*0.2);ctx.closePath();ctx.fill();
    ctx.fillStyle=C.ltLeaf;ctx.beginPath();ctx.moveTo(x-s*0.28,y-s*0.4);ctx.lineTo(x,y-s*0.85);ctx.lineTo(x+s*0.28,y-s*0.4);ctx.closePath();ctx.fill();
    this.fillPR(x-s*0.15,y-s*0.55,this.PX*2,this.PX*2,'#6aaa3a');
    this.fillPR(x+s*0.08,y-s*0.35,this.PX*2,this.PX*2,'#6aaa3a');},

  drawPlayerTank(cx,cy,tAngle){const C=this.COL,x=cx*W,y=cy*H,s=this.PX*6;
    ctx.save();ctx.translate(x,y);
    this.fillPR(-s*3.2,-s*1,s*1.2,s*5.5,C.tread);this.fillPR(s*2,-s*1,s*1.2,s*5.5,C.tread);
    for(let i=0;i<5;i++){const ty=-s*0.8+i*s*1.1;this.fillPR(-s*3.1,ty,s*1,this.PX*2,'#3a3a2a');this.fillPR(s*2.1,ty,s*1,this.PX*2,'#3a3a2a');}
    this.fillPR(-s*2.5,-s*0.5,s*5,s*4.5,C.tank);this.fillPR(-s*2.2,-s*0.3,s*4.4,s*4,C.ltTank);
    this.fillPR(-s*2.3,s*1.5,s*4.6,this.PX,C.dkTank);this.fillPR(-s*2.3,s*2.5,s*4.6,this.PX,C.dkTank);
    this.fillPR(-s*2,-s*1.2,s*4,s*0.8,C.dkTank);
    ctx.save();ctx.rotate(tAngle);
    this.fillPR(-s*1.8,-s*1.8,s*3.6,s*3,C.tank);this.fillPR(-s*1.5,-s*1.5,s*3,s*2.5,C.ltTank);
    this.fillPR(-s*1.2,-s*1.3,s*2.4,s*0.6,'#8a9a7a');
    this.fillPR(-s*0.4,-s*0.6,s*0.8,s*0.8,C.dkTank);this.fillPR(-s*0.3,-s*0.5,s*0.6,s*0.6,'#6a7a5a');
    this.fillPR(-s*0.35,-s*5.5,s*0.7,s*4,C.dkTank);this.fillPR(-s*0.25,-s*5.3,s*0.5,s*3.6,'#4a5a3a');
    this.fillPR(-s*0.45,-s*5.8,s*0.9,s*0.5,'#3a3a2a');
    ctx.restore();
    ctx.fillStyle='#c8b868';ctx.beginPath();
    const starX=0,starY=s*2.5,starR=s*0.6;
    for(let i=0;i<5;i++){const a=-Math.PI/2+(i*2*Math.PI/5),a2=a+Math.PI/5;
      if(i===0)ctx.moveTo(starX+Math.cos(a)*starR,starY+Math.sin(a)*starR);
      else ctx.lineTo(starX+Math.cos(a)*starR,starY+Math.sin(a)*starR);
      ctx.lineTo(starX+Math.cos(a2)*starR*0.4,starY+Math.sin(a2)*starR*0.4);}
    ctx.closePath();ctx.fill();
    ctx.restore();},

  drawEnemyTank(cx,cy,size,flash){const C=this.COL,x=cx*W,y=cy*H,s=size*this.PX*5;
    this.fillPR(x-s*3,y-s*1.5,s*1,s*5,flash?'#8a6a4a':C.tread);this.fillPR(x+s*2,y-s*1.5,s*1,s*5,flash?'#8a6a4a':C.tread);
    this.fillPR(x-s*2.2,y-s*1,s*4.4,s*4,flash?C.eLtTank:C.eTank);this.fillPR(x-s*1.8,y-s*0.7,s*3.6,s*3.4,flash?'#aa9a7a':C.eLtTank);
    this.fillPR(x-s*1.5,y-s*1.5,s*3,s*2.5,flash?'#aa9a6a':C.eTank);this.fillPR(x-s*1.2,y-s*1.2,s*2.4,s*2,flash?'#ba9a7a':C.eLtTank);
    this.fillPR(x-s*0.3,y+s*1,s*0.6,s*3,flash?'#6a5a3a':C.eDkTank);this.fillPR(x-s*0.4,y+s*3.8,s*0.8,s*0.4,'#3a2a1a');
    ctx.fillStyle=flash?'#ff8':'#a03030';ctx.beginPath();
    const esx=x,esy=y+s*0.5,esr=s*0.5;
    for(let i=0;i<5;i++){const a=-Math.PI/2+(i*2*Math.PI/5),a2=a+Math.PI/5;
      if(i===0)ctx.moveTo(esx+Math.cos(a)*esr,esy+Math.sin(a)*esr);
      else ctx.lineTo(esx+Math.cos(a)*esr,esy+Math.sin(a)*esr);
      ctx.lineTo(esx+Math.cos(a2)*esr*0.4,esy+Math.sin(a2)*esr*0.4);}
    ctx.closePath();ctx.fill();},

  drawSniper(cx,cy,side,flash){const C=this.COL,x=cx*W,y=cy*H,s=this.PX*4;
    this.fillPR(x-s*0.6,y-s*0.4,s*1.2,s*1.8,flash?'#aa8060':C.sniper);
    ctx.fillStyle=flash?'#cc9070':'#7a6050';ctx.beginPath();ctx.arc(x,y-s*0.9,s*0.55,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=flash?'#8a9a6a':'#4a5a3a';ctx.beginPath();ctx.arc(x,y-s*1.1,s*0.5,Math.PI,0);ctx.fill();
    const gunDir=side==='left'?1:-1;ctx.fillStyle=flash?'#5a5a5a':C.sniperGun;
    ctx.save();ctx.translate(x,y-s*0.2);ctx.rotate(gunDir*0.3);ctx.fillRect(0,-this.PX,s*2.5*gunDir,this.PX*2);ctx.restore();
    if(flash){ctx.fillStyle=C.flash;ctx.beginPath();ctx.arc(x+gunDir*s*2.5,y-s*0.5,s*0.6,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=C.muzzle;ctx.beginPath();ctx.arc(x+gunDir*s*2.5,y-s*0.5,s*0.3,0,Math.PI*2);ctx.fill();}},

  drawShell(b,color,glowColor){const x=b.x*W,y=b.y*H,angle=Math.atan2(b.vy,b.vx);
    const grad=ctx.createRadialGradient(x,y,0,x,y,this.PX*4);grad.addColorStop(0,glowColor);grad.addColorStop(1,'transparent');
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(x,y,this.PX*4,0,Math.PI*2);ctx.fill();
    ctx.save();ctx.translate(x,y);ctx.rotate(angle-Math.PI/2);ctx.fillStyle=color;ctx.fillRect(-this.PX,-this.PX*4,this.PX*2,this.PX*8);ctx.restore();},

  drawExplosion(ex){const x=ex.x*W,y=ex.y*H,p=ex.progress,r=(20+p*70)*(Math.min(W,H)/600),isTank=ex.big,PX=this.PX;
    const numBlocks=isTank?16:10;
    for(let i=0;i<numBlocks;i++){const a=(i/numBlocks)*Math.PI*2+p*3,dist=r*(0.2+p*0.8)*(0.6+Math.sin(i*2.7)*0.4),alpha=Math.max(0,1-p*1.4);
      const bx=x+Math.cos(a)*dist,by=y+Math.sin(a)*dist,bsize=PX*(isTank?5:3)*(1-p*0.5);
      const colors=['#ffa030','#ff6010','#ffe060','#ff4000','#fff0a0'];
      ctx.fillStyle=colors[i%colors.length];ctx.globalAlpha=alpha;ctx.fillRect(bx-bsize/2,by-bsize/2,bsize,bsize);}
    if(p<0.3){const fa=1-p/0.3;ctx.globalAlpha=fa;ctx.fillStyle='#fff';const cs=r*0.4*(1-p);ctx.fillRect(x-cs,y-cs,cs*2,cs*2);}
    ctx.globalAlpha=Math.max(0,0.5-p*0.8);ctx.strokeStyle='#ffa030';ctx.lineWidth=PX*2;ctx.beginPath();ctx.arc(x,y,r*p*1.3,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=1;},

  drawCrosshair(){const x=this.crossX*W,y=this.crossY*H,r=this.PX*8;
    ctx.strokeStyle='rgba(255,200,80,0.7)';ctx.lineWidth=this.PX;
    ctx.beginPath();ctx.moveTo(x-r*1.5,y);ctx.lineTo(x-r*0.4,y);ctx.moveTo(x+r*0.4,y);ctx.lineTo(x+r*1.5,y);
    ctx.moveTo(x,y-r*1.5);ctx.lineTo(x,y-r*0.4);ctx.moveTo(x,y+r*0.4);ctx.lineTo(x,y+r*1.5);ctx.stroke();
    ctx.beginPath();ctx.moveTo(x,y-r);ctx.lineTo(x+r,y);ctx.lineTo(x,y+r);ctx.lineTo(x-r,y);ctx.closePath();ctx.stroke();
    ctx.fillStyle='rgba(255,200,80,0.9)';ctx.fillRect(x-this.PX,y-this.PX,this.PX*2,this.PX*2);},

  drawParticle(p){ctx.fillStyle='rgba('+(p.r2||255)+','+(p.g2||180)+','+(p.b2||50)+','+p.alpha+')';
    const sz=p.rad*Math.min(W,H);ctx.fillRect(p.x*W-sz,p.y*H-sz,sz*2,sz*2);},

  drawCountdown(){const cx=W/2,cy=H/2,C=this.COL;
    ctx.fillStyle=C.hud;ctx.font=Math.min(W,H)*0.025+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='#000';ctx.shadowBlur=0;ctx.shadowOffsetX=2;ctx.shadowOffsetY=2;
    ctx.fillText('ZONE '+this.wav+' OF '+this.MAX_W,cx,cy-Math.min(W,H)*0.08);
    const text=this.CD_TXT[this.cdPhase];
    if(text){const isNum=['3','2','1'].includes(text),isGo=text==='FIRE!';
      const fontSize=isNum?0.1:(isGo?0.06:0.025);
      const phase=this.cdTimer/this.CD_DUR[this.cdPhase];
      const scale=isNum?1+Math.sin(phase*Math.PI)*0.15:1;
      const alpha=isGo?Math.max(0,1-phase*2):1;
      ctx.save();ctx.translate(cx,cy+Math.min(W,H)*0.02);ctx.scale(scale,scale);ctx.globalAlpha=alpha;
      ctx.fillStyle=isGo?'#ff6030':(text==='INCOMING'?'#ff4040':'#ffa040');
      ctx.font=Math.min(W,H)*fontSize+'px "Press Start 2P"';ctx.fillText(text,0,0);
      ctx.restore();ctx.globalAlpha=1;}
    ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;},

  drawVictory(dt){this.vicTimer+=dt;const cx=W/2,cy=H*0.4,t=this.vicTimer,C=this.COL;
    const flagW=Math.min(W,H)*0.25,flagH=flagW*0.6,fx=cx-flagW/2,fy=cy-flagH/2;
    ctx.fillStyle='#aaa';ctx.fillRect(fx-this.PX*3,fy-flagH*0.3,this.PX*4,flagH*1.8);
    for(let col=0;col<20;col++){const wOff=Math.sin(t*3+col*0.4)*flagH*0.03,sx=fx+(col/20)*flagW,sw=flagW/20+1;
      ctx.fillStyle='#2a6a1a';ctx.fillRect(sx,fy+wOff,sw,flagH*0.33);
      ctx.fillStyle='#ddd';ctx.fillRect(sx,fy+flagH*0.33+wOff,sw,flagH*0.34);
      ctx.fillStyle='#2a6a1a';ctx.fillRect(sx,fy+flagH*0.67+wOff,sw,flagH*0.33);}
    ctx.fillStyle='#ffd040';const stx=cx,sty=cy+Math.sin(t*3)*flagH*0.02,str=flagH*0.18;
    ctx.beginPath();for(let i=0;i<5;i++){const a=-Math.PI/2+(i*2*Math.PI/5),a2=a+Math.PI/5;
      if(i===0)ctx.moveTo(stx+Math.cos(a)*str,sty+Math.sin(a)*str);
      else ctx.lineTo(stx+Math.cos(a)*str,sty+Math.sin(a)*str);
      ctx.lineTo(stx+Math.cos(a2)*str*0.4,sty+Math.sin(a2)*str*0.4);}ctx.closePath();ctx.fill();
    if(t>1.5){const ta=Math.min(1,(t-1.5)/1);ctx.globalAlpha=ta;
      ctx.shadowColor='#000';ctx.shadowOffsetX=2;ctx.shadowOffsetY=2;
      const pulse=1+Math.sin(t*4)*0.04;
      ctx.save();ctx.translate(cx,cy+flagH*1.2);ctx.scale(pulse,pulse);
      ctx.fillStyle='#ffa040';ctx.font=Math.min(W,H)*0.04+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('MISSION COMPLETE',0,0);ctx.restore();
      ctx.fillStyle='#8a4';ctx.font=Math.min(W,H)*0.018+'px "Press Start 2P"';ctx.textAlign='center';
      ctx.fillText('ALL ZONES CLEARED \u2014 TERRITORY SECURED',cx,cy+flagH*1.7);
      ctx.fillStyle=C.hud;ctx.font=Math.min(W,H)*0.018+'px "Press Start 2P"';
      ctx.fillText('FINAL SCORE: '+String(this.sc).padStart(5,'0'),cx,cy+flagH*2.1);
      ctx.fillStyle='#c84';ctx.font=Math.min(W,H)*0.012+'px "Press Start 2P"';
      ctx.fillText('OUTSTANDING SOLDIER',cx,cy+flagH*2.5);
      if(t>3&&!this._vicMsgShown){this._vicMsgShown=true;
        showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#ffa040">MISSION COMPLETE</span><br>'+
          '<span style="font-family:Press Start 2P,monospace;font-size:12px;color:#8a4">All Zones Cleared</span><br>'+
          '<span style="font-family:Press Start 2P,monospace;font-size:14px;color:#e8d8a0">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
          '<button class="gw-btn" onclick="GuerrillaWarfareGame.restart()">PLAY AGAIN</button> <button class="gw-btn" onclick="showArcadeMenu()">ARCADE MENU</button>');}
      ctx.globalAlpha=1;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;}},

  draw(dt){ctx.clearRect(0,0,W,H);
    this.drawGround(dt);
    if(this.hitFlash>0){ctx.fillStyle='rgba(255,40,40,0.2)';ctx.fillRect(0,0,W,H);}
    if(this.st==='victory'){this.trees.forEach(t=>this.drawTree(t.x,t.y,t.size));this.drawPlayerTank(0.5,0.85,0);this.drawVictory(dt);return;}
    this.trees.filter(t=>t.z===0).forEach(t=>this.drawTree(t.x,t.y,t.size));
    this.en.forEach(e=>{if(!e.alive||e.type!=='tank')return;this.drawEnemyTank(e.x,e.y,0.8+this.wav*0.02,e.flash>80);});
    this.trees.filter(t=>t.z===1).forEach(t=>this.drawTree(t.x,t.y,t.size));
    this.en.forEach(e=>{if(!e.alive||e.type!=='sniper')return;this.drawSniper(e.x,e.y,e.side,e.flash>80);});
    this.trees.filter(t=>t.z===2).forEach(t=>this.drawTree(t.x,t.y,t.size));
    this.eShells.forEach(b=>{this.drawShell(b,b.type==='tank'?'#ff6030':'#ff4040',b.type==='tank'?'rgba(255,100,30,0.5)':'rgba(255,60,60,0.4)');});
    this.pShells.forEach(b=>{this.drawShell(b,this.COL.bullet,'rgba(255,200,60,0.5)');});
    this.ex.forEach(e=>this.drawExplosion(e));
    this.par.forEach(p=>this.drawParticle(p));
    if(this.st==='countdown'){this.drawPlayerTank(0.5,0.85,0);this.drawCountdown();return;}
    if(this.st==='gameover'){this.drawPlayerTank(0.5,0.85,0);return;}
    this.drawPlayerTank(0.5,0.85,this.turretAngle);
    if(this.st==='playing')this.drawCrosshair();}
};

// ==================== SHARED ====================
function createExplosion(x,y,r){explosions.push({x,y,radius:r,age:0,maxAge:35});
  const c=activeGame==='starwars'?SWGame.t.bm:['#ff0','#f80','#f00','#fff','#aaa'];
  for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*5;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,size:2+Math.random()*3,
      color:c[Math.floor(Math.random()*c.length)],life:1,decay:0.015+Math.random()*0.02});}}
function destroyTerrain(x,y,r){terrainCtx.globalCompositeOperation='destination-out';
  terrainCtx.beginPath();terrainCtx.arc(x,y,r,0,Math.PI*2);terrainCtx.fill();terrainCtx.globalCompositeOperation='source-over';}
function drawExplosions(){for(const e of explosions){const a=1-e.age/e.maxAge,r=e.radius*(0.5+e.age/e.maxAge);
  ctx.fillStyle='rgba(255,'+Math.floor(180*a)+',0,'+a+')';ctx.shadowBlur=20;ctx.shadowColor='#ff8800';
  ctx.beginPath();ctx.arc(e.x,e.y,r,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,200,'+(a*0.5)+')';ctx.beginPath();ctx.arc(e.x,e.y,r*0.4,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}}
function drawParticles(){for(const p of particles){ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.size,p.size);}ctx.globalAlpha=1;}
function updateEnv(){for(let i=envParticles.length-1;i>=0;i--){const p=envParticles[i];p.x+=p.vx;p.y+=p.vy;
  if(p.isFF){p.phase+=0.05;p.vx+=(Math.random()-0.5)*0.1;p.vy+=(Math.random()-0.5)*0.1;p.life-=(p.decay||0.003);}
  if(p.y>H||p.x<-10||p.x>W+10||p.life<=0)envParticles.splice(i,1);}if(envParticles.length>300)envParticles.splice(0,50);}
function drawEnv(){for(const p of envParticles){if(p.isRain){ctx.strokeStyle=p.color;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p.x+p.vx*2,p.y+p.vy*2);ctx.stroke();}
  else if(p.isFF){ctx.fillStyle='rgba(255,255,68,'+((0.3+0.7*Math.abs(Math.sin(p.phase)))*p.life)+')';ctx.shadowColor='#ffff44';ctx.shadowBlur=6;ctx.fillRect(p.x,p.y,p.size,p.size);ctx.shadowBlur=0;}
  else{ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.size,p.size);}}}
function drawWind(){const c=activeGame==='starwars'?(SWGame.t.sp?'#44ff4488':'#ffffffaa'):'#aaaaff';
  ctx.fillStyle=c;ctx.font='13px VT323';ctx.textAlign='center';const dir=wind>0?'\u25BA':wind<0?'\u25C4':'\u2022';
  ctx.fillText('Wind: '+dir.repeat(Math.min(Math.ceil(Math.abs(wind)/5),5))+' '+Math.abs(wind).toFixed(1),W/2,H-10);}

// ==================== ARCADE MENU ====================
let menuStars=[];for(let i=0;i<200;i++)menuStars.push({x:Math.random()*W,y:Math.random()*H,s:0.3+Math.random()*0.7,sp:0.1+Math.random()*0.4});
let menuT=0;
function drawArcadeBG(){ctx.fillStyle='#0a0a18';ctx.fillRect(0,0,W,H);menuT+=0.016;
  for(const s of menuStars){s.y+=s.sp;if(s.y>H){s.y=0;s.x=Math.random()*W;}
    ctx.fillStyle='rgba(255,255,255,'+(s.s*(0.5+0.5*Math.sin(menuT*2+s.x)))+')';ctx.fillRect(s.x,s.y,s.s>0.6?2:1,s.s>0.6?2:1);}
  ctx.fillStyle='rgba(0,0,0,0.06)';for(let y=0;y<H;y+=3)ctx.fillRect(0,y,W,1);
  const gr=ctx.createLinearGradient(0,H-60,0,H);gr.addColorStop(0,'rgba(0,0,0,0)');gr.addColorStop(1,'rgba(40,20,80,0.3)');ctx.fillStyle=gr;ctx.fillRect(0,H-60,W,60);}

function showArcadeMenu(){activeGame=null;gamePhase='arcade';projectile=null;explosions=[];particles=[];envParticles=[];
  canvas.style.cursor='default';
  hideEl('input-panel');hideEl('scoreboard');hideEl('exitBtn');hideMsg();
  showMsg('<span class="arcade-title">RETRO ARCADE</span><br>'+
    '<span class="arcade-sub">\u2014 SELECT GAME \u2014</span><br>'+
    '<div class="game-grid">'+
      '<div class="game-card" onclick="launchGorillas()"><span class="card-icon">\uD83C\uDF4C</span><span class="card-title">GORILLAS</span><span class="card-desc">QBasic Classic<br>Throw bananas!</span></div>'+
      '<div class="game-card" onclick="SWGame.showPl()"><span class="card-icon">\u2694</span><span class="card-title">IMPERIAL<br>WALKERS</span><span class="card-desc">Star Wars Artillery<br>AT-AT vs AT-TE</span></div>'+
      '<div class="game-card" onclick="launchTopGun()"><span class="card-icon">\u2708</span><span class="card-title">TOP GUN</span><span class="card-desc">Naval Fighter Combat<br>Shoot jets!</span></div>'+
      '<div class="game-card" onclick="launchTrenchRun()"><span class="card-icon">\u2604</span><span class="card-title">TRENCH<br>RUN</span><span class="card-desc">Star Wars Shooter<br>Destroy Death Star!</span></div>'+
      '<div class="game-card" onclick="launchStarTrek()"><span class="card-icon">\u2726</span><span class="card-title">DEFEND<br>EARTH</span><span class="card-desc">Star Trek Shooter<br>Stop the Klingons!</span></div>'+
      '<div class="game-card" onclick="launchGuerrilla()"><span class="card-icon">\uD83C\uDF96</span><span class="card-title">GUERRILLA<br>WARFARE</span><span class="card-desc">Tank Combat<br>Clear all zones!</span></div>'+
      '<div class="game-card" onclick="window.location.href=\'crystalwand.html\'"><span class="card-icon">\uD83D\uDD2E</span><span class="card-title">CRYSTAL<br>WAND</span><span class="card-desc">Magic Shooter<br>Wield the wand!</span></div>'+
      '<div class="game-card" onclick="window.location.href=\'princess.html\'"><span class="card-icon">\uD83D\uDC51</span><span class="card-title">PRINCESS<br>BUBBLE BURST</span><span class="card-desc">Bubble Shooter<br>Pop them all!</span></div>'+
      '<div class="game-card" onclick="window.location.href=\'unicorn.html\'"><span class="card-icon">\uD83E\uDD84</span><span class="card-title">UNICORN<br>STAMPEDE</span><span class="card-desc">Fantasy Action<br>Charge!</span></div>'+
    '</div>');}

window.launchGorillas=function(){hideMsg();GorillasGame.init();};
window.launchTopGun=function(){hideMsg();TopGunGame.init();};
window.launchStarTrek=function(){hideMsg();StarTrekGame.init();};
window.launchTrenchRun=function(){hideMsg();TrenchRunGame.init();};
window.launchGuerrilla=function(){hideMsg();GuerrillaWarfareGame.init();};
window.showArcadeMenu=showArcadeMenu;
window.GorillasGame=GorillasGame;
window.SWGame=SWGame;
window.TopGunGame=TopGunGame;
window.StarTrekGame=StarTrekGame;
window.TrenchRunGame=TrenchRunGame;
window.GuerrillaWarfareGame=GuerrillaWarfareGame;

// ==================== MAIN LOOP ====================
let lastTime=0;
function gameLoop(ts){const dt=Math.min((ts-lastTime)/1000,0.05);lastTime=ts;
  if(activeGame==='topgun'){
    TopGunGame.update(dt);TopGunGame.draw(dt);
  } else if(activeGame==='startrek'){
    StarTrekGame.update(dt);StarTrekGame.draw(dt);
  } else if(activeGame==='trenchrun'){
    TrenchRunGame.update(dt);TrenchRunGame.draw(dt);
  } else if(activeGame==='guerrilla'){
    GuerrillaWarfareGame.update(dt);GuerrillaWarfareGame.draw(dt);
  } else {
    if(gamePhase==='flight'){if(activeGame==='gorillas')GorillasGame.updateP(dt);else if(activeGame==='starwars')SWGame.updateP(dt);}
    for(let i=explosions.length-1;i>=0;i--){explosions[i].age++;if(explosions[i].age>=explosions[i].maxAge)explosions.splice(i,1);}
    for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=p.decay;if(p.life<=0)particles.splice(i,1);}
    if(gamePhase==='arcade')drawArcadeBG();else if(activeGame==='gorillas')GorillasGame.draw();else if(activeGame==='starwars')SWGame.draw();
  }
  requestAnimationFrame(gameLoop);}

// ==================== INPUT ====================
$('fireBtn').addEventListener('click',()=>{if(gamePhase!=='input')return;
  const a=Math.max(0,Math.min(90,parseFloat($('angleInput').value)||45));
  const p=Math.max(1,Math.min(200,parseFloat($('powerInput').value)||50));
  if(activeGame==='gorillas')GorillasGame.fire(a,p);else if(activeGame==='starwars')SWGame.fire(a,p);});

document.addEventListener('keydown',e=>{
  if(activeGame==='topgun'){
    TopGunGame.tgKeys[e.key]=true;
    if(e.key===' '){e.preventDefault();TopGunGame.shoot();}
    return;}
  if(activeGame==='startrek'){
    StarTrekGame.stKeys[e.key]=true;
    if(e.key===' '){e.preventDefault();StarTrekGame.shoot();}
    if(e.key==='Enter'&&(StarTrekGame.st==='victory'||StarTrekGame.st==='gameover')){hideMsg();StarTrekGame.restart();}
    return;}
  if(activeGame==='trenchrun'){
    TrenchRunGame.trKeys[e.key]=true;
    if(e.key===' '){e.preventDefault();TrenchRunGame.shoot();}
    if(e.key==='Enter'&&(TrenchRunGame.st==='victory'||TrenchRunGame.st==='gameover')){hideMsg();TrenchRunGame.restart();}
    return;}
  if(activeGame==='guerrilla'){
    GuerrillaWarfareGame.gwKeys[e.key]=true;
    if(e.key===' '){e.preventDefault();GuerrillaWarfareGame.shoot();}
    if(e.key==='Enter'&&(GuerrillaWarfareGame.st==='victory'||GuerrillaWarfareGame.st==='gameover')){hideMsg();GuerrillaWarfareGame.restart();}
    return;}
  if(e.key==='Enter'&&gamePhase==='input')$('fireBtn').click();});
document.addEventListener('keyup',e=>{
  if(activeGame==='topgun')TopGunGame.tgKeys[e.key]=false;
  if(activeGame==='startrek')StarTrekGame.stKeys[e.key]=false;
  if(activeGame==='trenchrun')TrenchRunGame.trKeys[e.key]=false;
  if(activeGame==='guerrilla')GuerrillaWarfareGame.gwKeys[e.key]=false;});

canvas.addEventListener('mousemove',e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  const my=Math.max(0,Math.min(0.8,(e.clientY-rect.top)/rect.height));
  if(activeGame==='topgun'&&TopGunGame.st==='playing'){TopGunGame.crossX=mx;TopGunGame.crossY=my;}
  if(activeGame==='startrek'&&StarTrekGame.st==='playing'){StarTrekGame.crossX=mx;StarTrekGame.crossY=my;}
  if(activeGame==='trenchrun'&&TrenchRunGame.st==='playing'){TrenchRunGame.crossX=mx;TrenchRunGame.crossY=my;}
  if(activeGame==='guerrilla'&&GuerrillaWarfareGame.st==='playing'){GuerrillaWarfareGame.crossX=mx;GuerrillaWarfareGame.crossY=my;}});

canvas.addEventListener('click',e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  const my=Math.max(0,Math.min(0.8,(e.clientY-rect.top)/rect.height));
  if(activeGame==='topgun'&&TopGunGame.st==='playing'){TopGunGame.crossX=mx;TopGunGame.crossY=my;TopGunGame.shoot();}
  if(activeGame==='startrek'&&StarTrekGame.st==='playing'){StarTrekGame.crossX=mx;StarTrekGame.crossY=my;StarTrekGame.shoot();}
  if(activeGame==='trenchrun'&&TrenchRunGame.st==='playing'){TrenchRunGame.crossX=mx;TrenchRunGame.crossY=my;TrenchRunGame.shoot();}
  if(activeGame==='guerrilla'&&GuerrillaWarfareGame.st==='playing'){GuerrillaWarfareGame.crossX=mx;GuerrillaWarfareGame.crossY=my;GuerrillaWarfareGame.shoot();}});

showArcadeMenu();requestAnimationFrame(gameLoop);
</script>
</body>
</html>
