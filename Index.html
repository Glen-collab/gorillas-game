<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RETRO ARCADE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a12;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'VT323',monospace;color:#aaa;overflow:hidden}
#gameContainer{position:relative;border:3px solid #222;box-shadow:0 0 60px rgba(0,0,0,0.8);border-radius:4px;background:#000}
canvas{display:block;image-rendering:pixelated;image-rendering:crisp-edges}
#scoreboard{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:5px 12px;font-size:10px;color:#fff;background:rgba(0,0,0,0.75);border-bottom:1px solid #333;pointer-events:none;z-index:2;letter-spacing:1px}
#scoreboard.gorillas-mode{font-family:'Press Start 2P',monospace;font-size:9px}
#scoreboard.gorillas-mode .score-p1{color:#ff6}
#scoreboard.gorillas-mode .score-p2{color:#f66}
#scoreboard.sw-mode{font-family:'Orbitron',sans-serif}
#scoreboard.sw-mode .score-p1{color:#8cf}
#scoreboard.sw-mode .score-p2{color:#f88}
#scoreboard.topgun-mode{font-family:'Press Start 2P',monospace;font-size:9px;background:rgba(100,120,60,0.92);border-bottom-color:#6b7f4a}
#scoreboard.topgun-mode .score-p1{color:#2a3518}
#scoreboard.topgun-mode .score-p2{color:#2a3518}
#scoreboard.topgun-mode .score-title{color:#2a3518}
#scoreboard.topgun-mode .sub-label{color:#4a5a30}
.score-title{font-weight:700;font-size:11px}
.sub-label{color:#888;font-size:9px}
#scoreboard.hidden{display:none}
#input-panel{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:10px;align-items:center;background:rgba(0,0,0,0.88);border:1px solid #555;border-radius:2px;padding:6px 14px;font-family:'VT323',monospace;font-size:18px;color:#fff;z-index:10}
#input-panel.hidden{display:none}
#input-panel label{color:#999;font-size:16px}
#input-panel input{width:55px;background:#111;border:1px solid #444;color:#fff;font-family:'VT323',monospace;font-size:18px;padding:2px 4px;text-align:center;border-radius:2px}
#input-panel input:focus{outline:1px solid #88f;border-color:#88f}
#input-panel button{background:#333;border:1px solid #88f;color:#aaf;font-family:'VT323',monospace;font-size:18px;padding:4px 14px;cursor:pointer;border-radius:2px}
#input-panel button:hover{background:#444}
.turn-indicator{font-size:14px;font-weight:700;animation:blink 1.2s step-end infinite}
@keyframes blink{50%{opacity:0.3}}
#message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;line-height:2.2;background:rgba(0,0,0,0.9);padding:28px 40px;border:1px solid #333;border-radius:4px;z-index:20;max-width:92%}
#message.hidden{display:none}
#message button{display:inline-block;margin:6px 4px 0;background:#222;border:1px solid #555;color:#ddd;font-family:'Press Start 2P',monospace;font-size:9px;padding:10px 18px;cursor:pointer;border-radius:2px;transition:all 0.15s}
#message button:hover{background:#333;border-color:#aaa;color:#fff}
.arcade-title{font-family:'Press Start 2P',monospace;font-size:24px;color:#ff0;text-shadow:0 0 30px rgba(255,255,0,0.3),3px 3px 0 #880;letter-spacing:3px}
.arcade-sub{font-family:'VT323',monospace;font-size:18px;color:#888;letter-spacing:2px}
.game-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:380px;margin:8px auto}
.game-card{display:inline-block;padding:14px 16px;background:rgba(20,20,40,0.9);border:2px solid #444;border-radius:4px;cursor:pointer;transition:all 0.2s;text-align:center;min-width:140px;vertical-align:top}
.game-card:hover{border-color:#ff0;background:rgba(40,40,80,0.9);transform:scale(1.03);box-shadow:0 0 20px rgba(255,255,0,0.15)}
.game-card .card-icon{font-size:32px;display:block;margin-bottom:4px}
.game-card .card-title{font-family:'Press Start 2P',monospace;font-size:9px;color:#fff;display:block;margin-bottom:3px}
.game-card .card-desc{font-family:'VT323',monospace;font-size:14px;color:#888;display:block}
.game-card.coming-soon{opacity:0.4;cursor:default;border-style:dashed}
.game-card.coming-soon:hover{border-color:#444;background:rgba(20,20,40,0.9);transform:none;box-shadow:none}
#exitBtn{position:absolute;top:28px;right:8px;background:rgba(0,0,0,0.7);border:1px solid #555;color:#999;font-family:'VT323',monospace;font-size:14px;padding:3px 10px;cursor:pointer;border-radius:2px;z-index:15;transition:all 0.15s}
#exitBtn:hover{border-color:#f44;color:#f44;background:rgba(40,0,0,0.8)}
#exitBtn.hidden{display:none}
.sw-btn{font-family:'Orbitron',sans-serif!important;font-size:10px!important;color:#FFE81F!important;border-color:#FFE81F!important;font-weight:700;letter-spacing:1px}
.sw-btn:hover{color:#fff!important}
.planet-btn{min-width:100px}
.tg-btn{font-family:'Press Start 2P',monospace!important;font-size:8px!important;color:#8b9f5a!important;border-color:#8b9f5a!important}
.tg-btn:hover{color:#bbd07a!important}
</style>
</head>
<body>
<div id="gameContainer">
  <canvas id="gameCanvas"></canvas>
  <div id="scoreboard" class="hidden">
    <span class="score-p1"><span id="p1Label">P1</span>: <span id="score1">0</span></span>
    <span><span class="score-title" id="gameTitle">GORILLAS</span><br><span class="sub-label" id="subLabel"></span></span>
    <span class="score-p2"><span id="p2Label">P2</span>: <span id="score2">0</span></span>
  </div>
  <div id="input-panel" class="hidden">
    <span id="turnLabel" class="turn-indicator">P1</span>
    <label>Angle:</label><input type="number" id="angleInput" min="0" max="90" value="60">
    <label>Power:</label><input type="number" id="powerInput" min="1" max="200" value="70">
    <button id="fireBtn">THROW!</button>
  </div>
  <div id="message" class="hidden"></div>
  <button id="exitBtn" class="hidden" onclick="showArcadeMenu()">&#10005; EXIT</button>
</div>
<script>
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d'),W=800,H=500;
canvas.width=W;canvas.height=H;
function resizeCanvas(){const s=Math.min((window.innerWidth-10)/W,(window.innerHeight-10)/H,1.5);canvas.style.width=(W*s)+'px';canvas.style.height=(H*s)+'px';const gc=document.getElementById('gameContainer');gc.style.width=(W*s)+'px';gc.style.height=(H*s)+'px';}
resizeCanvas();window.addEventListener('resize',resizeCanvas);

let activeGame=null,buildings=[],scores=[0,0],currentPlayer=0,projectile=null;
let explosions=[],particles=[],envParticles=[],gamePhase='arcade',wind=0,terrainCanvas,terrainCtx;
const $=id=>document.getElementById(id);
function showEl(id){$(id).classList.remove('hidden')}
function hideEl(id){$(id).classList.add('hidden')}
function showMsg(h){$('message').innerHTML=h;showEl('message')}
function hideMsg(){hideEl('message')}

// ==================== GORILLAS ====================
const GorillasGame={
  g:[{x:0,y:0},{x:0,y:0}],sunSt:'normal',sunT:0,
  init(){activeGame='gorillas';hideMsg();showEl('exitBtn');canvas.style.cursor='default';
    $('scoreboard').className='gorillas-mode';
    $('p1Label').textContent='P1';$('p2Label').textContent='P2';
    $('gameTitle').textContent='G O R I L L A S';$('gameTitle').style.color='#ff0';
    $('subLabel').textContent='QBasic Classic';
    $('fireBtn').textContent='THROW!';$('fireBtn').className='';
    $('score1').textContent='0';$('score2').textContent='0';
    $('input-panel').style.borderColor='#44f';$('input-panel').style.background='rgba(0,0,80,0.85)';
    $('fireBtn').style.borderColor='#44f';$('fireBtn').style.color='#aaf';
    scores=[0,0];currentPlayer=0;this.newRound();},
  newRound(){this.genB();this.placeG();this.initT();wind=(Math.random()-0.5)*30;
    projectile=null;explosions=[];particles=[];envParticles=[];this.sunSt='normal';this.sunT=0;
    gamePhase='input';this.showIn();},
  genB(){buildings=[];let x=0;while(x<W+75){const bw=40+Math.random()*35,bh=80+Math.random()*220;
    buildings.push({x:Math.floor(x),w:Math.floor(bw),h:Math.floor(bh),color:['#aa0000','#00aa00','#0000aa','#aa5500','#555555','#00aaaa'][Math.floor(Math.random()*6)]});x+=bw;}},
  placeG(){const bi1=Math.floor(buildings.length*0.15)+Math.floor(Math.random()*2);
    const b1=buildings[Math.min(bi1,buildings.length-1)];this.g[0]={x:b1.x+b1.w/2,y:H-b1.h-30};
    const bi2=Math.floor(buildings.length*0.8)+Math.floor(Math.random()*2);
    const b2=buildings[Math.min(bi2,buildings.length-1)];this.g[1]={x:b2.x+b2.w/2,y:H-b2.h-30};},
  initT(){terrainCanvas=document.createElement('canvas');terrainCanvas.width=W;terrainCanvas.height=H;
    terrainCtx=terrainCanvas.getContext('2d');terrainCtx.clearRect(0,0,W,H);
    for(const b of buildings){terrainCtx.fillStyle=b.color;terrainCtx.fillRect(b.x,H-b.h,b.w,b.h);
      for(let wy=H-b.h+12;wy<H-10;wy+=13)for(let wx=b.x+6;wx<b.x+b.w-8;wx+=13){
        terrainCtx.fillStyle=Math.random()>0.35?'#ffff55':'#333333';terrainCtx.fillRect(wx,wy,5,5);}}},
  showIn(){showEl('input-panel');showEl('scoreboard');
    $('turnLabel').textContent='PLAYER '+(currentPlayer+1)+' \u25B8';
    $('turnLabel').style.color=currentPlayer===0?'#ff6':'#f66';
    $('angleInput').value='60';$('powerInput').value='70';$('angleInput').focus();},
  fire(angle,power){hideEl('input-panel');const g=this.g[currentPlayer],dir=currentPlayer===0?1:-1;
    const rad=(angle*Math.PI)/180,speed=power*0.6,sd=30;
    projectile={x:g.x+dir*sd,y:g.y-20,vx:Math.cos(rad)*speed*dir,vy:-Math.sin(rad)*speed,
      rot:0,alive:true,sx:g.x+dir*sd,sy:g.y-20};gamePhase='flight';},
  checkCol(x,y){if(x<-20||x>W+20||y>H)return'miss';if(y<0)return'none';
    for(let i=0;i<2;i++){const g=this.g[i];if(x>g.x-14&&x<g.x+14&&y>g.y-14&&y<g.y+24)return i===currentPlayer?'self':'hit';}
    const sdx=x-W/2,sdy=y-42;if(Math.sqrt(sdx*sdx+sdy*sdy)<22){this.sunSt='surprised';this.sunT=60;}
    if(y>=0&&y<H&&x>=0&&x<W&&terrainCtx.getImageData(Math.floor(x),Math.floor(y),1,1).data[3]>0)return'building';
    return'none';},
  updateP(dt){if(!projectile||!projectile.alive)return;
    projectile.vx+=wind*0.08*dt;projectile.vy+=14.7*dt;projectile.x+=projectile.vx*dt;projectile.y+=projectile.vy*dt;projectile.rot+=0.15;
    const dx=projectile.x-projectile.sx,dy=projectile.y-projectile.sy;if(Math.sqrt(dx*dx+dy*dy)<60)return;
    const c=this.checkCol(projectile.x,projectile.y);
    if(c==='hit'||c==='self')this.result(c);
    else if(c==='building'){createExplosion(projectile.x,projectile.y,22);destroyTerrain(projectile.x,projectile.y,22);
      this.sunSt='surprised';this.sunT=40;projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},800);}
    else if(c==='miss'){projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},400);}},
  result(type){if(type==='hit')scores[currentPlayer]++;else scores[1-currentPlayer]++;
    $('score1').textContent=scores[0];$('score2').textContent=scores[1];
    createExplosion(projectile.x,projectile.y,35);destroyTerrain(projectile.x,projectile.y,35);
    projectile.alive=false;gamePhase='hit';this.sunSt='surprised';
    setTimeout(()=>{const msg=type==='hit'
      ?'<span style="color:'+(currentPlayer===0?'#ff6':'#f66')+';font-family:Press Start 2P,monospace;font-size:14px">PLAYER '+(currentPlayer+1)+' WINS!</span>'
      :'<span style="color:#f00;font-family:Press Start 2P,monospace;font-size:12px">PLAYER '+(currentPlayer+1)+' HIT THEMSELVES!</span>';
      showMsg(msg+'<br><span style="font-family:VT323;font-size:20px;color:#aaa">Score: '+scores[0]+' - '+scores[1]+'</span><br>'+
        '<button onclick="GorillasGame.newRound()">NEXT ROUND</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');
      gamePhase='roundOver';},1000);},
  drawSky(){const gr=ctx.createLinearGradient(0,0,0,H);gr.addColorStop(0,'#000020');gr.addColorStop(0.5,'#000050');gr.addColorStop(1,'#000080');
    ctx.fillStyle=gr;ctx.fillRect(0,0,W,H);
    for(let i=0;i<60;i++){ctx.fillStyle='rgba(255,255,255,'+(0.3+(i*3571%70)/100)+')';ctx.fillRect((i*7919+42)%W,(i*6271+42)%(H*0.6),1+(i%2),1+(i%2));}},
  drawSun(){const sx=W/2,sy=42,sr=22;ctx.fillStyle='#ffff00';ctx.beginPath();ctx.arc(sx,sy,sr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#ffff00';ctx.lineWidth=2;
    for(let a=0;a<Math.PI*2;a+=Math.PI/6){ctx.beginPath();ctx.moveTo(sx+Math.cos(a)*(sr+3),sy+Math.sin(a)*(sr+3));ctx.lineTo(sx+Math.cos(a)*(sr+10),sy+Math.sin(a)*(sr+10));ctx.stroke();}
    ctx.fillStyle='#000';
    if(this.sunSt==='normal'){ctx.fillRect(sx-8,sy-5,4,4);ctx.fillRect(sx+4,sy-5,4,4);ctx.beginPath();ctx.arc(sx,sy+3,8,0.2,Math.PI-0.2);ctx.lineWidth=2;ctx.strokeStyle='#000';ctx.stroke();}
    else{ctx.fillRect(sx-8,sy-7,5,5);ctx.fillRect(sx+3,sy-7,5,5);ctx.beginPath();ctx.arc(sx,sy+5,5,0,Math.PI*2);ctx.fill();}
    if(this.sunT>0){this.sunT--;if(this.sunT<=0)this.sunSt='normal';}},
  drawG(g,idx){const cx=g.x,cy=g.y,s=2;ctx.fillStyle='#aa5500';
    ctx.fillRect(cx-6*s,cy-2*s,12*s,10*s);ctx.fillRect(cx-5*s,cy-7*s,10*s,6*s);
    ctx.fillRect(cx-5*s,cy+8*s,4*s,4*s);ctx.fillRect(cx+1*s,cy+8*s,4*s,4*s);
    const t=gamePhase==='flight'&&idx===currentPlayer;
    if(t){if(idx===0){ctx.fillRect(cx-8*s,cy-6*s,3*s,5*s);ctx.fillRect(cx+6*s,cy-10*s,3*s,5*s);}
    else{ctx.fillRect(cx-8*s,cy-10*s,3*s,5*s);ctx.fillRect(cx+6*s,cy-6*s,3*s,5*s);}}
    else{ctx.fillRect(cx-8*s,cy-2*s,3*s,8*s);ctx.fillRect(cx+6*s,cy-2*s,3*s,8*s);}
    ctx.fillStyle='#fff';ctx.fillRect(cx-3*s,cy-5*s,2*s,2*s);ctx.fillRect(cx+1*s,cy-5*s,2*s,2*s);
    ctx.fillStyle='#000';ctx.fillRect(cx-2*s,cy-5*s,1*s,1*s);ctx.fillRect(cx+2*s,cy-5*s,1*s,1*s);
    ctx.fillStyle='#cc8833';ctx.fillRect(cx-3*s,cy+1*s,6*s,4*s);},
  drawBan(b){ctx.save();ctx.translate(b.x,b.y);ctx.rotate(b.rot);ctx.fillStyle='#ffff00';
    ctx.beginPath();ctx.arc(0,0,5,0,Math.PI,false);ctx.lineTo(-5,0);ctx.lineTo(-3,-5);ctx.lineTo(3,-5);ctx.lineTo(5,0);ctx.fill();ctx.restore();},
  draw(){this.drawSky();this.drawSun();drawWind();ctx.drawImage(terrainCanvas,0,0);
    if(gamePhase==='hit'||gamePhase==='roundOver')this.drawG(this.g[currentPlayer],currentPlayer);
    else{this.drawG(this.g[0],0);this.drawG(this.g[1],1);}
    if(projectile&&projectile.alive)this.drawBan(projectile);drawExplosions();drawParticles();}
};

// ==================== STAR WARS ====================
const PLANETS={
  hoth:{n:'HOTH',sky:['#8899bb','#aabbdd','#ccddef'],bc:['#dde8f0','#c8d8e8','#b0c4d8','#99aabb'],wl:'#aaddff',wd:'#8899aa',st:false,su:false,mo:false,we:'snow',fo:'rgba(180,200,220,0.15)',bo:'#ff4444',bm:['#ff4444','#ff8800','#ffcc00','#ffffff']},
  tatooine:{n:'TATOOINE',sky:['#ff8833','#ffaa44','#ffcc66'],bc:['#cc9955','#bb8844','#ddaa66','#aa7733'],wl:'#ffdd88',wd:'#665533',st:false,su:true,mo:false,we:null,fo:'rgba(255,180,80,0.08)',bo:'#ff2200',bm:['#ff4400','#ff8800','#ffcc00','#ffee88']},
  andor:{n:'FERRIX',sky:['#222833','#2a3040','#384050'],bc:['#445566','#3a4a5a','#556677','#4a5a6a'],wl:'#ffaa44',wd:'#223344',st:true,su:false,mo:false,we:'rain',fo:'rgba(40,50,60,0.2)',bo:'#44ff44',bm:['#44ff44','#88ff44','#ffff44','#ffffff']},
  deathstar:{n:'DEATH STAR',sky:['#000000','#050510','#0a0a20'],bc:['#444450','#555560','#3a3a44','#4a4a55'],wl:'#44ff44',wd:'#222228',st:true,su:false,mo:false,sp:true,we:null,fo:null,bo:'#00ff00',bm:['#00ff44','#44ff88','#88ffaa','#ffffff']},
  endor:{n:'ENDOR',sky:['#112211','#1a331a','#224422'],bc:['#556633','#667744','#445522','#778855'],wl:'#ffcc33',wd:'#2a3320',st:false,su:false,mo:true,tr:true,we:'fireflies',fo:'rgba(20,40,10,0.15)',bo:'#ff4444',bm:['#ff4400','#ff8800','#ffcc00','#88ff44']}
};
const PK=Object.keys(PLANETS);

const SWGame={
  wk:[{x:0,y:0},{x:0,y:0}],t:PLANETS.hoth,trees:[],
  init(planet){activeGame='starwars';hideMsg();showEl('exitBtn');canvas.style.cursor='default';
    this.t=planet?PLANETS[planet]:PLANETS[PK[Math.floor(Math.random()*PK.length)]];
    $('scoreboard').className='sw-mode';
    $('p1Label').textContent='AT-AT';$('p2Label').textContent='AT-TE';
    $('gameTitle').textContent='IMPERIAL WALKERS';$('gameTitle').style.color='#FFE81F';
    $('subLabel').textContent=this.t.n;
    $('fireBtn').textContent='FIRE!';$('fireBtn').className='sw-btn';
    $('input-panel').style.borderColor='#555';$('input-panel').style.background='rgba(0,0,0,0.88)';
    $('fireBtn').style.borderColor='#FFE81F';$('fireBtn').style.color='#FFE81F';
    $('score1').textContent='0';$('score2').textContent='0';
    scores=[0,0];currentPlayer=0;this.setup();},
  newRound(){this.t=PLANETS[PK[Math.floor(Math.random()*PK.length)]];$('subLabel').textContent=this.t.n;this.setup();},
  sameRound(){this.setup();},
  setup(){this.genB();this.placeW();this.initT();this.genTr();
    wind=(Math.random()-0.5)*30;projectile=null;explosions=[];particles=[];envParticles=[];
    gamePhase='input';this.showIn();},
  genB(){buildings=[];let x=0;while(x<W+75){const bw=40+Math.random()*35,bh=80+Math.random()*220;
    buildings.push({x:Math.floor(x),w:Math.floor(bw),h:Math.floor(bh),color:this.t.bc[Math.floor(Math.random()*this.t.bc.length)]});x+=bw;}},
  placeW(){const bi1=Math.floor(buildings.length*0.12)+Math.floor(Math.random()*2);
    const b1=buildings[Math.min(bi1,buildings.length-1)];this.wk[0]={x:b1.x+b1.w/2,y:H-b1.h};
    const bi2=Math.floor(buildings.length*0.82)+Math.floor(Math.random()*2);
    const b2=buildings[Math.min(bi2,buildings.length-1)];this.wk[1]={x:b2.x+b2.w/2,y:H-b2.h};},
  initT(){terrainCanvas=document.createElement('canvas');terrainCanvas.width=W;terrainCanvas.height=H;
    terrainCtx=terrainCanvas.getContext('2d');terrainCtx.clearRect(0,0,W,H);
    for(const b of buildings){terrainCtx.fillStyle=b.color;terrainCtx.fillRect(b.x,H-b.h,b.w,b.h);
      for(let wy=H-b.h+12;wy<H-10;wy+=13)for(let wx=b.x+6;wx<b.x+b.w-8;wx+=13){
        terrainCtx.fillStyle=Math.random()>0.35?this.t.wl:this.t.wd;terrainCtx.fillRect(wx,wy,5,5);}}},
  genTr(){this.trees=[];if(!this.t.tr)return;for(let i=0;i<15;i++){const tx=Math.random()*W;let on=false;
    for(const b of buildings)if(tx>b.x&&tx<b.x+b.w){on=true;break;}
    if(!on)this.trees.push({x:tx,y:H,w:20+Math.random()*20,h:30+Math.random()*40});}},
  showIn(){showEl('input-panel');showEl('scoreboard');
    const lb=currentPlayer===0?'AT-AT':'AT-TE';
    $('turnLabel').textContent=lb+' \u25B8';$('turnLabel').style.color=currentPlayer===0?'#8cf':'#f88';
    $('angleInput').value='60';$('powerInput').value='70';$('angleInput').focus();},
  fire(angle,power){hideEl('input-panel');const w=this.wk[currentPlayer],dir=currentPlayer===0?1:-1;
    const rad=(angle*Math.PI)/180,speed=power*0.6,sd=currentPlayer===0?70:60;
    projectile={x:w.x+dir*sd,y:w.y-50,vx:Math.cos(rad)*speed*dir,vy:-Math.sin(rad)*speed,
      rot:0,alive:true,sx:w.x+dir*sd,sy:w.y-50};
    destroyTerrain(projectile.x,projectile.y,12);gamePhase='flight';},
  checkCol(x,y){if(x<-20||x>W+20||y>H)return'miss';if(y<0)return'none';
    for(let i=0;i<2;i++){const w=this.wk[i];let x1,x2,y1,y2;
      if(i===0){x1=w.x-22;x2=w.x+42;y1=w.y-35;y2=w.y+38;}
      else{x1=w.x-28;x2=w.x+35;y1=w.y-25;y2=w.y+28;}
      if(x>x1&&x<x2&&y>y1&&y<y2)return i===currentPlayer?'self':'hit';}
    if(y>=0&&y<H&&x>=0&&x<W&&terrainCtx.getImageData(Math.floor(x),Math.floor(y),1,1).data[3]>0)return'building';
    return'none';},
  updateP(dt){if(!projectile||!projectile.alive)return;
    projectile.vx+=wind*0.08*dt;projectile.vy+=14.7*dt;projectile.x+=projectile.vx*dt;projectile.y+=projectile.vy*dt;
    projectile.rot=Math.atan2(projectile.vy,projectile.vx);
    const dx=projectile.x-projectile.sx,dy=projectile.y-projectile.sy;if(Math.sqrt(dx*dx+dy*dy)<80)return;
    const c=this.checkCol(projectile.x,projectile.y);
    if(c==='hit'||c==='self')this.result(c);
    else if(c==='building'){createExplosion(projectile.x,projectile.y,24);destroyTerrain(projectile.x,projectile.y,24);
      projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},800);}
    else if(c==='miss'){projectile.alive=false;gamePhase='explode';
      setTimeout(()=>{currentPlayer=1-currentPlayer;gamePhase='input';this.showIn();},400);}},
  result(type){if(type==='hit')scores[currentPlayer]++;else scores[1-currentPlayer]++;
    $('score1').textContent=scores[0];$('score2').textContent=scores[1];
    createExplosion(projectile.x,projectile.y,40);destroyTerrain(projectile.x,projectile.y,40);
    projectile.alive=false;gamePhase='hit';
    setTimeout(()=>{const nm=currentPlayer===0?'AT-AT':'AT-TE';
      const msg=type==='hit'?'<span style="color:'+(currentPlayer===0?'#8cf':'#f88')+';font-family:Orbitron,sans-serif;font-size:14px;font-weight:700">'+nm+' WINS!</span>'
        :'<span style="color:#f44;font-family:Orbitron,sans-serif;font-size:12px;font-weight:700">'+nm+' HIT ITSELF!</span>';
      showMsg(msg+'<br><span style="font-family:VT323;font-size:20px;color:#aaa">Score: '+scores[0]+' - '+scores[1]+'</span><br>'+
        '<button class="sw-btn" onclick="SWGame.sameRound()">NEXT ROUND</button> <button class="sw-btn" onclick="SWGame.showPl()">CHANGE MAP</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');
      gamePhase='roundOver';},1000);},
  showPl(){hideMsg();hideEl('input-panel');showEl('exitBtn');scores=[0,0];currentPlayer=0;$('score1').textContent='0';$('score2').textContent='0';gamePhase='title';
    showMsg('<span style="font-family:Orbitron,sans-serif;font-size:18px;letter-spacing:3px;color:#FFE81F">CHOOSE PLANET</span><br>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'hoth\')">&#10052; HOTH</button>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'tatooine\')">&#9728; TATOOINE</button><br>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'andor\')">&#127783; FERRIX</button>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'deathstar\')">&#9673; DEATH STAR</button><br>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init(\'endor\')">&#127794; ENDOR</button>'+
      '<button class="sw-btn planet-btn" onclick="SWGame.init()">&#9889; RANDOM</button><br>'+
      '<button onclick="showArcadeMenu()">&#8617; ARCADE MENU</button>');},
  // Drawing
  drawSky(){const t=this.t,gr=ctx.createLinearGradient(0,0,0,H);
    gr.addColorStop(0,t.sky[0]);gr.addColorStop(0.5,t.sky[1]);gr.addColorStop(1,t.sky[2]);
    ctx.fillStyle=gr;ctx.fillRect(0,0,W,H);
    if(t.st)for(let i=0;i<120;i++){ctx.fillStyle='rgba(255,255,255,'+(0.2+(i*3571%80)/100)+')';ctx.fillRect((i*7919+42)%W,(i*6271+42)%(H*0.65),1+(i%3===0?1:0),1+(i%3===0?1:0));}
    if(t.su){ctx.shadowColor='#ffaa00';ctx.shadowBlur=40;ctx.fillStyle='#fff8cc';ctx.beginPath();ctx.arc(180,60,25,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ffeeaa';ctx.beginPath();ctx.arc(260,85,18,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
    if(t.mo){ctx.shadowColor='#aabbcc';ctx.shadowBlur=30;ctx.fillStyle='#8899aa';ctx.beginPath();ctx.arc(620,70,40,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='#778899';ctx.beginPath();ctx.arc(610,60,8,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(635,80,5,0,Math.PI*2);ctx.fill();}
    if(t.sp){ctx.fillStyle='#113322';ctx.beginPath();ctx.arc(650,120,55,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#1a4433';ctx.beginPath();ctx.arc(650,120,55,0.3,2.8);ctx.fill();
      ctx.strokeStyle='rgba(100,255,100,0.04)';ctx.lineWidth=1;for(let gy=0;gy<H;gy+=40){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(W,gy);ctx.stroke();}}
    if(t.fo){ctx.fillStyle=t.fo;ctx.fillRect(0,0,W,H);}},
  drawTr(){if(!this.t.tr)return;for(const tr of this.trees){ctx.fillStyle='#443322';ctx.fillRect(tr.x-3,tr.y,6,tr.h);
    ['#2a5522','#336633','#2a6622'].forEach((c,i)=>{ctx.fillStyle=c;ctx.beginPath();
      ctx.moveTo(tr.x-tr.w/2+i*4,tr.y-i*10);ctx.lineTo(tr.x+tr.w/2-i*4,tr.y-i*10);ctx.lineTo(tr.x,tr.y-tr.h-i*8);ctx.fill();});}},
  spawnEnv(){const t=this.t;
    if(t.we==='snow'&&Math.random()<0.3)envParticles.push({x:Math.random()*W,y:-5,vx:(Math.random()-0.5)+wind*0.02,vy:0.5+Math.random()*1.5,size:1+Math.random()*2,color:'rgba(255,255,255,'+(0.3+Math.random()*0.5)+')',life:1});
    else if(t.we==='rain'&&Math.random()<0.4)envParticles.push({x:Math.random()*W,y:-5,vx:wind*0.05,vy:6+Math.random()*4,size:1,color:'rgba(150,170,200,'+(0.2+Math.random()*0.3)+')',life:1,isRain:true});
    else if(t.we==='fireflies'&&Math.random()<0.02)envParticles.push({x:Math.random()*W,y:H*0.4+Math.random()*H*0.5,vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,size:2,color:'#ffff44',life:1,decay:0.003,isFF:true,phase:Math.random()*Math.PI*2});},
  drawATAT(cx,cy,s,f){ctx.save();ctx.translate(cx,cy);if(f<0)ctx.scale(-1,1);
    ctx.fillStyle='#8899aa';ctx.fillRect(-12*s,-16*s,24*s,12*s);
    ctx.fillStyle='#778899';ctx.fillRect(-10*s,-15*s,8*s,4*s);ctx.fillRect(0,-15*s,8*s,4*s);
    ctx.fillStyle='#99aabb';ctx.fillRect(-10*s,-10*s,20*s,2*s);ctx.fillStyle='#667788';ctx.fillRect(-10*s,-4*s,20*s,3*s);
    ctx.fillStyle='#7788a0';ctx.beginPath();ctx.moveTo(12*s,-14*s);ctx.lineTo(18*s,-18*s);ctx.lineTo(20*s,-16*s);ctx.lineTo(14*s,-12*s);ctx.fill();
    ctx.fillStyle='#8899aa';ctx.fillRect(16*s,-22*s,12*s,8*s);ctx.fillStyle='#667788';ctx.fillRect(17*s,-21*s,4*s,3*s);
    ctx.fillStyle='#556677';ctx.fillRect(22*s,-14*s,6*s,2*s);ctx.fillRect(22*s,-16*s,2*s,4*s);
    ctx.fillStyle='#ff3333';ctx.fillRect(24*s,-21*s,3*s,2*s);ctx.fillStyle='#778899';ctx.fillRect(-14*s,-15*s,4*s,10*s);
    ctx.fillStyle='#7788a0';ctx.fillRect(6*s,-2*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(5*s,9*s,5*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(6*s,11*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(3*s,22*s,8*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(3*s,-2*s,2*s,25*s);ctx.fillRect(1*s,22*s,6*s,3*s);
    ctx.fillStyle='#7788a0';ctx.fillRect(-8*s,-2*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(-9*s,9*s,5*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(-8*s,11*s,3*s,12*s);ctx.fillStyle='#556680';ctx.fillRect(-11*s,22*s,8*s,3*s);
    ctx.fillStyle='#667790';ctx.fillRect(-5*s,-2*s,2*s,25*s);ctx.fillRect(-7*s,22*s,6*s,3*s);ctx.restore();},
  drawATTE(cx,cy,s,f){ctx.save();ctx.translate(cx,cy);if(f<0)ctx.scale(-1,1);
    ctx.fillStyle='#889977';ctx.fillRect(-16*s,-8*s,32*s,10*s);
    ctx.fillStyle='#778866';ctx.fillRect(-14*s,-7*s,10*s,4*s);ctx.fillRect(2*s,-7*s,10*s,4*s);
    ctx.fillStyle='#99aa88';ctx.fillRect(-14*s,-3*s,28*s,2*s);
    ctx.fillStyle='#7a8a69';ctx.fillRect(-18*s,-6*s,4*s,7*s);ctx.fillRect(14*s,-6*s,4*s,7*s);
    ctx.fillStyle='#8a9a79';ctx.fillRect(-6*s,-12*s,12*s,5*s);ctx.fillStyle='#667755';ctx.fillRect(-2*s,-15*s,4*s,4*s);
    ctx.fillStyle='#556644';ctx.fillRect(2*s,-14*s,12*s,2*s);
    ctx.fillStyle='#778866';ctx.fillRect(14*s,-5*s,8*s,2*s);ctx.fillRect(14*s,-1*s,8*s,2*s);
    ctx.fillStyle='#aaccff';ctx.fillRect(15*s,-5*s,2*s,2*s);ctx.fillStyle='#667755';ctx.fillRect(-14*s,2*s,28*s,3*s);
    ctx.fillStyle='#778866';ctx.fillRect(10*s,4*s,2*s,7*s);ctx.fillStyle='#667755';ctx.fillRect(9*s,10*s,2*s,7*s);
    ctx.fillStyle='#556644';ctx.fillRect(7*s,16*s,6*s,2*s);
    ctx.fillStyle='#778866';ctx.fillRect(0,4*s,2*s,8*s);ctx.fillStyle='#667755';ctx.fillRect(-1*s,11*s,2*s,6*s);
    ctx.fillStyle='#556644';ctx.fillRect(-3*s,16*s,6*s,2*s);
    ctx.fillStyle='#778866';ctx.fillRect(-10*s,4*s,2*s,7*s);ctx.fillStyle='#667755';ctx.fillRect(-11*s,10*s,2*s,7*s);
    ctx.fillStyle='#556644';ctx.fillRect(-13*s,16*s,6*s,2*s);
    ctx.fillStyle='#667755';ctx.fillRect(12*s,4*s,1.5*s,13*s);ctx.fillRect(2*s,4*s,1.5*s,13*s);ctx.fillRect(-8*s,4*s,1.5*s,13*s);ctx.restore();},
  drawBolt(p){ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot||0);
    ctx.shadowColor=this.t.bo;ctx.shadowBlur=12;ctx.fillStyle='#ffffff';ctx.fillRect(-6,-2,12,4);
    ctx.fillStyle=this.t.bo;ctx.fillRect(-8,-3,16,6);ctx.shadowBlur=0;ctx.restore();},
  draw(){this.drawSky();this.drawTr();drawWind();ctx.drawImage(terrainCanvas,0,0);
    if(gamePhase==='hit'||gamePhase==='roundOver'){if(currentPlayer===0)this.drawATAT(this.wk[0].x,this.wk[0].y,1.5,1);else this.drawATTE(this.wk[1].x,this.wk[1].y,1.5,-1);}
    else{this.drawATAT(this.wk[0].x,this.wk[0].y,1.5,1);this.drawATTE(this.wk[1].x,this.wk[1].y,1.5,-1);}
    if(projectile&&projectile.alive)this.drawBolt(projectile);
    drawExplosions();drawParticles();this.spawnEnv();updateEnv();drawEnv();}
};

// ==================== TOP GUN ====================
const TG='#2a3518',TG_G='rgba(42,53,24,0.07)',TG_M='rgba(42,53,24,0.4)',TG_L='rgba(42,53,24,0.2)',TG_BG='#8b9f5a';
const TG_SLOTS=[];
(function(){for(let r=0;r<5;r++){const y=0.14+r*0.11,cols=r%2===0?4:3;
  for(let c=0;c<cols;c++){const x=r%2===0?0.22+c*0.187:0.30+c*0.20;TG_SLOTS.push({x,y});}}})();

const TopGunSFX={ctx:null,
  init(){if(this.ctx)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}},
  play(type){if(!this.ctx)return;const t=this.ctx.currentTime,osc=()=>this.ctx.createOscillator(),gn=()=>this.ctx.createGain();
    if(type==='shoot'){const o=osc(),g=gn();o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(900,t);o.frequency.exponentialRampToValueAtTime(200,t+0.08);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.08);o.start(t);o.stop(t+0.08);}
    else if(type==='hit'){const buf=this.ctx.createBuffer(1,this.ctx.sampleRate*0.25,this.ctx.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5);const src=this.ctx.createBufferSource(),g=gn();src.buffer=buf;src.connect(g);g.connect(this.ctx.destination);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.25);src.start(t);}
    else if(type==='damage'){const o=osc(),g=gn();o.type='sawtooth';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(60,t+0.35);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.35);o.start(t);o.stop(t+0.35);}
    else if(type==='gameover'){[220,190,160,120].forEach((f,i)=>{const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.2);g.gain.setValueAtTime(0.08,t+i*0.2);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.2+0.19);o.start(t+i*0.2);o.stop(t+i*0.2+0.2);});}
    else if(type==='countdown'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(440,t);g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);o.start(t);o.stop(t+0.12);}
    else if(type==='go'){const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(880,t);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);o.start(t);o.stop(t+0.2);}
    else if(type==='victory'){[523,659,784,1047,784,1047].forEach((f,i)=>{const o=osc(),g=gn();o.type='square';o.connect(g);g.connect(this.ctx.destination);o.frequency.setValueAtTime(f,t+i*0.15);g.gain.setValueAtTime(0.1,t+i*0.15);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.15+0.14);o.start(t+i*0.15);o.stop(t+i*0.15+0.15);});}}
};

const TopGunGame={
  en:[],ex:[],bul:[],par:[],crossX:0.5,crossY:0.4,
  sc:0,liv:3,wav:1,st:'idle',
  spT:0,killed:0,waveTarget:5,eSpd:0.3,spInt:2200,maxOn:4,
  pAngle:0,gScroll:0,cdPhase:0,cdTimer:0,vicTimer:0,tgKeys:{},hitFlash:0,
  MAX_W:9,CD_DUR:[1200,900,700,700,700,500],CD_TXT:['','READY','3','2','1','GO!'],

  init(){activeGame='topgun';hideMsg();showEl('exitBtn');hideEl('input-panel');
    canvas.style.cursor='crosshair';
    $('scoreboard').className='topgun-mode';showEl('scoreboard');
    $('p1Label').textContent='SCR';$('p2Label').textContent='LIVES';
    $('gameTitle').textContent='T O P  G U N';$('gameTitle').style.color=TG;
    $('subLabel').textContent='Naval Fighter Combat';
    this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.bul=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.gScroll=0;this.hitFlash=0;
    TopGunSFX.init();this.updHUD();this.startCD();gamePhase='topgun';},

  updHUD(){$('score1').textContent=String(this.sc).padStart(5,'0');
    $('subLabel').textContent='WAVE '+this.wav+'/'+this.MAX_W;
    let lv='';for(let i=0;i<this.liv;i++)lv+='\u2708';$('score2').textContent=lv;},

  getWC(w){return{target:5+w*2,speed:0.3+w*0.06,spInt:Math.max(1200-w*100,350),maxOn:Math.min(3+w,12)};},

  startCD(){this.st='countdown';this.cdPhase=0;this.cdTimer=0;
    this.en=[];this.ex=[];this.bul=[];this.par=[];
    const c=this.getWC(this.wav);this.waveTarget=c.target;this.eSpd=c.speed;this.spInt=c.spInt;this.maxOn=c.maxOn;
    this.killed=0;this.spT=0;},

  spawnE(){const free=TG_SLOTS.filter(s=>!this.en.some(e=>e.alive&&Math.abs(e.x-s.x)<0.08&&Math.abs(e.y-s.y)<0.08));
    if(!free.length)return;const s=free[Math.floor(Math.random()*free.length)];
    this.en.push({x:s.x,y:s.y,bx:s.x,by:s.y,dir:Math.random()>0.5?1:-1,
      range:0.02+Math.random()*0.02,spd:this.eSpd*(0.7+Math.random()*0.6),
      alive:true,t:0,life:8000+Math.random()*5000+this.wav*1000,
      shootCD:Math.max(400,1200-this.wav*80)+Math.random()*1000,flash:0});},

  shoot(){if(this.st!=='playing')return;TopGunSFX.play('shoot');
    let hit=false,closest=null,closestD=Infinity;
    for(const e of this.en){if(!e.alive)continue;
      const dx=this.crossX-e.x,dy=this.crossY-e.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<0.12&&d<closestD){closest=e;closestD=d;}}
    if(closest){closest.alive=false;hit=true;this.sc+=100*this.wav;this.killed++;TopGunSFX.play('hit');
      this.ex.push({x:closest.x,y:closest.y,progress:0});
      for(let i=0;i<6;i++)this.par.push({x:closest.x,y:closest.y,
        vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,
        r:0.002+Math.random()*0.003,alpha:0.8,life:0.5+Math.random()*0.3});
      this.hitFlash=6;}
    if(!hit)this.bul.push({x:this.crossX,y:0.82,enemy:false});
    this.updHUD();},

  takeDmg(){this.liv--;TopGunSFX.play('damage');this.hitFlash=12;this.updHUD();
    if(this.liv<=0){this.st='gameover';TopGunSFX.play('gameover');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#ff4444">GAME OVER</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:20px;color:#aaa">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="tg-btn" onclick="TopGunGame.restart()">PLAY AGAIN</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');}},

  restart(){hideMsg();this.sc=0;this.liv=3;this.wav=1;
    this.en=[];this.ex=[];this.bul=[];this.par=[];
    this.crossX=0.5;this.crossY=0.4;this.pAngle=0;this.hitFlash=0;
    TopGunSFX.init();this.updHUD();this.startCD();},

  nextWave(){if(this.wav>=this.MAX_W){this.st='victory';this.vicTimer=0;TopGunSFX.play('victory');
      showMsg('<span style="font-family:Press Start 2P,monospace;font-size:18px;color:#ff0">WINNER!</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:16px;color:#aaa">TOP GUN ACE PILOT</span><br>'+
        '<span style="font-family:VT323,monospace;font-size:20px;color:#fff">Score: '+String(this.sc).padStart(5,'0')+'</span><br>'+
        '<button class="tg-btn" onclick="TopGunGame.restart()">PLAY AGAIN</button> <button onclick="showArcadeMenu()">ARCADE MENU</button>');return;}
    this.wav++;this.updHUD();this.startCD();},

  updateCD(dt){this.cdTimer+=dt*1000;
    if(this.cdTimer>=this.CD_DUR[this.cdPhase]){this.cdTimer=0;this.cdPhase++;
      if(this.cdPhase>=2&&this.cdPhase<=4)TopGunSFX.play('countdown');
      if(this.cdPhase===5)TopGunSFX.play('go');
      if(this.cdPhase>=this.CD_DUR.length){this.st='playing';}}},

  update(dt){
    if(this.hitFlash>0)this.hitFlash--;
    if(this.st==='countdown'){this.updateCD(dt);return;}
    if(this.st!=='playing')return;
    const cs=0.5;
    if(this.tgKeys['ArrowLeft']||this.tgKeys['a'])this.crossX-=cs*dt;
    if(this.tgKeys['ArrowRight']||this.tgKeys['d'])this.crossX+=cs*dt;
    if(this.tgKeys['ArrowUp']||this.tgKeys['w'])this.crossY-=cs*dt;
    if(this.tgKeys['ArrowDown']||this.tgKeys['s'])this.crossY+=cs*dt;
    this.crossX=Math.max(0,Math.min(1,this.crossX));
    this.crossY=Math.max(0,Math.min(0.8,this.crossY));
    // Spawn
    this.spT+=dt*1000;
    if(this.spT>=this.spInt&&this.en.filter(e=>e.alive).length<this.maxOn){this.spawnE();this.spT=0;}
    // Enemies
    this.en.forEach(e=>{if(!e.alive)return;e.t+=dt*1000;
      e.x=e.bx+Math.sin(e.t*0.0015*e.spd)*e.range*e.dir;
      e.y=e.by+Math.sin(e.t*0.001*e.spd)*0.015;
      e.x=Math.max(0.05,Math.min(0.95,e.x));e.y=Math.max(0.05,Math.min(0.7,e.y));
      e.shootCD-=dt*1000;
      if(e.shootCD<=0){e.flash=150;
        e.shootCD=Math.max(800,1800-this.wav*120)+Math.random()*1200;
        const dx=0.5-e.x+(Math.random()-0.5)*0.15,dy=0.85-e.y;
        const dist=Math.sqrt(dx*dx+dy*dy),bs=0.45+this.wav*0.03;
        this.bul.push({x:e.x,y:e.y+0.03,vx:(dx/dist)*bs,vy:(dy/dist)*bs,enemy:true});}
      if(e.flash>0)e.flash-=dt*1000;
      if(e.t>e.life)e.alive=false;});
    this.en=this.en.filter(e=>e.alive);
    // Bullets
    this.bul=this.bul.filter(b=>{
      if(b.enemy){b.x+=(b.vx||0)*dt;b.y+=(b.vy||0)*dt;
        if(Math.abs(b.x-0.5)<0.04&&Math.abs(b.y-0.85)<0.035){this.takeDmg();return false;}
        return b.y<1.05&&b.y>-0.05&&b.x>-0.05&&b.x<1.05;}
      else{b.y-=1.8*dt;return b.y>-0.05;}});
    // Effects
    this.ex.forEach(e=>e.progress+=dt*2.5);this.ex=this.ex.filter(e=>e.progress<1);
    this.par.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.alpha-=dt*2;p.life-=dt;});
    this.par=this.par.filter(p=>p.life>0&&p.alpha>0);
    // Wave check
    if(this.killed>=this.waveTarget)this.nextWave();
    // Player angle
    const dx=this.crossX-0.5,dy=this.crossY-0.85;
    const ta=Math.max(-0.7,Math.min(0.7,Math.atan2(dx,-dy)*0.5));
    this.pAngle+=(ta-this.pAngle)*Math.min(1,dt*8);},

  // ---- Drawing ----
  drawJet(cx,cy,size,color,flipped,angle){
    const x=cx*W,y=cy*H,s=size*Math.min(W,H);
    ctx.fillStyle=color;ctx.save();ctx.translate(x,y);if(angle)ctx.rotate(angle);
    ctx.beginPath();ctx.moveTo(0,-s*0.5);ctx.lineTo(s*0.08,s*0.3);ctx.lineTo(-s*0.08,s*0.3);ctx.closePath();ctx.fill();
    ctx.beginPath();
    if(flipped){ctx.moveTo(-s*0.45,s*0.05);ctx.lineTo(0,-s*0.15);ctx.lineTo(s*0.45,s*0.05);ctx.lineTo(s*0.35,s*0.15);ctx.lineTo(-s*0.35,s*0.15);}
    else{ctx.moveTo(-s*0.45,s*0.1);ctx.lineTo(0,-s*0.1);ctx.lineTo(s*0.45,s*0.1);ctx.lineTo(s*0.35,s*0.2);ctx.lineTo(-s*0.35,s*0.2);}
    ctx.closePath();ctx.fill();
    ctx.beginPath();
    if(flipped){ctx.moveTo(-s*0.2,-s*0.45);ctx.lineTo(0,-s*0.25);ctx.lineTo(s*0.2,-s*0.45);}
    else{ctx.moveTo(-s*0.18,s*0.4);ctx.lineTo(0,s*0.2);ctx.lineTo(s*0.18,s*0.4);}
    ctx.closePath();ctx.fill();ctx.restore();},

  drawGhosts(){TG_SLOTS.forEach(s=>this.drawJet(s.x,s.y,0.045,TG_G,true));},

  drawGround(dt){this.gScroll+=dt*0.5;const gy=H*0.88;
    ctx.strokeStyle=TG_M;ctx.lineWidth=1;
    for(let i=0;i<4;i++){const y=gy+i*(H*0.025);ctx.beginPath();
      for(let x=-20;x<W+20;x+=4){const w=Math.sin((x+this.gScroll*80+i*40)*0.025)*3;
        if(x===-20)ctx.moveTo(x,y+w);else ctx.lineTo(x,y+w);}ctx.stroke();}
    ctx.fillStyle=TG_G;const cx2=W*0.5,cy2=gy+H*0.06;
    ctx.fillRect(cx2-W*0.08,cy2,W*0.16,H*0.01);
    ctx.fillRect(cx2-W*0.05,cy2-H*0.008,W*0.008,H*0.008);
    ctx.fillRect(cx2+W*0.02,cy2-H*0.014,W*0.005,H*0.014);},

  drawCross(){const x=this.crossX*W,y=this.crossY*H,r=18*(Math.min(W,H)/600),ext=8*(Math.min(W,H)/600);
    ctx.strokeStyle=TG;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x-r-ext,y);ctx.lineTo(x-r+4,y);ctx.moveTo(x+r-4,y);ctx.lineTo(x+r+ext,y);
    ctx.moveTo(x,y-r-ext);ctx.lineTo(x,y-r+4);ctx.moveTo(x,y+r-4);ctx.lineTo(x,y+r+ext);ctx.stroke();
    ctx.fillStyle=TG;ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fill();},

  drawExpl(ex){const x=ex.x*W,y=ex.y*H,p=ex.progress,r=(15+p*40)*(Math.min(W,H)/600);
    ctx.strokeStyle=p<0.6?TG:TG_M;ctx.lineWidth=2;
    for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+p*3;ctx.beginPath();
      ctx.moveTo(x+Math.cos(a)*r*0.2,y+Math.sin(a)*r*0.2);
      ctx.lineTo(x+Math.cos(a)*r*(0.5+p*0.5),y+Math.sin(a)*r*(0.5+p*0.5));ctx.stroke();}
    if(p<0.4){ctx.fillStyle=TG;ctx.beginPath();ctx.arc(x,y,r*0.25*(1-p*2),0,Math.PI*2);ctx.fill();}
    ctx.strokeStyle=TG_M;ctx.lineWidth=1;ctx.beginPath();ctx.arc(x,y,r*p,0,Math.PI*2);ctx.stroke();},

  drawCD(){const cx=W/2,cy=H/2;ctx.fillStyle=TG;
    ctx.font=Math.min(W,H)*0.04+'px "Press Start 2P"';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('WAVE '+this.wav+' OF '+this.MAX_W,cx,cy-Math.min(W,H)*0.08);
    const txt=this.CD_TXT[this.cdPhase];
    if(txt){const isNum=['3','2','1'].includes(txt),isGo=txt==='GO!';
      const fs=isNum?0.12:(isGo?0.08:0.04);
      const phase=this.cdTimer/this.CD_DUR[this.cdPhase];
      const sc=isNum?1+Math.sin(phase*Math.PI)*0.15:1;
      const al=isGo?Math.max(0,1-phase*2):1;
      ctx.save();ctx.translate(cx,cy+Math.min(W,H)*0.02);ctx.scale(sc,sc);ctx.globalAlpha=al;
      ctx.fillStyle=TG;ctx.font=Math.min(W,H)*fs+'px "Press Start 2P"';ctx.fillText(txt,0,0);
      ctx.restore();ctx.globalAlpha=1;}},

  draw(dt){
    // LCD green background
    ctx.fillStyle=TG_BG;ctx.fillRect(0,0,W,H);
    // Scanlines
    ctx.fillStyle='rgba(0,0,0,0.02)';for(let y=0;y<H;y+=3)ctx.fillRect(0,y,W,1);
    // Hit flash overlay
    if(this.hitFlash>0){ctx.fillStyle='rgba(42,53,24,0.15)';ctx.fillRect(0,0,W,H);}

    this.drawGhosts();this.drawGround(dt);

    if(this.st==='countdown'){this.drawJet(0.5,0.85,0.055,TG,false,0);this.drawCD();return;}
    if(this.st==='gameover'||this.st==='victory'){this.drawJet(0.5,0.85,0.055,TG,false,0);return;}

    // Enemy bullets
    this.bul.filter(b=>b.enemy).forEach(b=>{ctx.fillStyle=TG;ctx.fillRect(b.x*W-1.5,b.y*H-4,3,8);});
    // Player bullets
    this.bul.filter(b=>!b.enemy).forEach(b=>{ctx.fillStyle=TG;ctx.fillRect(b.x*W-1.5,b.y*H-5,3,10);
      ctx.fillStyle=TG_M;ctx.fillRect(b.x*W-1,b.y*H+5,2,6);});
    // Enemies
    this.en.forEach(e=>{if(!e.alive)return;
      this.drawJet(e.x,e.y,0.045,e.flash>80?TG_M:TG,true);
      if(e.flash>80){ctx.fillStyle=TG;ctx.beginPath();ctx.arc(e.x*W,(e.y+0.035)*H,4,0,Math.PI*2);ctx.fill();}});
    // Explosions & particles
    this.ex.forEach(e=>this.drawExpl(e));
    this.par.forEach(p=>{ctx.fillStyle='rgba(42,53,24,'+p.alpha+')';
      ctx.beginPath();ctx.arc(p.x*W,p.y*H,p.r*Math.min(W,H),0,Math.PI*2);ctx.fill();});
    // Player jet
    this.drawJet(0.5,0.85,0.055,TG,false,this.pAngle);
    if(this.st==='playing')this.drawCross();}
};

// ==================== SHARED ====================
function createExplosion(x,y,r){explosions.push({x,y,radius:r,age:0,maxAge:35});
  const c=activeGame==='starwars'?SWGame.t.bm:['#ff0','#f80','#f00','#fff','#aaa'];
  for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*5;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,size:2+Math.random()*3,
      color:c[Math.floor(Math.random()*c.length)],life:1,decay:0.015+Math.random()*0.02});}}
function destroyTerrain(x,y,r){terrainCtx.globalCompositeOperation='destination-out';
  terrainCtx.beginPath();terrainCtx.arc(x,y,r,0,Math.PI*2);terrainCtx.fill();terrainCtx.globalCompositeOperation='source-over';}
function drawExplosions(){for(const e of explosions){const a=1-e.age/e.maxAge,r=e.radius*(0.5+e.age/e.maxAge);
  ctx.fillStyle='rgba(255,'+Math.floor(180*a)+',0,'+a+')';ctx.shadowBlur=20;ctx.shadowColor='#ff8800';
  ctx.beginPath();ctx.arc(e.x,e.y,r,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,200,'+(a*0.5)+')';ctx.beginPath();ctx.arc(e.x,e.y,r*0.4,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}}
function drawParticles(){for(const p of particles){ctx.globalAlpha=p.life;ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.size,p.size);}ctx.globalAlpha=1;}
function updateEnv(){for(let i=envParticles.length-1;i>=0;i--){const p=envParticles[i];p.x+=p.vx;p.y+=p.vy;
  if(p.isFF){p.phase+=0.05;p.vx+=(Math.random()-0.5)*0.1;p.vy+=(Math.random()-0.5)*0.1;p.life-=(p.decay||0.003);}
  if(p.y>H||p.x<-10||p.x>W+10||p.life<=0)envParticles.splice(i,1);}if(envParticles.length>300)envParticles.splice(0,50);}
function drawEnv(){for(const p of envParticles){if(p.isRain){ctx.strokeStyle=p.color;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(p.x+p.vx*2,p.y+p.vy*2);ctx.stroke();}
  else if(p.isFF){ctx.fillStyle='rgba(255,255,68,'+((0.3+0.7*Math.abs(Math.sin(p.phase)))*p.life)+')';ctx.shadowColor='#ffff44';ctx.shadowBlur=6;ctx.fillRect(p.x,p.y,p.size,p.size);ctx.shadowBlur=0;}
  else{ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.size,p.size);}}}
function drawWind(){const c=activeGame==='starwars'?(SWGame.t.sp?'#44ff4488':'#ffffffaa'):'#aaaaff';
  ctx.fillStyle=c;ctx.font='13px VT323';ctx.textAlign='center';const dir=wind>0?'\u25BA':wind<0?'\u25C4':'\u2022';
  ctx.fillText('Wind: '+dir.repeat(Math.min(Math.ceil(Math.abs(wind)/5),5))+' '+Math.abs(wind).toFixed(1),W/2,H-10);}

// ==================== ARCADE MENU ====================
let menuStars=[];for(let i=0;i<200;i++)menuStars.push({x:Math.random()*W,y:Math.random()*H,s:0.3+Math.random()*0.7,sp:0.1+Math.random()*0.4});
let menuT=0;
function drawArcadeBG(){ctx.fillStyle='#0a0a18';ctx.fillRect(0,0,W,H);menuT+=0.016;
  for(const s of menuStars){s.y+=s.sp;if(s.y>H){s.y=0;s.x=Math.random()*W;}
    ctx.fillStyle='rgba(255,255,255,'+(s.s*(0.5+0.5*Math.sin(menuT*2+s.x)))+')';ctx.fillRect(s.x,s.y,s.s>0.6?2:1,s.s>0.6?2:1);}
  ctx.fillStyle='rgba(0,0,0,0.06)';for(let y=0;y<H;y+=3)ctx.fillRect(0,y,W,1);
  const gr=ctx.createLinearGradient(0,H-60,0,H);gr.addColorStop(0,'rgba(0,0,0,0)');gr.addColorStop(1,'rgba(40,20,80,0.3)');ctx.fillStyle=gr;ctx.fillRect(0,H-60,W,60);}

function showArcadeMenu(){activeGame=null;gamePhase='arcade';projectile=null;explosions=[];particles=[];envParticles=[];
  canvas.style.cursor='default';
  hideEl('input-panel');hideEl('scoreboard');hideEl('exitBtn');hideMsg();
  showMsg('<span class="arcade-title">RETRO ARCADE</span><br>'+
    '<span class="arcade-sub">\u2014 SELECT GAME \u2014</span><br>'+
    '<div class="game-grid">'+
      '<div class="game-card" onclick="launchGorillas()"><span class="card-icon">\uD83C\uDF4C</span><span class="card-title">GORILLAS</span><span class="card-desc">QBasic Classic<br>Throw bananas!</span></div>'+
      '<div class="game-card" onclick="SWGame.showPl()"><span class="card-icon">\u2694</span><span class="card-title">IMPERIAL<br>WALKERS</span><span class="card-desc">Star Wars Artillery<br>AT-AT vs AT-TE</span></div>'+
      '<div class="game-card" onclick="launchTopGun()"><span class="card-icon">\u2708</span><span class="card-title">TOP GUN</span><span class="card-desc">Naval Fighter Combat<br>Shoot jets!</span></div>'+
      '<div class="game-card coming-soon"><span class="card-icon">?</span><span class="card-title">COMING<br>SOON</span><span class="card-desc">More games<br>on the way!</span></div>'+
    '</div>');}

window.launchGorillas=function(){hideMsg();GorillasGame.init();};
window.launchTopGun=function(){hideMsg();TopGunGame.init();};
window.showArcadeMenu=showArcadeMenu;
window.GorillasGame=GorillasGame;
window.SWGame=SWGame;
window.TopGunGame=TopGunGame;

// ==================== MAIN LOOP ====================
let lastTime=0;
function gameLoop(ts){const dt=Math.min((ts-lastTime)/1000,0.05);lastTime=ts;
  if(activeGame==='topgun'){
    TopGunGame.update(dt);TopGunGame.draw(dt);
  } else {
    if(gamePhase==='flight'){if(activeGame==='gorillas')GorillasGame.updateP(dt);else if(activeGame==='starwars')SWGame.updateP(dt);}
    for(let i=explosions.length-1;i>=0;i--){explosions[i].age++;if(explosions[i].age>=explosions[i].maxAge)explosions.splice(i,1);}
    for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=p.decay;if(p.life<=0)particles.splice(i,1);}
    if(gamePhase==='arcade')drawArcadeBG();else if(activeGame==='gorillas')GorillasGame.draw();else if(activeGame==='starwars')SWGame.draw();
  }
  requestAnimationFrame(gameLoop);}

// ==================== INPUT ====================
$('fireBtn').addEventListener('click',()=>{if(gamePhase!=='input')return;
  const a=Math.max(0,Math.min(90,parseFloat($('angleInput').value)||45));
  const p=Math.max(1,Math.min(200,parseFloat($('powerInput').value)||50));
  if(activeGame==='gorillas')GorillasGame.fire(a,p);else if(activeGame==='starwars')SWGame.fire(a,p);});

document.addEventListener('keydown',e=>{
  if(activeGame==='topgun'){
    TopGunGame.tgKeys[e.key]=true;
    if(e.key===' '){e.preventDefault();TopGunGame.shoot();}
    return;}
  if(e.key==='Enter'&&gamePhase==='input')$('fireBtn').click();});
document.addEventListener('keyup',e=>{if(activeGame==='topgun')TopGunGame.tgKeys[e.key]=false;});

canvas.addEventListener('mousemove',e=>{
  if(activeGame!=='topgun'||TopGunGame.st!=='playing')return;
  const rect=canvas.getBoundingClientRect();
  TopGunGame.crossX=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
  TopGunGame.crossY=Math.max(0,Math.min(0.8,(e.clientY-rect.top)/rect.height));});

canvas.addEventListener('click',e=>{
  if(activeGame==='topgun'&&TopGunGame.st==='playing'){
    const rect=canvas.getBoundingClientRect();
    TopGunGame.crossX=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
    TopGunGame.crossY=Math.max(0,Math.min(0.8,(e.clientY-rect.top)/rect.height));
    TopGunGame.shoot();}});

showArcadeMenu();requestAnimationFrame(gameLoop);
</script>
</body>
</html>
